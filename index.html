<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£—á–µ—Ç –®–∏–Ω–æ–º–æ–Ω—Ç–∞–∂–∞</title>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/CLyKKjZP/LOGO.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #0D1117; --bg-light: #161B22; --bg-card-dark: #161B22; --bg-card-light: #FFFFFF; --bg-input-dark: #21262D; --bg-input-light: #F3F4F6;
            --primary: #58A6FF; --primary-hover: #7DD3FC; --primary-light: rgba(88, 166, 255, 0.1);
            --text-dark: #E6EDF3; --text-light: #111827; --text-muted-dark: #8B949E; --text-muted-light: #6B7280;
            --danger: #F85149; --success: #34D399; --warning: #FBBF24; --info: #60A5FA; --border-color-dark: #30363D; --border-color-light: #E5E7EB;
            --border-radius: 12px; --transition-speed: 0.3s; --transition-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 10000; display: flex; align-items: center; justify-content: center; opacity: 1; transition: opacity 0.5s ease, visibility 0.5s ease; }
        .preloader-dots { display: flex; gap: 10px; }
        .preloader-dots div { width: 15px; height: 15px; background-color: var(--primary); border-radius: 50%; animation: preloader-bounce 1.4s infinite ease-in-out both; }
        .preloader-dots .dot1 { animation-delay: -0.32s; }
        .preloader-dots .dot2 { animation-delay: -0.16s; }
        @keyframes preloader-bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark); color: var(--text-dark); min-height: 100vh;
            padding: 15px; font-size: 16px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
            background-image: radial-gradient(circle at 1px 1px, var(--border-color-dark) 1px, transparent 0);
            background-size: 25px 25px;
            -webkit-tap-highlight-color: transparent;
        }
        body:not(.animations-disabled) button,
        body:not(.animations-disabled) .button,
        body:not(.animations-disabled) .top-controls button,
        body:not(.animations-disabled) .tab,
        body:not(.animations-disabled) .result-card,
        body:not(.animations-disabled) input,
        body:not(.animations-disabled) select,
        body:not(.animations-disabled) textarea,
        body:not(.animations-disabled) .slider,
        body:not(.animations-disabled) .slider:before,
        body:not(.animations-disabled) .btn-action,
        body:not(.animations-disabled) #miniCalcContainer,
        body:not(.animations-disabled) .checkbox-label,
        body:not(.animations-disabled) tbody tr {
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease, border-color var(--transition-speed) ease, transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease, opacity var(--transition-speed) ease;
        }

        body.light-theme {
            --bg-dark: #F9FAFB; --bg-light: #FFFFFF; --bg-card-dark: #FFFFFF; --bg-input-dark: #F3F4F6; --text-dark: #111827;
            --text-muted-dark: #6B7280; --border-color-dark: #E5E7EB;
            background-image: radial-gradient(circle at 1px 1px, #e5e7eb 1px, transparent 0);
        }
        body.font-size-small { font-size: 14px; } body.font-size-large { font-size: 18px; }
        .container { max-width: 1800px; margin: 0 auto; animation: fadeIn 0.8s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes icon-pop { 0% { transform: scale(1); } 50% { transform: scale(1.3) rotate(10deg); } 100% { transform: scale(1); } }
        @keyframes subtle-shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-2px); } 75% { transform: translateX(2px); } }
        @keyframes glow { 0% { text-shadow: 0 0 10px rgba(88, 166, 255, 0.5), 0 0 20px rgba(88, 166, 255, 0.3); } 50% { text-shadow: 0 0 20px rgba(88, 166, 255, 0.8), 0 0 40px rgba(88, 166, 255, 0.5); } 100% { text-shadow: 0 0 10px rgba(88, 166, 255, 0.5), 0 0 20px rgba(88, 166, 255, 0.3); } }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        h1 { font-size: clamp(1.8rem, 5vw, 2.5rem); color: var(--primary); animation: fadeIn 1s ease-out, glow 4s ease-in-out infinite; }
        .top-controls { display: flex; align-items: center; gap: 10px; }
        .top-controls button { background: var(--bg-light); color: var(--text-dark); border: 1px solid var(--border-color-dark); width: 45px; height: 45px; font-size: 1.5em; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; position: relative; overflow: hidden; }
        .top-controls button:hover:not(:disabled) { background: var(--primary); color: var(--bg-dark); transform: translateY(-3px) scale(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .top-controls button:disabled { opacity: 0.4; cursor: not-allowed; transform: none; background: var(--bg-light); color: var(--text-dark); }
        .top-controls .icon { width: 24px; height: 24px; }
        .top-controls button:hover:not(:disabled) .icon { animation: icon-pop 0.5s ease; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; flex-wrap: wrap; border-bottom: 1px solid var(--border-color-dark); padding-bottom: 10px; }
        .tab { padding: 10px 20px; background: transparent; border: none; border-bottom: 3px solid transparent; color: var(--text-muted-dark); cursor: pointer; font-size: 1em; font-weight: 600; border-radius: 0; display: flex; align-items: center; gap: 8px; }
        .tab:hover { color: var(--primary); }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab .icon { width: 22px; height: 22px; stroke-width: 2; }
        .tab:hover .icon { transform: scale(1.2) rotate(5deg); }
        .tab-content { display: none; } .tab-content.active { display: block; animation: slideIn 0.5s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: scale(0.98) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .controls { background: transparent; padding: 15px 0; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .controls .icon { width: 20px; height: 20px; stroke-width: 2; }
        button, .button { padding: 10px 20px; background: var(--primary); color: var(--bg-dark); border: none; cursor: pointer; font-size: 1em; font-weight: 600; border-radius: var(--border-radius); display: inline-flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; position: relative; overflow: hidden; z-index: 1; }
        button::before, .button::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background-color: rgba(255,255,255,0.3); border-radius: 50%; transform: translate(-50%, -50%); opacity: 0; transition: width 0.4s ease, height 0.4s ease, opacity 0.4s ease; z-index: -1; }
        button:active::before, .button:active::before { width: 200%; height: 200%; opacity: 1; transition: 0s; }
        button:hover, .button:hover { filter: brightness(1.2); transform: scale(1.05) translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.25); }
        button:active, .button:active { transform: scale(0.97) translateY(1px); filter: brightness(0.9); box-shadow: 0 1px 5px rgba(0,0,0,0.2) inset; }
        button.danger { background: var(--danger); } button.success { background: var(--success); } button.warning { background: var(--warning); } button.info { background: var(--info); }
        input[type="date"], input[type="search"], input[type="text"], input[type="number"], input[type="color"], input[type="tel"], input[type="time"], select, textarea { padding: 10px; background: var(--bg-input-dark); color: var(--text-dark); border: 1px solid var(--border-color-dark); font-size: 1em; border-radius: var(--border-radius); width: 100%; font-family: inherit; }
        textarea { resize: vertical; min-height: 80px; }
        input:focus, select:focus, textarea:focus { outline: none; box-shadow: 0 0 0 3px var(--primary-light), 0 0 15px var(--primary-light); border-color: var(--primary); }
        .controls input { width: auto; flex-grow: 1; }
        .table-wrapper { overflow-x: auto; background: var(--bg-light); border-radius: var(--border-radius); border: 1px solid var(--border-color-dark); padding: 5px; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        tbody tr.row-enter { animation: rowSlideIn 0.4s var(--transition-bounce) forwards, newRowHighlight 1.5s ease-out .2s; }
        tbody tr.row-exit { animation: rowSlideOut 0.4s ease-in forwards; }
        @keyframes rowSlideIn { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes rowSlideOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        @keyframes newRowHighlight { from { background-color: var(--primary-light); } to { background-color: transparent; } }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color-dark); vertical-align: middle; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        th[data-sort-key] { cursor: pointer; user-select: none; }
        th[data-sort-key]:hover { background: var(--bg-input-dark); color: var(--primary); }
        th.sort-asc::after { content: ' ‚ñ≤'; font-size: 0.8em; }
        th.sort-desc::after { content: ' ‚ñº'; font-size: 0.8em; }
        .table-density-compact td, .table-density-compact th { padding: 8px; } .table-density-spacious td, .table-density-spacious th { padding: 20px; }
        thead { background: var(--bg-light); color: var(--text-dark); }
        thead th { background: var(--bg-input-dark); color: var(--text-muted-dark); text-transform: uppercase; font-size: 0.85em; letter-spacing: 0.5px; border-bottom: 2px solid var(--border-color-dark); }
        tbody tr:not(.sub-row):nth-child(even) { background-color: rgba(255, 255, 255, 0.02); }
        body.light-theme tbody tr:not(.sub-row):nth-child(even) { background-color: rgba(0, 0, 0, 0.02); }
        tbody tr:hover { background: var(--primary-light); transform: scale(1.005); z-index: 2; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        tbody tr.highlight { animation: highlight-row 2s ease-out; }
        tbody tr.keyboard-focus { outline: 3px solid var(--primary); outline-offset: -3px; }
        tr.paid-debt { opacity: 0.6; }
        tr.paid-debt input, tr.paid-debt a { text-decoration: line-through; }
        .status-cell { text-align: center; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--danger); }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: transform 0.4s var(--transition-bounce), background-color 0.4s ease; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(26px) rotate(360deg); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        @keyframes highlight-row { 0%, 100% { background-color: transparent; } 50% { background-color: rgba(251, 191, 36, 0.3); } }
        td input { text-overflow: ellipsis; }
        .actions-cell { display: flex; align-items: center; justify-content: flex-start; gap: 10px; }
        .btn-action { background: transparent; border: none; cursor: pointer; font-size: 1.5em; padding: 5px; color: var(--text-muted-dark); font-family: 'Inter', sans-serif; line-height: 1; }
        .btn-action .icon { width: 18px; height: 18px; }
        .btn-action:hover { transform: scale(1.2) rotate(10deg); box-shadow: none; color: var(--primary); }
        .btn-delete:hover { color: var(--danger); animation: subtle-shake 0.3s ease; } .btn-expand:hover { color: var(--success); } .btn-edit:hover { color: var(--warning); }
        .sub-row { background: rgba(88, 166, 255, 0.05); }
        .sub-row td:first-child { padding-left: 30px; position: relative; }
        .sub-row td:first-child::before { content: '‚Ü≥'; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--primary); font-weight: bold; }
        .summary-container { display: flex; flex-direction: column; gap: 30px; }
        .summary-category h2 { margin-bottom: 15px; color: var(--primary); border-bottom: 2px solid var(--border-color-dark); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .summary-category h2 button { background: var(--bg-light); border: 1px solid var(--border-color-dark); color: var(--text-muted-dark); padding: 5px 10px; font-size: 0.8em; }
        .total-results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .result-card { background: var(--bg-card-dark); padding: 25px; border-radius: var(--border-radius); border: 1px solid var(--border-color-dark); border-left: 5px solid var(--primary); animation: cardEnter 0.5s var(--transition-bounce) forwards; opacity: 0; position: relative; }
        @keyframes cardEnter { from { opacity: 0; transform: translateY(30px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .result-card:hover { transform: translateY(-5px) scale(1.03); box-shadow: 0 10px 20px rgba(0,0,0,0.2); border-color: var(--primary); }
        .result-card .label { font-size: 1.1em; color: var(--text-muted-dark); margin-bottom: 10px; }
        .result-card .value { font-size: 2em; font-weight: 700; color: var(--text-dark); word-break: break-all; }
        .result-card .value.positive { color: var(--success); } .result-card .value.negative { color: var(--danger); }
        .result-card.best-client { grid-column: 1 / -1; border-color: var(--warning); cursor: pointer; }
        .best-client .value { font-size: 1.2em; line-height: 1.6; } .best-client .highlight-text { color: var(--warning); font-weight: bold; }
        @keyframes valueUpdate { 0% { transform: scale(1); } 50% { transform: scale(1.25); color: var(--primary); } 100% { transform: scale(1); } }
        .value.updated { animation: valueUpdate 0.5s var(--transition-bounce); }
        .toast-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 10000; max-width: 350px; }
        .toast { background: var(--bg-light); color: var(--text-dark); padding: 12px 16px; border-radius: var(--border-radius); box-shadow: 0 5px 20px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; animation: toastIn 0.3s var(--transition-bounce); border-left: 4px solid var(--primary); border: 1px solid var(--border-color-dark); }
        .toast.success { border-left-color: var(--success); } .toast.danger { border-left-color: var(--danger); } .toast.warning { border-left-color: var(--warning); } .toast.info { border-left-color: var(--info); }
        .toast.hiding { animation: toastOut 0.3s ease-in forwards; }
        @keyframes toastIn { from { transform: translateX(400px) scale(0.8); opacity: 0; } to { transform: translateX(0) scale(1); opacity: 1; } }
        @keyframes toastOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }
        .settings-page { background: var(--bg-light); padding: 20px; border-radius: var(--border-radius); max-width: 900px; margin: 0 auto; border: 1px solid var(--border-color-dark); }
        .settings-page h2 { margin-bottom: 20px; color: var(--primary); }
        .setting-item { display: flex; flex-direction: column; align-items: flex-start; gap: 10px; margin-bottom: 25px; }
        .setting-item > label { font-weight: bold; }
        .setting-controls { display: flex; gap: 10px; flex-wrap: wrap; width: 100%; align-items: center; }
        .setting-controls button { background-color: var(--bg-dark); color: var(--text-dark); border: 2px solid var(--border-color-dark); }
        .setting-controls button.active { border-color: var(--primary); color: var(--primary); }
        #service-templates-list { width: 100%; display: flex; flex-direction: column; gap: 5px; }
        .template-item { display: flex; justify-content: space-between; align-items: center; background: var(--bg-dark); padding: 8px; border-radius: 8px; width: 100%;}
        .template-item.income-template { border-left: 3px solid var(--success); }
        .template-item.expense-template { border-left: 3px solid var(--danger); }
        .template-item span { flex-grow: 1; margin-left: 10px;}
        .template-item .template-actions { display: flex; gap: 5px;}
        .template-form-grid { display: grid; grid-template-columns: 1fr 100px 80px 100px auto auto; gap: 10px; width: 100%;}
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.4s ease; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--bg-light); padding: 30px; border-radius: var(--border-radius); text-align: center; max-width: 90%; width: 500px; max-height: 80vh; overflow-y: auto; border: 1px solid var(--border-color-dark); transition: transform 0.4s var(--transition-bounce), opacity 0.4s ease; transform: scale(0.95); opacity: 0; }
        .modal-overlay.visible .modal-content { transform: scale(1); opacity: 1; }
        .modal-content.large { width: 800px; max-width: 95%; }
        .modal-content h2 { color: var(--primary); margin-bottom: 10px; }
        .modal-content p { margin-bottom: 20px; font-size: 1.2em; color: var(--text-dark); }
        .modal-actions { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;}
        body.animations-disabled * { animation: none !important; transition: none !important; }
        .number-input-wrapper { position: relative; display: flex; align-items: center; }
        .number-input-wrapper input[type="number"] { padding-right: 2rem; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .stepper-controls { position: absolute; right: 1px; top: 1px; bottom: 1px; width: 1.8rem; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: opacity 0.2s ease; }
        .number-input-wrapper:hover .stepper-controls, .number-input-wrapper input:focus + .stepper-controls { opacity: 1; pointer-events: all; }
        .stepper-btn { flex: 1; background: var(--bg-input-dark); border: none; color: var(--text-muted-dark); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .stepper-btn:hover { background: var(--bg-light); color: var(--primary); }
        .stepper-up { border-bottom: 1px solid var(--border-color-dark); border-top-right-radius: var(--border-radius); }
        .stepper-down { border-bottom-right-radius: var(--border-radius); }
        #faqModal .modal-content { text-align: left; max-width: 800px; max-height: 80vh; overflow-y: auto; }
        #faqModal h2 { color: var(--primary); text-align: center; margin-bottom: 20px; }
        #faqModal details { background: var(--bg-dark); border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--border-color-dark); }
        #faqModal summary { font-weight: bold; cursor: pointer; padding: 15px; color: var(--primary); }
        #faqModal details[open] summary { border-bottom: 1px solid var(--border-color-dark); }
        #faqModal .faq-content { padding: 15px; border-top: 1px solid var(--border-color-dark); }
        .todo-list { display: flex; flex-direction: column; gap: 10px; }
        .todo-item { background: var(--bg-light); padding: 10px; border-radius: var(--border-radius); display: flex; align-items: center; gap: 10px; border-left: 4px solid var(--primary); }
        .todo-item.completed { opacity: 0.6; border-left-color: var(--success); }
        .todo-item.completed .todo-text { text-decoration: line-through; }
        .todo-text { flex-grow: 1; background: transparent; border: none; color: var(--text-dark); font-family: inherit; font-size: 1em; resize: none; overflow: hidden; padding: 5px; }
        .todo-text:focus { background-color: var(--bg-dark); box-shadow: none; }
        .report-section { background: var(--bg-light); padding: 20px; border-radius: var(--border-radius); margin-bottom: 20px; }
        .report-section h3 { color: var(--primary); margin-bottom: 15px; }
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .report-item { background: var(--bg-dark); padding: 15px; border-radius: var(--border-radius); }
        .report-item-label { font-size: 0.9em; color: var(--text-muted-dark); margin-bottom: 5px; }
        .report-item-value { font-size: 1.5em; font-weight: bold; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .loading-overlay.visible { display: flex; }
        .loading-spinner { width: 60px; height: 60px; border: 4px solid var(--bg-light); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        mark { background-color: var(--warning); color: var(--bg-dark); padding: 2px 4px; border-radius: 3px; }
        #dashboardSettingsModal .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; align-items: start; }
        .settings-column { display: flex; flex-direction: column; gap: 10px; }
        .settings-column h3 { color: var(--primary); margin-bottom: 0; }
        .settings-column > div { display: flex; flex-direction: column; gap: 10px; }
        .checkbox-label { display: flex; align-items: center; gap: 10px; cursor: pointer; background: var(--bg-dark); padding: 10px; border-radius: var(--border-radius); }
        .checkbox-label:hover { background: var(--bg-light); }
        #miniCalcContainer { display: none; position: fixed; top: 100px; left: 100px; z-index: 5000; background: var(--bg-light); border-radius: var(--border-radius); box-shadow: 0 15px 35px rgba(0,0,0,0.4); width: 280px; border: 1px solid var(--border-color-dark); opacity: 0; transform: scale(0.95); }
        #miniCalcContainer.visible { display: block; opacity: 1; transform: scale(1); }
        .mini-calc-header { padding: 10px; background: var(--primary); color: var(--bg-dark); cursor: move; border-top-left-radius: var(--border-radius); border-top-right-radius: var(--border-radius); display: flex; justify-content: space-between; align-items: center; }
        .mini-calc-header span { font-weight: bold; }
        #miniCalcCloseBtn { background: none; border: none; color: var(--bg-dark); font-size: 1.5em; cursor: pointer; line-height: 1; padding: 0 5px; }
        .mini-calc .calculator-container { padding: 15px; box-shadow: none; }
        .mini-calc .calculator-display { font-size: 2em; padding: 10px; height: 50px; text-align: right; word-wrap: break-word; word-break: break-all; display: flex; justify-content: flex-end; align-items: center; background: var(--bg-dark); color: var(--text-dark); border-radius: var(--border-radius); margin-bottom: 15px;}
        .mini-calc .calculator-keys { gap: 8px; display: grid; grid-template-columns: repeat(4, 1fr); }
        .mini-calc .calculator-keys button { height: 40px; font-size: 1.1em; background: var(--bg-input-dark); color: var(--text-dark);}
        .mini-calc .calculator-keys button:active { transform: scale(0.95); box-shadow: 0 0 10px rgba(0,0,0,0.3) inset; }
        .mini-calc .calculator-keys button.operator { background: var(--primary); color: var(--bg-dark); }
        .mini-calc .calculator-keys button.function { background: var(--bg-light); }
        .mini-calc .calculator-keys button.equals { grid-column: span 2; background: var(--success); }
        .mini-calc .calculator-keys button.zero { grid-column: span 2; }
        .search-result-wrapper { animation: fadeIn 0.5s ease-out; }
        .search-result-card { background: var(--bg-card-dark); padding: 20px; border-radius: var(--border-radius); border-left: 5px solid var(--info); margin-bottom: 15px; border: 1px solid var(--border-color-dark); }
        .search-result-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.2); border-left-color: var(--primary); }
        .search-result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .search-result-title { font-size: 1.2em; font-weight: bold; color: var(--primary); }
        .search-result-body p { margin: 5px 0; color: var(--text-muted-dark); }
        .search-result-body p strong { color: var(--text-dark); }
        @media (max-width: 1024px) { .total-results-grid { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); } }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .top-bar { flex-direction: column; align-items: center; text-align: center; }
            .controls { flex-direction: column; align-items: stretch; }
            .tab { padding: 10px 15px; font-size: 0.9em; }
            .tab .icon { width: 18px; height: 18px; }
            .template-form-grid { grid-template-columns: 1fr; }
            .toast-container { right: 10px; left: 10px; max-width: none; }
            #dashboardSettingsModal .settings-grid { grid-template-columns: 1fr; }
            .stepper-controls { display: none; }
            .number-input-wrapper input[type="number"] { padding-right: 10px; }
        }
    </style>
</head>
<body>

<div id="preloader"><div class="preloader-dots"><div class="dot1"></div><div class="dot2"></div><div class="dot3"></div></div></div>

<div class="container">
    <div class="top-bar">
        <h1>–£—á–µ—Ç –®–∏–Ω–æ–º–æ–Ω—Ç–∞–∂–∞</h1>
        <div class="top-controls">
            <button id="undoBtn" title="–û—Ç–º–µ–Ω–∏—Ç—å (Ctrl+Z)" aria-label="–û—Ç–º–µ–Ω–∏—Ç—å">‚Ü∂</button>
            <button id="redoBtn" title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å (Ctrl+Y)" aria-label="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å">‚Ü∑</button>
            <button id="miniCalcBtn" title="–ú–∏–Ω–∏-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–∏–Ω–∏-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg></button>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" data-tab="total" role="tab"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg><span>–û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</span></div>
        <div class="tab" data-tab="income" role="tab"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg><span>–î–æ—Ö–æ–¥—ã</span></div>
        <div class="tab" data-tab="expenses" role="tab"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg><span>–†–∞—Å—Ö–æ–¥—ã</span></div>
        <div class="tab" data-tab="clients" role="tab"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg><span>–ö–ª–∏–µ–Ω—Ç—ã</span></div>
        <div class="tab" data-tab="warehouse" role="tab"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 4H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-2m-4-1v8m0 0l3-3m-3 3L9 8m-5 5h2.586a1 1 0 01.707.293l2.414 2.414a1 1 0 001.414 0l2.414-2.414a1 1 0 01.707-.293H17"></path></svg><span>–°–∫–ª–∞–¥</span></div>
        <div class="tab" data-tab="debts" role="tab"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg><span>–î–æ–ª–≥–∏</span></div>
        <div class="tab" data-tab="todos" role="tab"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg><span>–ó–∞–º–µ—Ç–∫–∏</span></div>
        <div class="tab" data-tab="reports" role="tab"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg><span>–û—Ç—á–µ—Ç—ã</span></div>
        <div class="tab" data-tab="settings" role="tab"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066 2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg><span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></div>
    </div>

    <div class="tab-content active" id="total">
        <div class="controls">
            <input type="search" id="globalPhoneSearch" placeholder="–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞..." aria-label="–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞" style="flex-grow: 2;">
            <button id="importDataBtn" class="button"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg> <span>–ò–º–ø–æ—Ä—Ç</span></button>
            <input type="file" id="importFileInput" style="display:none" accept=".json">
            <button class="success" id="exportDataBtn"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> <span>–≠–∫—Å–ø–æ—Ä—Ç</span></button>
            <button class="warning" id="copySummaryBtn"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg> <span>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span></button>
            <button class="danger" id="clearAllDataBtn"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg> <span>–û—á–∏—Å—Ç–∏—Ç—å</span></button>
        </div>
        <div id="globalSearchResults" class="summary-container" style="margin-top: 20px;"></div>
        <div class="summary-container">
            <div class="summary-category">
                <h2>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ <button id="customizeDashboardBtn"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6h8m-8 6h8m-8 6h8M4 6h2v2H4V6zm0 6h2v2H4v-2zm0 6h2v2H4v-2z"></path></svg> <span>–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</span></button></h2>
                <div class="total-results-grid" id="dashboardCardsContainer"></div>
            </div>
            <div class="summary-category">
                <h2>–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
                <div class="total-results-grid" id="dashboardClientCardsContainer"></div>
            </div>
        </div>
    </div>

    <div class="tab-content" id="income">
        <div class="controls"> <button id="addIncomeRowBtn">+ –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</button> <input type="search" id="incomeSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ —É—Å–ª—É–≥–∞–º, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º..." aria-label="–ü–æ–∏—Å–∫ –ø–æ –¥–æ—Ö–æ–¥–∞–º"></div>
        <div class="table-wrapper"><table id="incomeTable"><thead><tr><th scope="col" data-sort-key="date" aria-sort="none" style="width: 170px;">–î–∞—Ç–∞</th><th scope="col" data-sort-key="price" aria-sort="none" style="width: 140px;">–¶–µ–Ω–∞ –∑–∞ —à—Ç.</th><th scope="col" data-sort-key="count" aria-sort="none" style="width: 100px;">–ö–æ–ª-–≤–æ</th><th scope="col" data-sort-key="totalAmount" aria-sort="none" style="width: 150px;">–û–±—â–∞—è —Å—É–º–º–∞</th><th scope="col" data-sort-key="service" aria-sort="none">–£—Å–ª—É–≥–∞</th><th scope="col" data-sort-key="comment" aria-sort="none">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th><th scope="col" style="width: 100px;">–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div class="tab-content" id="expenses">
        <div class="controls"><button id="addExpenseRowBtn">+ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button><input type="search" id="expensesSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é..." aria-label="–ü–æ–∏—Å–∫ –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º"></div>
        <div class="table-wrapper"><table id="expensesTable"><thead><tr><th scope="col" data-sort-key="date" aria-sort="none" style="width: 170px;">–î–∞—Ç–∞</th><th scope="col" data-sort-key="price" aria-sort="none" style="width: 140px;">–¶–µ–Ω–∞ –∑–∞ —à—Ç.</th><th scope="col" data-sort-key="count" aria-sort="none" style="width: 100px;">–ö–æ–ª-–≤–æ</th><th scope="col" data-sort-key="totalAmount" aria-sort="none" style="width: 150px;">–û–±—â–∞—è —Å—É–º–º–∞</th><th scope="col" data-sort-key="description" aria-sort="none">–ß—Ç–æ –∏–º–µ–Ω–Ω–æ?</th><th scope="col" style="width: 100px;">–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div class="tab-content" id="clients">
        <div class="controls"><button id="addClientRowBtn">+ –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button><input type="search" id="clientSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –¥–∞—Ç–µ, –Ω–æ–º–µ—Ä—É, –∏–º–µ–Ω–∏, –≥–æ—Å. –Ω–æ–º–µ—Ä—É..." aria-label="–ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º"></div>
        <div class="table-wrapper"><table id="clientsTable"><thead><tr><th scope="col" data-sort-key="date" aria-sort="none" style="width: 170px;">–î–∞—Ç–∞</th><th scope="col" data-sort-key="amount" aria-sort="none" style="width: 150px;">–°—É–º–º–∞</th><th scope="col" data-sort-key="phone" aria-sort="none" style="width: 150px;">–ù–æ–º–µ—Ä</th><th scope="col" data-sort-key="plate" aria-sort="none" style="width: 130px;">–ì–æ—Å –Ω–æ–º–µ—Ä</th><th scope="col" data-sort-key="name" aria-sort="none">–ò–º—è</th><th scope="col" style="width: 120px;">–ö–æ–ª-–≤–æ –ø–æ—Å–µ—â–µ–Ω–∏–π</th><th scope="col" style="width: 140px;">–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div class="tab-content" id="warehouse">
        <div class="controls"><button id="addWarehouseRowBtn">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button><input type="search" id="warehouseSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." aria-label="–ü–æ–∏—Å–∫ –ø–æ —Å–∫–ª–∞–¥—É"></div>
        <div class="table-wrapper"><table id="warehouseTable"><thead><tr><th scope="col" data-sort-key="name" aria-sort="none">–ù–∞–∑–≤–∞–Ω–∏–µ</th><th scope="col" data-sort-key="quantity" aria-sort="none" style="width: 150px;">–ö–æ–ª-–≤–æ</th><th scope="col" style="width: 100px;">–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div class="tab-content" id="debts">
        <div class="controls"><button id="addDebtRowBtn">+ –î–æ–±–∞–≤–∏—Ç—å –¥–æ–ª–≥</button><input type="search" id="debtSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, —Ç–µ–ª–µ—Ñ–æ–Ω—É, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—é..." aria-label="–ü–æ–∏—Å–∫ –ø–æ –¥–æ–ª–≥–∞–º"></div>
        <div class="table-wrapper"><table id="debtsTable"><thead><tr><th scope="col" data-sort-key="date" aria-sort="none" style="width: 170px;">–î–∞—Ç–∞</th><th scope="col" data-sort-key="amount" aria-sort="none" style="width: 150px;">–°—É–º–º–∞</th><th scope="col" data-sort-key="name" aria-sort="none">–ö—Ç–æ –¥–æ–ª–∂–µ–Ω</th><th scope="col" data-sort-key="phone" aria-sort="none" style="width: 150px;">–¢–µ–ª–µ—Ñ–æ–Ω</th><th scope="col" data-sort-key="comment" aria-sort="none">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th><th scope="col" data-sort-key="isPaid" aria-sort="none" style="width: 100px;">–°—Ç–∞—Ç—É—Å</th><th scope="col" style="width: 100px;">–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div class="tab-content" id="todos">
        <div class="controls">
            <input type="text" id="newTodoInput" placeholder="–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞ (Enter –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è)...">
            <button id="addTodoBtn" class="success">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div class="todo-list" id="todoList"></div>
    </div>

    <div class="tab-content" id="reports">
        <div class="controls">
            <label for="reportStartDate">–ü–µ—Ä–∏–æ–¥ c:</label>
            <input type="date" id="reportStartDate">
            <label for="reportEndDate">–ø–æ:</label>
            <input type="date" id="reportEndDate">
            <button id="generateReportBtn" class="info">üìä –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç</button>
        </div>
        <div id="reportResults"></div>
    </div>

    <div class="tab-content" id="settings">
        <div class="settings-page">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <div class="setting-item"><label>–¢–µ–º–∞:</label><div class="setting-controls" id="theme-switcher"><button data-theme="dark" class="active">–¢–µ–º–Ω–∞—è</button><button data-theme="light">–°–≤–µ—Ç–ª–∞—è</button></div></div>
            <div class="setting-item"><label for="primaryColorPicker">–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç:</label><input type="color" id="primaryColorPicker" value="#58A6FF"></div>
            <div class="setting-item"><label for="currencySymbol">–°–∏–º–≤–æ–ª –≤–∞–ª—é—Ç—ã:</label><input type="text" id="currencySymbol" value="‚ÇΩ" style="width: 60px; text-align: center;" maxlength="5"></div>
            <div class="setting-item"><label>–ê–Ω–∏–º–∞—Ü–∏–∏:</label><div class="setting-controls" id="animation-switcher"><button data-anim="on" class="active">–í–∫–ª</button><button data-anim="off">–í—ã–∫–ª</button></div></div>
            <div class="setting-item"><label>–ü–ª–æ—Ç–Ω–æ—Å—Ç—å —Ç–∞–±–ª–∏—Ü:</label><div class="setting-controls" id="density-switcher"><button data-density="compact">–ö–æ–º–ø–∞–∫—Ç–Ω–æ</button><button data-density="normal" class="active">–ù–æ—Ä–º–∞–ª—å–Ω–æ</button><button data-density="spacious">–ü—Ä–æ—Å—Ç–æ—Ä–Ω–æ</button></div></div>
            <div class="setting-item"><label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞:</label><div class="setting-controls" id="font-size-switcher"><button data-size="small">–ú–µ–ª–∫–∏–π</button><button data-size="normal" class="active">–û–±—ã—á–Ω—ã–π</button><button data-size="large">–ö—Ä—É–ø–Ω—ã–π</button></div></div>
            <div class="setting-item"><label>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è:</label><div class="setting-controls" id="confirm-delete-switcher"><button data-confirm="on" class="active">–í–∫–ª</button><button data-confirm="off">–í—ã–∫–ª</button></div></div>
            <div class="setting-item"><label>–í–∫–ª–∞–¥–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:</label><div class="setting-controls"><select id="defaultTabSelect" class="setting-select"></select></div></div>
            <div class="setting-item"><label>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ:</label><div class="setting-controls"><select id="autoBackupSelect" class="setting-select"><option value="0">–ù–∏–∫–æ–≥–¥–∞</option><option value="hourly">–ö–∞–∂–¥—ã–π —á–∞—Å</option><option value="1">–ö–∞–∂–¥—ã–π –¥–µ–Ω—å</option><option value="7">–ö–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é</option><option value="30">–ö–∞–∂–¥—ã–π –º–µ—Å—è—Ü</option></select></div></div>
            <div class="setting-item"><label>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω –∫–ª–∏–µ–Ω—Ç–æ–≤:</label><div class="setting-controls" id="auto-capitalize-switcher"><button data-capitalize="on" class="active">–ü–µ—Ä–≤–∞—è –±—É–∫–≤–∞ –∑–∞–≥–ª–∞–≤–Ω–∞—è</button><button data-capitalize="off">–ö–∞–∫ –≤–≤–µ–¥–µ–Ω–æ</button></div></div>
            <div class="setting-item" title="–ü—Ä–∏ —Ä–∞–≤–µ–Ω—Å—Ç–≤–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫—Ä–∏—Ç–µ—Ä–∏—è, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ –≤—Ç–æ—Ä–∏—á–Ω–æ–º—É"><label>–ö—Ä–∏—Ç–µ—Ä–∏–π "–õ—É—á—à–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞":</label><div class="setting-controls" id="best-client-metric-switcher"><button data-metric="profit" class="active">–ü–æ —Å—É–º–º–µ</button><button data-metric="visits">–ü–æ –ø–æ—Å–µ—â–µ–Ω–∏—è–º</button><button data-metric="avgCheck">–ü–æ —Å—Ä–µ–¥–Ω–µ–º—É —á–µ–∫—É</button></div></div>
            <div class="setting-item"><label>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–≥–∞—à–µ–Ω–Ω—ã–µ –¥–æ–ª–≥–∏:</label><div class="setting-controls" id="show-paid-debts-switcher"><button data-show="on" class="active">–í–∫–ª</button><button data-show="off">–í—ã–∫–ª</button></div></div>
            <div class="setting-item"><label for="defaultItemCountInput">–ö–æ–ª-–≤–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –î–æ—Ö–æ–¥–æ–≤/–†–∞—Å—Ö–æ–¥–æ–≤:</label><div class="setting-controls"><input type="number" id="defaultItemCountInput" min="1" step="1" style="width: 100px;"></div></div>
            <div class="setting-item"><label for="stepperStepInput">–®–∞–≥ –¥–ª—è –∫–Ω–æ–ø–æ–∫ (+/-):</label><div class="setting-controls"><input type="number" id="stepperStepInput" value="1" step="0.01" min="0.01" style="width: 100px;"></div></div>
            <div class="setting-item"><label>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å –∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö:</label><div class="setting-controls" id="confirm-import-switcher"><button data-import="on" class="active">–í–∫–ª</button><button data-import="off">–í—ã–∫–ª</button></div></div>
            <div class="setting-item"><label>–®–∞–±–ª–æ–Ω—ã</label><div class="setting-controls"><div class="template-form-grid"><input type="text" id="templateName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"><input type="number" id="templatePrice" placeholder="–¶–µ–Ω–∞" min="0"><input type="number" id="templateCount" placeholder="–ö–æ–ª-–≤–æ" value="1" min="1"><select id="templateType" style="width: 100%;"><option value="income">–î–æ—Ö–æ–¥</option><option value="expense">–†–∞—Å—Ö–æ–¥</option></select><button id="addServiceTemplateBtn">–î–æ–±–∞–≤–∏—Ç—å</button><button id="cancelEditTemplateBtn" class="button danger" style="display: none;">–û—Ç–º–µ–Ω–∞</button></div></div><div id="service-templates-list" style="margin-top: 10px;"></div></div>
            <div class="setting-item"><label>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</label><div class="setting-controls"><button class="success" id="saveBackupNowBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–ø–∏—é —Å–µ–π—á–∞—Å</button><button class="info" id="restoreBackupBtn">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –∫–æ–ø–∏–∏</button><button class="warning" id="resetSettingsBtn">–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button></div></div>
            <div class="setting-item"><label>–ü–æ–º–æ—â—å</label><div class="setting-controls"><button id="showFaqBtn">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é</button></div></div>
        </div>
    </div>
</div>
<datalist id="service-templates-datalist-income"></datalist>
<datalist id="service-templates-datalist-expense"></datalist>

<div id="confirmModal" class="modal-overlay">
    <div class="modal-content">
        <p id="modalText">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
        <div class="modal-actions">
            <button id="modalConfirmBtn" class="button">–î–∞</button>
            <button id="modalCancelBtn" class="button">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<div id="importChoiceModal" class="modal-overlay">
    <div class="modal-content">
        <h2>–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h2>
        <p>–ö–∞–∫ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ?</p>
        <div class="modal-actions">
            <button id="importMergeBtn" class="button success">–û–±—ä–µ–¥–∏–Ω–∏—Ç—å</button>
            <button id="importReplaceBtn" class="button warning">–ó–∞–º–µ–Ω–∏—Ç—å</button>
            <button id="importCancelBtn" class="button">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<div id="exportChoiceModal" class="modal-overlay">
    <div class="modal-content">
        <h2>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h2>
        <p>–ö–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å?</p>
        <div class="modal-actions">
            <button id="exportAllBtn" class="button success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ</button>
            <button id="exportPartialBtn" class="button info">–ß–∞—Å—Ç–∏—á–Ω–æ</button>
            <button id="exportCancelBtn" class="button">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<div id="partialExportModal" class="modal-overlay">
    <div class="modal-content large" style="text-align: left;">
        <h2>–ß–∞—Å—Ç–∏—á–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç</h2>
        <p style="font-size: 1em; color: var(--text-muted-dark); margin-top: -10px;">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:</p>
        <div id="partialExportCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 25px; margin-top: 15px;">
        </div>
        <div class="modal-actions">
            <button id="exportSelectedBtn" class="button success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</button>
            <button id="exportBackBtn" class="button">–ù–∞–∑–∞–¥</button>
        </div>
    </div>
</div>

<div id="faqModal" class="modal-overlay">
    <div class="modal-content">
        <h2>FAQ / –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h2>
        <details>
            <summary>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ?</summary>
            <div class="faq-content">
                <p>–ï—Å–ª–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –≤—ã–±—Ä–∞–Ω–∞ —á–∞—Å—Ç–æ—Ç–∞ (—á–∞—Å, –¥–µ–Ω—å, –Ω–µ–¥–µ–ª—è, –º–µ—Å—è—Ü), –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –≠—Ç–∞ –∫–æ–ø–∏—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</p>
                <p><b>–í–∞–∂–Ω–æ:</b> –≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö, –Ω–æ –Ω–µ —Å–ø–∞—Å–µ—Ç, –µ—Å–ª–∏ –≤—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä–∞. –î–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é "–≠–∫—Å–ø–æ—Ä—Ç", —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª –Ω–∞ —Å–≤–æ–π –∫–æ–º–ø—å—é—Ç–µ—Ä.</p>
                <p>–í—ã –º–æ–∂–µ—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–ø–∏–∏ —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–∫–∏ "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –∫–æ–ø–∏–∏" –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–ø–∏—é —Å–µ–π—á–∞—Å" –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.</p>
            </div>
        </details>
        <details>
            <summary>–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥ –∏–ª–∏ —Ä–∞—Å—Ö–æ–¥?</summary>
            <div class="faq-content"><p>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–î–æ—Ö–æ–¥—ã" –∏–ª–∏ "–†–∞—Å—Ö–æ–¥—ã" –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "+ –î–æ–±–∞–≤–∏—Ç—å". –ü–æ—è–≤–∏—Ç—Å—è –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞, –≥–¥–µ –≤—ã –º–æ–∂–µ—Ç–µ –≤–≤–µ—Å—Ç–∏ –¥–∞—Ç—É, —Ü–µ–Ω—É –∑–∞ —à—Ç—É–∫—É, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ. –û–±—â–∞—è —Å—É–º–º–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –≤–≤–µ—Å—Ç–∏ –æ–±—â—É—é —Å—É–º–º—É, –∏ —Ü–µ–Ω–∞ –∑–∞ —à—Ç—É–∫—É –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç—Å—è.</p></div>
        </details>
        <details>
            <summary>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —à–∞–±–ª–æ–Ω—ã?</summary>
            <div class="faq-content"><p>–í "–ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö" –µ—Å—Ç—å —Ä–∞–∑–¥–µ–ª "–®–∞–±–ª–æ–Ω—ã". –í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω –¥–ª—è —á–∞—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –¥–æ—Ö–æ–¥–æ–≤ –∏–ª–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤, —É–∫–∞–∑–∞–≤ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω—É, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Ç–∏–ø (–¥–æ—Ö–æ–¥/—Ä–∞—Å—Ö–æ–¥). –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è, –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ –æ –¥–æ—Ö–æ–¥–µ/—Ä–∞—Å—Ö–æ–¥–µ, –Ω–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ –ø–æ–ª–µ "–£—Å–ª—É–≥–∞" –∏–ª–∏ "–ß—Ç–æ –∏–º–µ–Ω–Ω–æ?", –∏ –≤–∞–º –±—É–¥–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω –≤–∞—à —à–∞–±–ª–æ–Ω. –ü—Ä–∏ –≤—ã–±–æ—Ä–µ —à–∞–±–ª–æ–Ω–∞ –≤—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p></div>
        </details>
        <details>
            <summary>–ö–∞–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ?</summary>
            <div class="faq-content">
                <p>–ù–∞ –≥–ª–∞–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ "–û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç" –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ "–ò–º–ø–æ—Ä—Ç" –∏ "–≠–∫—Å–ø–æ—Ä—Ç".</p>
                <p><b>–≠–∫—Å–ø–æ—Ä—Ç:</b> –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–¥–æ—Ö–æ–¥—ã, –∫–ª–∏–µ–Ω—Ç—ã –∏ —Ç.–¥.) –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª –Ω–∞ –≤–∞—à –∫–æ–º–ø—å—é—Ç–µ—Ä.</p>
                <p><b>–ò–º–ø–æ—Ä—Ç:</b> –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞. –í–∞–º –±—É–¥–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞:</p>
                <ul>
                    <li style="text-align: left; margin-left: 20px;"><b>–û–±—ä–µ–¥–∏–Ω–∏—Ç—å:</b> –î–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞ –¥–æ–±–∞–≤—è—Ç—Å—è –∫ –≤–∞—à–∏–º —Ç–µ–∫—É—â–∏–º –¥–∞–Ω–Ω—ã–º. –ï—Å–ª–∏ –≤ —Ñ–∞–π–ª–µ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ —Ä–∞—Å—Ö–æ–¥—ã, —Ç–æ —Ç–æ–ª—å–∫–æ –æ–Ω–∏ –∏ –¥–æ–±–∞–≤—è—Ç—Å—è, –∞ –≤–∞—à–∏ –¥–æ—Ö–æ–¥—ã, –∫–ª–∏–µ–Ω—Ç—ã –∏ —Ç.–¥. –æ—Å—Ç–∞–Ω—É—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.</li>
                    <li style="text-align: left; margin-left: 20px;"><b>–ó–∞–º–µ–Ω–∏—Ç—å:</b> –í—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –±—É–¥—É—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω—ã, –∞ –≤–º–µ—Å—Ç–æ –Ω–∏—Ö –∑–∞–≥—Ä—É–∑—è—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞. –ï—Å–ª–∏ –≤ —Ñ–∞–π–ª–µ –±—ã–ª–∏ —Ç–æ–ª—å–∫–æ –¥–æ—Ö–æ–¥—ã, —Ç–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–Ω–∏, –∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã —Å—Ç–∞–Ω—É—Ç –ø—É—Å—Ç—ã–º–∏.</li>
                </ul>
            </div>
        </details>
         <details>
            <summary>–ö–∞–∫–∏–µ –µ—Å—Ç—å –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏?</summary>
            <div class="faq-content">
                <p><b>Ctrl + Z</b> - –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ.</p>
                <p><b>Ctrl + Y</b> - –í–µ—Ä–Ω—É—Ç—å –æ—Ç–º–µ–Ω–µ–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.</p>
                <p><b>Escape</b> - –ó–∞–∫—Ä—ã—Ç—å –ª—é–±–æ–µ –æ—Ç–∫—Ä—ã—Ç–æ–µ –æ–∫–Ω–æ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è, –∏ —Ç.–¥.).</p>
            </div>
        </details>
        <div class="modal-actions" style="margin-top: 20px;"><button id="faqCloseBtn" class="button">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    </div>
</div>

<div id="dashboardSettingsModal" class="modal-overlay">
    <div class="modal-content large">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã</h2>
        <div id="dashboardSettingsForm">
            <div class="settings-grid">
                <div class="settings-column">
                    <h3>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h3>
                    <div id="main-cards-settings"></div>
                </div>
                <div class="settings-column">
                    <h3>–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h3>
                    <div id="client-cards-settings"></div>
                </div>
            </div>
        </div>
        <div class="modal-actions" style="margin-top: 20px;">
            <button id="saveDashboardSettingsBtn" class="button success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="cancelDashboardSettingsBtn" class="button">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<div id="miniCalcContainer">
    <div class="mini-calc-header" id="miniCalcHeader">
        <span>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</span>
        <button id="miniCalcCloseBtn">&times;</button>
    </div>
    <div class="calculator-container mini-calc">
        <div id="mini-calculator-display" class="calculator-display">0</div>
        <div class="calculator-keys">
            <button class="function" data-key="clear">AC</button>
            <button class="function" data-key="backspace">C</button>
            <button class="function" data-key="percent">%</button>
            <button class="operator" data-key="/">√∑</button>
            <button data-key="7">7</button><button data-key="8">8</button><button data-key="9">9</button>
            <button class="operator" data-key="*">√ó</button>
            <button data-key="4">4</button><button data-key="5">5</button><button data-key="6">6</button>
            <button class="operator" data-key="-">‚àí</button>
            <button data-key="1">1</button><button data-key="2">2</button><button data-key="3">3</button>
            <button class="operator" data-key="+">+</button>
            <button class="zero" data-key="0">0</button><button data-key=".">.</button>
            <button class="equals" data-key="=">=</button>
        </div>
    </div>
</div>

<div class="toast-container" id="toastContainer"></div>
<div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div></div>

<script>
'use strict';

document.addEventListener('DOMContentLoaded', () => {
    const get = (selector) => document.querySelector(selector);
    const getAll = (selector) => document.querySelectorAll(selector);

    class TireServiceApp {
        constructor() {
            this.MAX_HISTORY_STATES = 30;
            this.data = this.getDefaultData();
            this.historyStack = [];
            this.historyIndex = -1;
            this.editingTemplateIndex = null;
            this.miniCalculatorState = { displayValue: '0', firstOperand: null, waitingForSecondOperand: false, operator: null };
            this.elements = {};
            this.dashboardCards = {
                totalProfit: { label: 'üí∞ –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å' }, totalIncome: { label: 'üìà –û–±—â–∏–π –¥–æ—Ö–æ–¥' }, totalExpenses: { label: 'üìâ –û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥' },
                profitToday: { label: 'ü§ë –ü—Ä–∏–±—ã–ª—å –∑–∞ —Å–µ–≥–æ–¥–Ω—è' }, incomeToday: { label: 'üí≤ –î–æ—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è' }, totalDebt: { label: 'üí∏ –û–±—â–∞—è —Å—É–º–º–∞ –¥–æ–ª–≥–æ–≤' },
                avgIncome: { label: 'üßæ –°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (–¥–æ—Ö–æ–¥)' }, avgExpense: { label: 'üõí –°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (—Ä–∞—Å—Ö–æ–¥)' }, topService: { label: '‚≠ê –¢–æ–ø —É—Å–ª—É–≥–∞' },
                incomeCount: { label: 'üìù –ö–æ–ª-–≤–æ –¥–æ—Ö–æ–¥–æ–≤' }, expenseCount: { label: 'üõí –ö–æ–ª-–≤–æ —Ä–∞—Å—Ö–æ–¥–æ–≤' }, transactionsToday: { label: 'üîÑ –û–ø–µ—Ä–∞—Ü–∏–π —Å–µ–≥–æ–¥–Ω—è' },
                uniqueWarehousePositions: { label: 'üì¶ –ü–æ–∑–∏—Ü–∏–π –Ω–∞ —Å–∫–ª–∞–¥–µ' }, totalWarehouseItems: { label: 'üî¢ –í—Å–µ–≥–æ –µ–¥–∏–Ω–∏—Ü –Ω–∞ —Å–∫–ª–∞–¥–µ' },
            };
            this.clientCards = {
                totalClients: { label: 'üë• –í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤' }, totalVisits: { label: 'üöó –í—Å–µ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏–π' }, avgClientCheck: { label: 'üìä –°—Ä–µ–¥–Ω–∏–π —á–µ–∫ –∫–ª–∏–µ–Ω—Ç–∞' },
                newClientsToday: { label: 'üëã –ù–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å–µ–≥–æ–¥–Ω—è'}, bestClientInfo: { label: 'üëë –õ—É—á—à–∏–π –∫–ª–∏–µ–Ω—Ç –ø–æ —Å—É–º–º–µ' }, topClientVisits: { label: 'üèÜ –ö–ª–∏–µ–Ω—Ç –ø–æ –≤–∏–∑–∏—Ç–∞–º' },
                returningClients: { label: 'üîÅ –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã' }, newestClient: { label: '‚ú® –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–ª–∏–µ–Ω—Ç' },
            };
            this.showSavedToast = this.debounce(() => this.showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success', 1500), 1000);
        }

        init() {
            this.cacheDOMElements();
            this.populateDefaultTabSelect();
            this.setupEventListeners();
            this.loadData();
            this.handleAutoBackup();
            
            window.addEventListener('load', () => {
                 setTimeout(() => {
                    this.elements.preloader.style.opacity = '0';
                    this.elements.preloader.addEventListener('transitionend', () => this.elements.preloader.style.display = 'none');
                }, 300);
            });
        }
        
        cacheDOMElements() {
            const selectors = {
                preloader: '#preloader', tabs: '.tabs', undoBtn: '#undoBtn', redoBtn: '#redoBtn', miniCalcBtn: '#miniCalcBtn', addIncomeRowBtn: '#addIncomeRowBtn',
                addExpenseRowBtn: '#addExpenseRowBtn', addClientRowBtn: '#addClientRowBtn', addWarehouseRowBtn: '#addWarehouseRowBtn',
                addDebtRowBtn: '#addDebtRowBtn', addServiceTemplateBtn: '#addServiceTemplateBtn', cancelEditTemplateBtn: '#cancelEditTemplateBtn',
                incomeTableBody: '#incomeTable tbody', expensesTableBody: '#expensesTable tbody', clientsTableBody: '#clientsTable tbody',
                debtsTableBody: '#debtsTable tbody', warehouseTableBody: '#warehouseTable tbody', incomeSearch: '#incomeSearch',
                expensesSearch: '#expensesSearch', clientSearch: '#clientSearch', debtSearch: '#debtSearch', warehouseSearch: '#warehouseSearch',
                importDataBtn: '#importDataBtn', exportDataBtn: '#exportDataBtn', importFileInput: '#importFileInput',
                importChoiceModal: '#importChoiceModal', importMergeBtn: '#importMergeBtn', importReplaceBtn: '#importReplaceBtn',
                importCancelBtn: '#importCancelBtn', exportChoiceModal: '#exportChoiceModal', exportAllBtn: '#exportAllBtn',
                exportPartialBtn: '#exportPartialBtn', exportCancelBtn: '#exportCancelBtn', partialExportModal: '#partialExportModal',
                exportSelectedBtn: '#exportSelectedBtn', exportBackBtn: '#exportBackBtn', clearAllDataBtn: '#clearAllDataBtn',
                copySummaryBtn: '#copySummaryBtn', dashboardClientCardsContainer: '#dashboardClientCardsContainer', customizeDashboardBtn: '#customizeDashboardBtn',
                settingsContainer: '#settings', resetSettingsBtn: '#resetSettingsBtn', restoreBackupBtn: '#restoreBackupBtn', saveBackupNowBtn: '#saveBackupNowBtn',
                primaryColorPicker: '#primaryColorPicker', currencySymbol: '#currencySymbol', defaultTabSelect: '#defaultTabSelect',
                autoBackupSelect: '#autoBackupSelect', defaultItemCountInput: '#defaultItemCountInput', stepperStepInput: '#stepperStepInput',
                serviceTemplatesList: '#service-templates-list', showFaqBtn: '#showFaqBtn', faqModal: '#faqModal', faqCloseBtn: '#faqCloseBtn',
                addTodoBtn: '#addTodoBtn', newTodoInput: '#newTodoInput', todoList: '#todoList', generateReportBtn: '#generateReportBtn',
                reportStartDate: '#reportStartDate', reportEndDate: '#reportEndDate', reportResults: '#reportResults', saveDashboardSettingsBtn: '#saveDashboardSettingsBtn',
                cancelDashboardSettingsBtn: '#cancelDashboardSettingsBtn', dashboardSettingsModal: '#dashboardSettingsModal', globalPhoneSearch: '#globalPhoneSearch',
                globalSearchResults: '#globalSearchResults', miniCalcContainer: '#miniCalcContainer', miniCalcHeader: '#miniCalcHeader',
                miniCalcCloseBtn: '#miniCalcCloseBtn', miniCalcKeys: '#miniCalcContainer .calculator-keys', miniCalcDisplay: '#mini-calculator-display',
                confirmModal: '#confirmModal', modalConfirmBtn: '#modalConfirmBtn', modalCancelBtn: '#modalCancelBtn', modalText: '#modalText',
                loadingOverlay: '#loadingOverlay',
                templateName: '#templateName', templatePrice: '#templatePrice', templateCount: '#templateCount', templateType: '#templateType',
            };
            for(const key in selectors) {
                this.elements[key] = get(selectors[key]);
            }
            this.elements.allSortableHeaders = getAll('th[data-sort-key]');
            this.elements.allTabs = getAll('.tab');
        }

        getDefaultData() {
            return {
                income: [], expenses: [], clients: [], debts: [], serviceTemplates: [], todos: [], warehouse: [],
                settings: {
                    theme: 'dark', currency: '‚ÇΩ', primaryColor: '#58A6FF', animations: true, tableDensity: 'normal', 
                    fontSize: 'normal', confirmDelete: true, bestClientMetric: 'profit', showPaidDebts: true, 
                    activeTab: 'total', defaultTab: 'total', autoBackup: '7', autoCapitalize: true,
                    defaultItemCount: 1, stepperStep: 1, confirmImport: true,
                    visibleDashboardCards: ['totalProfit', 'totalIncome', 'totalExpenses', 'profitToday', 'incomeToday', 'totalDebt', 'topService', 'transactionsToday', 'uniqueWarehousePositions', 'totalWarehouseItems'],
                    visibleClientCards: ['totalClients', 'totalVisits', 'avgClientCheck', 'newClientsToday', 'bestClientInfo', 'topClientVisits', 'returningClients'],
                    incomeFilter: '', expensesFilter: '', clientsFilter: '', debtsFilter: '', warehouseFilter: '',
                    sort: {
                        income: {key: 'date', dir: 'desc'}, expenses: {key: 'date', dir: 'desc'},
                        clients: {key: 'date', dir: 'desc'}, debts: {key: 'date', dir: 'desc'},
                        warehouse: {key: 'name', dir: 'asc'}
                    }
                }
            };
        }
        
        uuid() {
            return (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() :
                'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                    const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
        }

        getTodayDate() {
            const date = new Date();
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            return date.toISOString().slice(0, 10);
        }

        setupEventListeners() {
            document.addEventListener('keydown', e => {
                if (e.ctrlKey && e.key === 'z') { e.preventDefault(); this.undo(); }
                if (e.ctrlKey && e.key === 'y') { e.preventDefault(); this.redo(); }
                if (e.key === 'Escape') {
                    const visibleModal = get('.modal-overlay.visible');
                    if (visibleModal) visibleModal.classList.remove('visible');
                    if(this.elements.miniCalcContainer.classList.contains('visible')) this.elements.miniCalcContainer.classList.remove('visible');
                }
            });

            this.elements.tabs.addEventListener('click', e => {
                const tab = e.target.closest('.tab');
                if (tab) this.switchTab(tab.dataset.tab);
            });
            
            this.elements.undoBtn.addEventListener('click', () => this.undo());
            this.elements.redoBtn.addEventListener('click', () => this.redo());
            this.elements.miniCalcBtn.addEventListener('click', () => this.toggleMiniCalc());

            this.elements.addIncomeRowBtn.addEventListener('click', () => this.addIncomeRow());
            this.elements.addExpenseRowBtn.addEventListener('click', () => this.addExpenseRow());
            this.elements.addClientRowBtn.addEventListener('click', () => this.addClientRow());
            this.elements.addWarehouseRowBtn.addEventListener('click', () => this.addWarehouseRow());
            this.elements.addDebtRowBtn.addEventListener('click', () => this.addDebtRow());
            this.elements.addServiceTemplateBtn.addEventListener('click', () => this.addOrUpdateServiceTemplate());
            this.elements.cancelEditTemplateBtn.addEventListener('click', () => this.resetTemplateForm());
            
            ['income', 'expenses', 'clients', 'debts', 'warehouse'].forEach(key => {
                const tableBody = this.elements[`${key}TableBody`];
                tableBody.addEventListener('input', e => this.handleTableLiveUpdate(e, key));
                tableBody.addEventListener('change', e => this.handleTableChangeCommit(e, key));
                tableBody.addEventListener('click', e => this.handleTableClick(e, key));
            });
            
            this.elements.allSortableHeaders.forEach(th => th.addEventListener('click', e => {
                const tableId = e.target.closest('table').id;
                const tableKey = tableId.replace('Table', '');
                this.sortTable(tableKey, e.target.dataset.sortKey);
            }));

            const setupSearch = (input, key) => {
                input.addEventListener('input', this.debounce(e => {
                    this.updateSetting(`${key}Filter`, e.target.value, false);
                    this.renderAllTables();
                }, 300));
            };
            setupSearch(this.elements.incomeSearch, 'income');
            setupSearch(this.elements.expensesSearch, 'expenses');
            setupSearch(this.elements.clientSearch, 'clients');
            setupSearch(this.elements.debtSearch, 'debts');
            setupSearch(this.elements.warehouseSearch, 'warehouse');

            this.elements.importDataBtn.addEventListener('click', () => this.elements.importChoiceModal.classList.add('visible'));
            this.elements.exportDataBtn.addEventListener('click', () => this.elements.exportChoiceModal.classList.add('visible'));
            this.elements.importFileInput.addEventListener('change', e => this.handleFileImport(e));
            this.elements.importMergeBtn.addEventListener('click', () => this.triggerImport('merge'));
            this.elements.importReplaceBtn.addEventListener('click', () => this.triggerImport('replace'));
            this.elements.importCancelBtn.addEventListener('click', () => this.elements.importChoiceModal.classList.remove('visible'));
            this.elements.exportAllBtn.addEventListener('click', () => { this.exportData(null); this.elements.exportChoiceModal.classList.remove('visible'); });
            this.elements.exportPartialBtn.addEventListener('click', () => this.showPartialExportModal());
            this.elements.exportCancelBtn.addEventListener('click', () => this.elements.exportChoiceModal.classList.remove('visible'));
            this.elements.exportSelectedBtn.addEventListener('click', () => this.exportPartialData());
            this.elements.exportBackBtn.addEventListener('click', () => {
                this.elements.partialExportModal.classList.remove('visible');
                this.elements.exportChoiceModal.classList.add('visible');
            });

            this.elements.clearAllDataBtn.addEventListener('click', () => this.clearAllData());
            this.elements.copySummaryBtn.addEventListener('click', () => this.copySummary());
            this.elements.dashboardClientCardsContainer.addEventListener('click', e => {
                const card = e.target.closest('.result-card');
                if (card && (card.id === 'bestClientInfoCard' || card.id === 'topClientVisitsCard' || card.id === 'newestClientCard')) {
                    this.goToBestClient(card.dataset.clientId);
                }
            });
            this.elements.customizeDashboardBtn.addEventListener('click', () => this.showDashboardSettingsModal());
            
            this.elements.settingsContainer.addEventListener('click', e => {
                const button = e.target.closest('button');
                if (!button) return;
                const switcher = button.closest('.setting-controls');
                if (!switcher) return;
                const settingMap = {
                    'theme-switcher': { key: 'theme', attr: 'theme' },
                    'animation-switcher': { key: 'animations', attr: 'anim', transform: v => v === 'on' },
                    'density-switcher': { key: 'tableDensity', attr: 'density' },
                    'font-size-switcher': { key: 'fontSize', attr: 'size' },
                    'confirm-delete-switcher': { key: 'confirmDelete', attr: 'confirm', transform: v => v === 'on' },
                    'best-client-metric-switcher': { key: 'bestClientMetric', attr: 'metric' },
                    'show-paid-debts-switcher': { key: 'showPaidDebts', attr: 'show', transform: v => v === 'on' },
                    'auto-capitalize-switcher': { key: 'autoCapitalize', attr: 'capitalize', transform: v => v === 'on' },
                    'confirm-import-switcher': { key: 'confirmImport', attr: 'import', transform: v => v === 'on' },
                };
                const setting = settingMap[switcher.id];
                if (setting && button.dataset[setting.attr]) {
                    let value = button.dataset[setting.attr];
                    if (setting.transform) value = setting.transform(value);
                    this.updateSetting(setting.key, value);
                }
            });
            this.elements.resetSettingsBtn.addEventListener('click', () => this.resetSettings());
            this.elements.restoreBackupBtn.addEventListener('click', () => this.restoreFromBackup());
            this.elements.saveBackupNowBtn.addEventListener('click', () => this.saveBackupNow());
            
            this.elements.primaryColorPicker.addEventListener('input', this.debounce(e => this.updateSetting('primaryColor', e.target.value), 100));
            this.elements.currencySymbol.addEventListener('input', this.debounce(e => this.updateSetting('currency', e.target.value), 300));
            this.elements.defaultTabSelect.addEventListener('change', e => this.updateSetting('defaultTab', e.target.value));
            this.elements.autoBackupSelect.addEventListener('change', e => this.updateSetting('autoBackup', e.target.value));
            this.elements.defaultItemCountInput.addEventListener('input', this.debounce(e => this.updateSetting('defaultItemCount', parseInt(e.target.value) || 1), 300));
            this.elements.stepperStepInput.addEventListener('input', this.debounce(e => this.updateSetting('stepperStep', parseFloat(e.target.value) || 1), 300));

            this.elements.serviceTemplatesList.addEventListener('click', async e => {
                const target = e.target.closest('button');
                if (!target) return;
                const item = target.closest('.template-item');
                const index = parseInt(item.dataset.index);
                if (target.classList.contains('btn-delete')) await this.deleteServiceTemplate(index);
                if (target.classList.contains('btn-edit')) this.editServiceTemplate(index);
            });
            
            this.elements.showFaqBtn.addEventListener('click', () => this.elements.faqModal.classList.add('visible'));
            this.elements.faqCloseBtn.addEventListener('click', () => this.elements.faqModal.classList.remove('visible'));
            this.elements.faqModal.addEventListener('click', e => { if (e.target.id === 'faqModal') this.elements.faqModal.classList.remove('visible'); });

            this.elements.addTodoBtn.addEventListener('click', () => this.addTodo());
            this.elements.newTodoInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.addTodo(); } });
            this.elements.todoList.addEventListener('click', e => {
                const item = e.target.closest('.todo-item');
                if(!item) return;
                if(e.target.type === 'checkbox') this.toggleTodo(item.dataset.id);
                if(e.target.closest('.btn-delete')) this.deleteTodo(item.dataset.id);
            });
            this.elements.todoList.addEventListener('input', e => {
                const textarea = e.target.closest('.todo-text');
                if(textarea) this.autoResizeTextarea(textarea);
            });
            this.elements.todoList.addEventListener('change', e => {
                const textarea = e.target.closest('.todo-text');
                if(textarea) this.handleTodoChange(textarea);
            });
            
            this.elements.generateReportBtn.addEventListener('click', () => this.generateReport());
            this.elements.reportStartDate.value = new Date(new Date().setDate(1)).toISOString().slice(0,10);
            this.elements.reportEndDate.value = this.getTodayDate();

            this.elements.saveDashboardSettingsBtn.addEventListener('click', () => this.saveDashboardSettings());
            this.elements.cancelDashboardSettingsBtn.addEventListener('click', () => this.elements.dashboardSettingsModal.classList.remove('visible'));
            
            this.elements.globalPhoneSearch.addEventListener('input', this.debounce(e => this.performGlobalPhoneSearch(e.target.value), 300));
            this.elements.globalSearchResults.addEventListener('click', e => this.handleSearchResultClick(e));

            this.setupMiniCalcListeners();
        }

        populateDefaultTabSelect() {
            const select = this.elements.defaultTabSelect;
            select.innerHTML = '';
            this.elements.allTabs.forEach(tab => {
                const option = document.createElement('option');
                option.value = tab.dataset.tab;
                option.textContent = tab.querySelector('span') ? tab.querySelector('span').textContent.trim() : tab.textContent.trim();
                select.appendChild(option);
            });
        }
        
        confirmAction({ text, confirmText = "–î–∞", cancelText = "–û—Ç–º–µ–Ω–∞", confirmClass = 'danger' }) {
            return new Promise((resolve) => {
                const { confirmModal, modalConfirmBtn, modalCancelBtn, modalText } = this.elements;
                modalText.textContent = text;
                modalConfirmBtn.textContent = confirmText;
                modalCancelBtn.textContent = cancelText;
                modalConfirmBtn.className = `button ${confirmClass}`;
                modalCancelBtn.className = 'button';
                confirmModal.classList.add('visible');
                
                const cleanup = (result) => {
                    confirmModal.classList.remove('visible');
                    confirmModal.removeEventListener('click', outsideClickHandler);
                    modalConfirmBtn.onclick = null;
                    modalCancelBtn.onclick = null;
                    resolve(result);
                };
                const confirmHandler = () => cleanup(true);
                const cancelHandler = () => cleanup(false);
                const outsideClickHandler = e => { if (e.target === confirmModal) cleanup(false); };
                
                modalConfirmBtn.onclick = confirmHandler;
                modalCancelBtn.onclick = cancelHandler;
                confirmModal.addEventListener('click', outsideClickHandler);
            });
        }

        saveData() {
            try {
                localStorage.setItem('tireServiceData_v4', JSON.stringify(this.data));
            } catch(e) {
                console.error("Failed to save data to localStorage:", e);
                this.showToast("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–æ", "danger");
            }
        }

        updateState(updater, recordHistory = true) {
            updater(this.data);
            if (recordHistory) {
                const afterStateJSON = JSON.stringify(this.data);
                const lastStateJSON = this.historyStack.length > 0 ? JSON.stringify(this.historyStack[this.historyIndex]) : "{}";
                if (afterStateJSON !== lastStateJSON) {
                    this.recordHistory(JSON.parse(afterStateJSON));
                }
            }
            this.saveData();
            this.render();
        }

        deepClone(obj) {
            return JSON.parse(JSON.stringify(obj));
        }
        
        loadState(newState, recordHistory = true) {
            const defaultData = this.getDefaultData();
            const migratedData = this.migrateData(newState);
            this.data = { ...defaultData, ...migratedData, settings: { ...defaultData.settings, ...(migratedData.settings || {}) }};
            if (recordHistory) {
                this.historyStack = [];
                this.historyIndex = -1;
                this.recordHistory(this.deepClone(this.data));
            }
            this.render();
        }

        render() {
            this.applySettings();
            this.renderAllTables();
            this.renderServiceTemplates();
            this.renderDashboard();
            this.updateAllCalculations();
            this.updateHistoryButtons();
            this.updateSortHeaders();
            this.renderTodos();
            
            const { incomeFilter, expensesFilter, clientsFilter, debtsFilter, warehouseFilter } = this.data.settings;
            this.elements.incomeSearch.value = incomeFilter || '';
            this.elements.expensesSearch.value = expensesFilter || '';
            this.elements.clientSearch.value = clientsFilter || '';
            this.elements.debtSearch.value = debtsFilter || '';
            this.elements.warehouseSearch.value = warehouseFilter || '';
            
            this.switchTab(this.data.settings.activeTab || 'total', null, false);
        }
        
        recordHistory(stateSnapshot) {
            this.historyStack = this.historyStack.slice(0, this.historyIndex + 1);
            this.historyStack.push(stateSnapshot);
            this.historyIndex = this.historyStack.length - 1;

            if (this.historyStack.length > this.MAX_HISTORY_STATES) {
                this.historyStack.shift();
                this.historyIndex--;
            }
        }

        undo() {
            if (this.historyIndex > 0) {
                this.historyIndex--;
                this.loadState(this.deepClone(this.historyStack[this.historyIndex]), false);
            }
        }
        
        redo() {
            if (this.historyIndex < this.historyStack.length - 1) {
                this.historyIndex++;
                this.loadState(this.deepClone(this.historyStack[this.historyIndex]), false);
            }
        }

        updateHistoryButtons() {
            this.elements.undoBtn.disabled = this.historyIndex <= 0;
            this.elements.redoBtn.disabled = this.historyIndex >= this.historyStack.length - 1;
        }

        parseMoney(value) {
            const stringValue = String(value || '0').replace(',', '.').replace(/[^0-9.-]/g, '');
            const parsed = parseFloat(stringValue);
            return isNaN(parsed) ? 0 : parsed;
        }
        
        renderMoney(value) { return `${this.parseMoney(value).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, " ")} ${this.data.settings.currency || '‚ÇΩ'}`; }
        
        showToast(message, type = 'info', duration = 3000) {
            const container = get('#toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toast.setAttribute('role', 'alert');
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('hiding');
                toast.addEventListener('animationend', () => toast.remove());
            }, duration);
        }
        
        debounce(func, delay) { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; }

        handleTableLiveUpdate(event, tableKey) {
            if (!['income', 'expenses'].includes(tableKey)) return;
            const input = event.target;
            if (input.tagName !== 'INPUT' || !input.dataset.key) return;
            const row = input.closest('tr');
            if (!row) return;
        
            const changedKey = input.dataset.key;
            const countInput = row.querySelector('input[data-key="count"]');
            const priceInput = row.querySelector('input[data-key="price"]');
            const totalAmountInput = row.querySelector('input[data-key="totalAmount"]');
        
            const count = Math.max(1, parseInt(countInput.value) || 1);
            const price = this.parseMoney(priceInput.value);
            const totalAmount = this.parseMoney(totalAmountInput.value);
        
            if (changedKey === 'count' || changedKey === 'price') {
                const newTotal = count * price;
                if (this.parseMoney(totalAmountInput.value) !== newTotal) totalAmountInput.value = newTotal.toFixed(2);
            } else if (changedKey === 'totalAmount') {
                if (count > 0) {
                    const newPrice = totalAmount / count;
                    if (this.parseMoney(priceInput.value) !== newPrice) priceInput.value = newPrice.toFixed(2);
                }
            }
        }

        handleTableChangeCommit(event, tableKey) {
            const input = event.target;
            if (input.tagName !== 'INPUT') return;
            const row = input.closest('tr');
            if (!row) return;

            const { id, subId } = row.dataset;
            
            this.updateState(d => {
                const item = d[tableKey].find(i => i.id === id);
                if (!item) return;

                let targetObject = item;
                if (tableKey === 'clients' && subId) {
                    targetObject = (item.visits || []).find(v => v.id === subId);
                    if (!targetObject) return;
                }

                row.querySelectorAll('input[data-key]').forEach(inputEl => {
                    const key = inputEl.dataset.key;
                    let value = inputEl.value;
                    if(key === 'name' && d.settings.autoCapitalize) {
                        value = value.charAt(0).toUpperCase() + value.slice(1);
                    }
                    if(['price', 'totalAmount', 'amount', 'count', 'quantity'].includes(key)) {
                        value = this.parseMoney(value);
                    }
                    targetObject[key] = value;
                });
                
                if (['service', 'description'].includes(input.dataset.key)) {
                    this.applyTemplate(targetObject, d);
                }
            });
            this.showSavedToast();
        }
        
        applyTemplate(item, data) {
            const templateName = item.service || item.description;
            const templateType = item.service ? 'income' : 'expense';
            const template = (data.serviceTemplates || []).find(t => t.name === templateName && t.type === templateType);
            if (template) {
                item.price = template.price;
                item.count = template.count;
                item.totalAmount = template.price * template.count;
            }
        }
        
        async handleTableClick(event, tableKey) {
            const target = event.target;
            const row = target.closest('tr');
            if (!row) return;
            const { id } = row.dataset;

            if (target.classList.contains('btn-status')) {
                this.updateState(d => {
                    const item = d[tableKey].find(i => i.id === id);
                    if (item) item.isPaid = target.checked;
                });
                this.showSavedToast();
                return;
            }

            const button = target.closest('button');
            if (!button) return;
            
            if (button.classList.contains('stepper-btn')) {
                const input = button.closest('.number-input-wrapper').querySelector('input[type="number"]');
                const step = this.data.settings.stepperStep || 1;
                const min = input.min !== '' ? parseFloat(input.min) : -Infinity;
                let value = this.parseMoney(input.value) + (button.classList.contains('stepper-up') ? step : -step);
                if (value < min) value = min;
                input.value = value;
                input.dispatchEvent(new Event('input', { bubbles: true }));
                input.dispatchEvent(new Event('change', { bubbles: true }));
                return;
            }

            const { subId } = row.dataset;
            if (button.classList.contains('btn-delete')) await this.deleteRow(tableKey, id, subId, row);
            if (button.classList.contains('btn-expand')) this.expandClientRow(id);
        }

        addIncomeRow() { this.updateState(data => { data.income.unshift({ id: this.uuid(), date: this.getTodayDate(), price: '', count: data.settings.defaultItemCount || 1, totalAmount: 0, service: '', comment: '' }); }); }
        addExpenseRow() { this.updateState(data => { data.expenses.unshift({ id: this.uuid(), date: this.getTodayDate(), price: '', count: data.settings.defaultItemCount || 1, totalAmount: 0, description: '' }); }); }
        addClientRow() { this.updateState(data => { data.clients.unshift({ id: this.uuid(), date: this.getTodayDate(), amount: '', phone: '', plate: '', name: '', visits: [], cars:[] }); }); }
        addDebtRow() { this.updateState(data => { data.debts.unshift({ id: this.uuid(), date: this.getTodayDate(), amount: '', name: '', phone: '', comment: '', isPaid: false }); }); }
        addWarehouseRow() { this.updateState(data => { data.warehouse.unshift({ id: this.uuid(), name: '', quantity: 1 }); }); }

        async deleteRow(tableKey, id, subId, rowElement) {
            if (this.data.settings.confirmDelete && !await this.confirmAction({ text: "–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?" })) return;
            
            const animateAndRemove = () => {
                this.updateState(data => {
                    if (tableKey === 'clients' && subId) {
                        const client = data.clients.find(c => c.id === id);
                        if (client) client.visits = (client.visits || []).filter(v => v.id !== subId);
                    } else {
                        data[tableKey] = data[tableKey].filter(item => item.id !== id);
                    }
                });
            };
            
            if (this.data.settings.animations) {
                rowElement.classList.add('row-exit');
                if (tableKey === 'clients' && !subId) {
                    getAll(`#clientsTable tbody tr[data-id="${id}"]`).forEach(r => r.classList.add('row-exit'));
                }
                setTimeout(animateAndRemove, 400);
            } else {
                animateAndRemove();
            }
        }
        
        expandClientRow(clientId) {
            this.updateState(data => {
                const client = data.clients.find(c => c.id === clientId);
                if (client) {
                    if (!client.visits) client.visits = [];
                    const plate = client.plate || '';
                    client.visits.push({ id: this.uuid(), date: this.getTodayDate(), amount: '', plate: plate });
                }
            });
        }

        getNumberInputHTML(value, placeholder, min = 0, step = 1, dataKey) {
            return `<div class="number-input-wrapper"><input type="number" step="${step}" min="${min}" placeholder="${placeholder}" value="${value}" data-key="${dataKey}"><div class="stepper-controls"><button type="button" class="stepper-btn stepper-up" aria-label="–£–≤–µ–ª–∏—á–∏—Ç—å">‚ñ≤</button><button type="button" class="stepper-btn stepper-down" aria-label="–£–º–µ–Ω—å—à–∏—Ç—å">‚ñº</button></div></div>`;
        }
        
        renderAllTables() {
            ['income', 'expenses', 'clients', 'debts', 'warehouse'].forEach(key => this.sortData(key));

            const getFilteredData = (key, filter, fields) => {
                if (!filter) return this.data[key];
                const lowerFilter = filter.toLowerCase();
                return this.data[key].filter(item => {
                    const hasMatch = fields.some(field => String(item[field] || '').toLowerCase().includes(lowerFilter));
                    if (hasMatch) return true;
                    if (key === 'clients' && item.visits) {
                        return item.visits.some(visit => String(visit.plate || '').toLowerCase().includes(lowerFilter));
                    }
                    return false;
                });
            };

            const incomeData = getFilteredData('income', this.data.settings.incomeFilter, ['service', 'comment', 'date']);
            const expensesData = getFilteredData('expenses', this.data.settings.expensesFilter, ['description', 'date']);
            const clientsData = getFilteredData('clients', this.data.settings.clientsFilter, ['name', 'phone', 'plate', 'date']);
            const debtsData = getFilteredData('debts', this.data.settings.debtsFilter, ['name', 'phone', 'comment', 'date']);
            const warehouseData = getFilteredData('warehouse', this.data.settings.warehouseFilter, ['name']);
            
            this.renderTable(this.elements.incomeTableBody, incomeData, this.getIncomeRowHTML);
            this.renderTable(this.elements.expensesTableBody, expensesData, this.getExpenseRowHTML);
            this.renderClientsTable(clientsData);
            this.renderTable(this.elements.warehouseTableBody, warehouseData, this.getWarehouseRowHTML);
            const debtsToRender = this.data.settings.showPaidDebts ? debtsData : debtsData.filter(d => !d.isPaid);
            this.renderTable(this.elements.debtsTableBody, debtsToRender, this.getDebtRowHTML);
        }

        renderTable(tbody, data, rowRenderer) {
            tbody.innerHTML = data.map(item => rowRenderer.call(this, item)).join('');
        }

        renderClientsTable(clientsData) {
            this.elements.clientsTableBody.innerHTML = clientsData.flatMap(client => {
                const totalVisits = 1 + (client.visits?.length || 0);
                const clientRow = `<tr data-id="${client.id}">
                    <td><input type="date" value="${client.date || ''}" data-key="date"></td>
                    <td>${this.getNumberInputHTML(client.amount || '', '0', 0, 0.01, 'amount')}</td>
                    <td><input type="tel" placeholder="+7..." value="${client.phone || ''}" pattern="\\+?[0-9\\s\\-()]+" data-key="phone"></td>
                    <td><input type="text" placeholder="–ê000–ê–ê00" value="${client.plate || ''}" pattern="[–ê-–Ø–∞-—èA-Za-z0-9]+" data-key="plate"></td>
                    <td><input type="text" placeholder="–ò–º—è" value="${client.name || ''}" data-key="name"></td>
                    <td><input type="number" value="${totalVisits}" readonly style="background: transparent; border: none; text-align: center;"></td>
                    <td class="actions-cell">
                        <button class="btn-action btn-expand" title="–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–µ—â–µ–Ω–∏–µ">+</button>
                        <button class="btn-action btn-delete" title="–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞">&times;</button>
                    </td>
                </tr>`;

                const visitRows = (client.visits || []).sort((a, b) => (b.date || '').localeCompare(a.date || '')).map(visit =>
                    `<tr class="sub-row" data-id="${client.id}" data-sub-id="${visit.id}">
                        <td><input type="date" value="${visit.date || ''}" data-key="date"></td>
                        <td>${this.getNumberInputHTML(visit.amount || '', '0', 0, 0.01, 'amount')}</td>
                        <td>&nbsp;</td>
                        <td><input type="text" placeholder="–ì–æ—Å –Ω–æ–º–µ—Ä" value="${visit.plate || ''}" data-key="plate"></td>
                        <td colspan="2">&nbsp;</td>
                        <td class="actions-cell">
                            <button class="btn-action btn-delete" title="–£–¥–∞–ª–∏—Ç—å –ø–æ—Å–µ—â–µ–Ω–∏–µ">&times;</button>
                        </td>
                    </tr>`
                ).join('');

                return clientRow + visitRows;
            }).join('');
        }

        getIncomeRowHTML(item) {
            return `<tr data-id="${item.id}"><td><input type="date" value="${item.date || ''}" data-key="date"></td><td>${this.getNumberInputHTML(item.price || '', '0', 0, 0.01, 'price')}</td><td>${this.getNumberInputHTML(item.count || 1, '1', 1, 1, 'count')}</td><td>${this.getNumberInputHTML(item.totalAmount || '0', '0', 0, 0.01, 'totalAmount')}</td><td><input type="text" placeholder="–£—Å–ª—É–≥–∞" value="${item.service || ''}" list="service-templates-datalist-income" data-key="service"></td><td><input type="text" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" value="${item.comment || ''}" data-key="comment"></td><td class="actions-cell"><button class="btn-action btn-delete" title="–£–¥–∞–ª–∏—Ç—å">&times;</button></td></tr>`;
        }
        getExpenseRowHTML(item) {
            return `<tr data-id="${item.id}"><td><input type="date" value="${item.date || ''}" data-key="date"></td><td>${this.getNumberInputHTML(item.price || '', '0', 0, 0.01, 'price')}</td><td>${this.getNumberInputHTML(item.count || 1, '1', 1, 1, 'count')}</td><td>${this.getNumberInputHTML(item.totalAmount || '0', '0', 0, 0.01, 'totalAmount')}</td><td><input type="text" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" value="${item.description || ''}" list="service-templates-datalist-expense" data-key="description"></td><td class="actions-cell"><button class="btn-action btn-delete" title="–£–¥–∞–ª–∏—Ç—å">&times;</button></td></tr>`;
        }
        getDebtRowHTML(item) {
            const isPaid = item.isPaid || false;
            return `<tr data-id="${item.id}" class="${isPaid ? 'paid-debt' : ''}"><td><input type="date" value="${item.date || ''}" data-key="date"></td><td>${this.getNumberInputHTML(item.amount || '', '0', 0, 0.01, 'amount')}</td><td><input type="text" placeholder="–ò–º—è" value="${item.name || ''}" data-key="name"></td><td><input type="tel" placeholder="+7..." value="${item.phone || ''}" data-key="phone"></td><td><input type="text" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" value="${item.comment || ''}" data-key="comment"></td><td class="status-cell"><label class="switch"><input type="checkbox" class="btn-status" ${isPaid ? 'checked' : ''}><span class="slider round"></span></label></td><td class="actions-cell"><button class="btn-action btn-delete" title="–£–¥–∞–ª–∏—Ç—å">&times;</button></td></tr>`;
        }
        getWarehouseRowHTML(item) {
            return `<tr data-id="${item.id}"><td><input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" value="${item.name || ''}" data-key="name"></td><td style="width: 150px;">${this.getNumberInputHTML(item.quantity || 1, '1', 0, 1, 'quantity')}</td><td class="actions-cell" style="width: 100px;"><button class="btn-action btn-delete" title="–£–¥–∞–ª–∏—Ç—å">&times;</button></td></tr>`;
        }

        updateAllCalculations() {
            const todayStr = this.getTodayDate();
            const incomeTodayArr = this.data.income.filter(i => i.date === todayStr);
            const expensesTodayArr = this.data.expenses.filter(e => e.date === todayStr);
            
            const totalIncome = this.data.income.reduce((sum, item) => sum + this.parseMoney(item.totalAmount), 0);
            const totalExpenses = this.data.expenses.reduce((sum, item) => sum + this.parseMoney(item.totalAmount), 0);
            const incomeToday = incomeTodayArr.reduce((sum, item) => sum + this.parseMoney(item.totalAmount), 0);
            const expensesToday = expensesTodayArr.reduce((sum, item) => sum + this.parseMoney(item.totalAmount), 0);

            const netProfit = totalIncome - totalExpenses;
            const profitToday = incomeToday - expensesToday;
            const totalDebt = this.data.debts.reduce((sum, item) => sum + (!item.isPaid ? this.parseMoney(item.amount) : 0), 0);
            
            const servicesCount = this.data.income.reduce((acc, item) => {
                if(item.service) acc[item.service] = (acc[item.service] || 0) + 1;
                return acc;
            }, {});
            const topService = Object.entries(servicesCount).sort((a,b) => b[1] - a[1])[0];
            
            let totalVisits = 0; let totalFromClients = 0;
            const clientsData = this.data.clients.map(client => {
                const clientVisitsCount = 1 + (client.visits?.length || 0);
                const clientProfit = this.parseMoney(client.amount) + (client.visits || []).reduce((sum, visit) => sum + this.parseMoney(visit.amount), 0);
                totalVisits += clientVisitsCount;
                totalFromClients += clientProfit;
                return { id: client.id, name: client.name, phone: client.phone, profit: clientProfit, visits: clientVisitsCount, avgCheck: clientVisitsCount > 0 ? clientProfit / clientVisitsCount : 0, date: client.date };
            });

            const cardValues = {
                totalIncome: this.renderMoney(totalIncome),
                totalExpenses: this.renderMoney(totalExpenses),
                totalProfit: this.renderMoney(netProfit),
                totalDebt: this.renderMoney(totalDebt),
                avgIncome: this.renderMoney(this.data.income.length > 0 ? totalIncome / this.data.income.length : 0),
                avgExpense: this.renderMoney(this.data.expenses.length > 0 ? totalExpenses / this.data.expenses.length : 0),
                profitToday: this.renderMoney(profitToday),
                incomeToday: this.renderMoney(incomeToday),
                topService: (topService ? `${topService[0]} (${topService[1]} —Ä–∞–∑)` : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'),
                incomeCount: this.data.income.length,
                expenseCount: this.data.expenses.length,
                transactionsToday: incomeTodayArr.length + expensesTodayArr.length,
                totalClients: clientsData.length,
                totalVisits: totalVisits,
                avgClientCheck: this.renderMoney(totalVisits > 0 ? totalFromClients / totalVisits : 0),
                newClientsToday: this.data.clients.filter(c => c.date === todayStr).length,
                returningClients: clientsData.filter(c => c.visits > 1).length,
                uniqueWarehousePositions: this.data.warehouse.length,
                totalWarehouseItems: this.data.warehouse.reduce((sum, item) => sum + this.parseMoney(item.quantity), 0),
            };

            for(const [id, value] of Object.entries(cardValues)) {
                const el = get(`#${id}`);
                if(!el) continue;
                const finalValue = String(value);
                if (el.textContent !== finalValue) {
                    el.textContent = finalValue;
                    el.classList.add('updated');
                    el.addEventListener('animationend', () => el.classList.remove('updated'), { once: true });
                }
            }
            
            const totalProfitEl = get('#totalProfit');
            if(totalProfitEl) {
                totalProfitEl.classList.toggle('positive', netProfit >= 0); 
                totalProfitEl.classList.toggle('negative', netProfit < 0);
            }
            const profitTodayEl = get('#profitToday');
            if(profitTodayEl) {
                profitTodayEl.classList.toggle('positive', profitToday >= 0); 
                profitTodayEl.classList.toggle('negative', profitToday < 0);
            }
            
            this.updateSpecialClientCards(clientsData);
        }

        sanitizeHTML(str) {
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }
        
        updateSpecialClientCards(clientsData) {
            if (clientsData.length === 0) {
                this.updateClientCard('bestClientInfo', null, () => '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
                this.updateClientCard('topClientVisits', null, () => '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
                this.updateClientCard('newestClient', null, () => '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
                return;
            }

            const bestByProfit = [...clientsData].sort((a,b) => b.profit - a.profit || b.visits - a.visits)[0];
            const bestByVisits = [...clientsData].sort((a,b) => b.visits - a.visits || b.profit - a.profit)[0];
            const newestClient = [...clientsData].sort((a,b) => (b.date || '').localeCompare(a.date || ''))[0];
            
            const formatClient = c => `<span class="highlight-text">${this.sanitizeHTML(c.name || '–ë–µ–∑—ã–º—è–Ω–Ω—ã–π')}</span><br>–°—É–º–º–∞: <span class="highlight-text">${this.renderMoney(c.profit)}</span> | –ü–æ—Å–µ—â–µ–Ω–∏–π: ${c.visits}`;
            const formatVisits = c => `<span class="highlight-text">${this.sanitizeHTML(c.name || '–ë–µ–∑—ã–º—è–Ω–Ω—ã–π')}</span><br>–ü–æ—Å–µ—â–µ–Ω–∏–π: <span class="highlight-text">${c.visits}</span> | –°—É–º–º–∞: ${this.renderMoney(c.profit)}`;
            const formatNewest = c => `<span class="highlight-text">${this.sanitizeHTML(c.name || '–ë–µ–∑—ã–º—è–Ω–Ω—ã–π')}</span><br>–î–æ–±–∞–≤–ª–µ–Ω: ${c.date}`;

            this.updateClientCard('bestClientInfo', bestByProfit, formatClient);
            this.updateClientCard('topClientVisits', bestByVisits, formatVisits);
            this.updateClientCard('newestClient', newestClient, formatNewest);
        }

        updateClientCard(cardId, client, formatter) {
            const card = get(`#${cardId}Card`);
            const valueEl = get(`#${cardId}`);
            if(card && valueEl) {
                card.classList.remove('hidden');
                card.dataset.clientId = client ? client.id : '';
                valueEl.innerHTML = client ? formatter(client) : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            }
        }

        goToBestClient(clientId) {
            if (!clientId) return;
            this.switchTab('clients', () => {
                const targetRow = get(`#clientsTable tbody tr[data-id="${clientId}"]`);
                if (targetRow) {
                    targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    targetRow.classList.add('highlight');
                    setTimeout(() => targetRow.classList.remove('highlight'), 2000);
                }
            });
        }

        validateData(data) {
            return data && typeof data === 'object' && (data.settings || data.income || data.expenses || data.clients || data.debts || data.todos || data.serviceTemplates || data.warehouse);
        }
        
        migrateData(data) {
            if (!data || typeof data !== 'object') return this.getDefaultData();
            const defaultData = this.getDefaultData();
            if (data.settings && data.settings.version) delete data.settings.version;
            Object.keys(defaultData).forEach(key => {
                if (!data.hasOwnProperty(key) && Array.isArray(defaultData[key])) {
                    data[key] = [];
                }
            });
            if (!data.settings || typeof data.settings !== 'object') {
                data.settings = defaultData.settings;
            } else {
                data.settings = {...defaultData.settings, ...data.settings};
            }
            return data;
        }

        loadData() {
            let savedData = localStorage.getItem('tireServiceData_v4');
            if (savedData) {
                try { 
                    this.loadState(JSON.parse(savedData), true);
                    this.showToast('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
                } catch (e) { 
                    this.loadState(this.getDefaultData(), true);
                    this.showToast('–î–∞–Ω–Ω—ã–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã, –∑–∞–≥—Ä—É–∂–µ–Ω —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –Ω–∞–±–æ—Ä', 'danger'); 
                }
            } else { 
                this.loadState(this.getDefaultData(), true); 
            }
        }
        
        exportData(keysToExport = null) {
            let dataToExport;
            if (keysToExport) {
                dataToExport = {};
                keysToExport.forEach(key => {
                    if (this.data.hasOwnProperty(key)) {
                        dataToExport[key] = this.data[key];
                    }
                });
            } else {
                dataToExport = this.data;
            }
            const json = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tire_service_data_${this.getTodayDate()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            this.showToast('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
        }

        triggerImport(mode) {
            this.elements.importChoiceModal.classList.remove('visible');
            const fileInput = this.elements.importFileInput;
            fileInput.dataset.importMode = mode;
            fileInput.click();
        }
        
        async handleFileImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            const mode = e.target.dataset.importMode;
            const confirmText = mode === 'replace' 
                ? "–ó–ê–ú–ï–ù–ò–¢–¨ –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —Ñ–∞–π–ª–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ."
                : "–û–±—ä–µ–¥–∏–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞ —Å —Ç–µ–∫—É—â–∏–º–∏?";
            const confirmClass = mode === 'replace' ? 'danger' : 'success';

            if (this.data.settings.confirmImport && !await this.confirmAction({ text: confirmText, confirmClass: confirmClass })) {
                e.target.value = '';
                return;
            }

            this.elements.loadingOverlay.classList.add('visible');
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const parsed = JSON.parse(event.target.result);
                    if (!this.validateData(parsed)) {
                        this.showToast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –∏–º–ø–æ—Ä—Ç–∞.', 'danger');
                        return;
                    }
                    
                    const migrated = this.migrateData(parsed);

                    this.updateState(data => {
                        if (mode === 'replace') {
                            const settings = data.settings;
                            const defaultData = this.getDefaultData();
                            Object.keys(defaultData).forEach(key => {
                                if (Array.isArray(defaultData[key])) data[key] = [];
                            });
                            data.settings = settings;
                        }
                        
                        let newItemsCount = 0;
                        Object.keys(migrated).forEach(key => {
                            if (key === 'settings') {
                                data.settings = { ...data.settings, ...migrated.settings };
                            } else if (Array.isArray(data[key]) && Array.isArray(migrated[key])) {
                                if (mode === 'replace') {
                                    data[key] = migrated[key];
                                } else {
                                    const existingIds = new Set(data[key].map(i => i.id).filter(Boolean));
                                    const newItems = migrated[key].filter(newItem => newItem.id && !existingIds.has(newItem.id));
                                    if (newItems.length > 0) {
                                        data[key].push(...newItems);
                                        newItemsCount += newItems.length;
                                    }
                                }
                            }
                        });

                        if(mode === 'replace') this.showToast('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–º–µ–Ω–µ–Ω—ã.', 'success');
                        else this.showToast(`–î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã. –î–æ–±–∞–≤–ª–µ–Ω–æ ${newItemsCount} –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π.`, 'success');

                    }, true);

                } catch (err) {
                    this.showToast('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –∏–º–ø–æ—Ä—Ç–∞.', 'danger');
                    console.error(err);
                } finally {
                    this.elements.loadingOverlay.classList.remove('visible');
                    e.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        showPartialExportModal() {
            this.elements.exportChoiceModal.classList.remove('visible');
            const container = get('#partialExportCheckboxes');
            const categories = {
                income: '–î–æ—Ö–æ–¥—ã', expenses: '–†–∞—Å—Ö–æ–¥—ã', clients: '–ö–ª–∏–µ–Ω—Ç—ã',
                debts: '–î–æ–ª–≥–∏', todos: '–ó–∞–º–µ—Ç–∫–∏', serviceTemplates: '–®–∞–±–ª–æ–Ω—ã', 
                warehouse: '–°–∫–ª–∞–¥', settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏'
            };
            container.innerHTML = Object.entries(categories).map(([key, label]) => 
                `<label class="checkbox-label" style="justify-content: flex-start;"><input type="checkbox" data-export-key="${key}" checked><span>${label}</span></label>`
            ).join('');
            this.elements.partialExportModal.classList.add('visible');
        }

        exportPartialData() {
            const selectedKeys = [...getAll('#partialExportCheckboxes input:checked')].map(input => input.dataset.exportKey);
            if (selectedKeys.length === 0) {
                this.showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
                return;
            }
            this.exportData(selectedKeys);
            this.elements.partialExportModal.classList.remove('visible');
        }
        
        async clearAllData() { 
            if (await this.confirmAction({text: '–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.'})) {
                const settings = this.data.settings;
                this.updateState(data => {
                    Object.keys(data).forEach(key => { if(Array.isArray(data[key])) data[key] = [] });
                    data.settings = settings;
                }); 
                this.showToast('–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã)', 'warning');
            }
        }

        copySummary() { 
            this.updateAllCalculations(); let text = '–°–≤–æ–¥–∫–∞:\n'; 
            getAll('.summary-category').forEach(cat => { 
                text += `\n--- ${cat.querySelector('h2').textContent.replace('–ù–∞—Å—Ç—Ä–æ–∏—Ç—å', '').trim()} ---\n`; 
                cat.querySelectorAll('.result-card:not(.hidden)').forEach(card => {
                     const label = card.querySelector('.label')?.textContent.trim() || '';
                     const value = card.querySelector('.value')?.textContent.trim() || '';
                     text += `${label}: ${value.replace(/\s+/g, ' ')}\n`; 
                }); 
            }); 
            this.copyToClipboard(text.trim()); 
        }
        
        copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => this.showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!', 'success'), () => this.showToast('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'danger')); }
        
        applySettings() {
            const s = this.data.settings;
            document.body.className = '';
            if (s.theme === 'light') document.body.classList.add('light-theme');
            if (!s.animations) document.body.classList.add('animations-disabled');
            if (s.tableDensity && s.tableDensity !== 'normal') document.body.classList.add(`table-density-${s.tableDensity}`);
            if (s.fontSize && s.fontSize !== 'normal') document.body.classList.add(`font-size-${s.fontSize}`);
            document.documentElement.style.setProperty('--primary', s.primaryColor);
            
            this.elements.primaryColorPicker.value = s.primaryColor;
            this.elements.currencySymbol.value = s.currency;
            this.elements.defaultItemCountInput.value = s.defaultItemCount;
            this.elements.stepperStepInput.value = s.stepperStep;
            this.updateSettingsUI('#theme-switcher', 'theme', s.theme);
            this.updateSettingsUI('#animation-switcher', 'anim', s.animations ? 'on' : 'off');
            this.updateSettingsUI('#density-switcher', 'density', s.tableDensity);
            this.updateSettingsUI('#font-size-switcher', 'size', s.fontSize);
            this.updateSettingsUI('#confirm-delete-switcher', 'confirm', s.confirmDelete ? 'on' : 'off');
            this.updateSettingsUI('#best-client-metric-switcher', 'metric', s.bestClientMetric);
            this.updateSettingsUI('#show-paid-debts-switcher', 'show', s.showPaidDebts ? 'on' : 'off');
            this.updateSettingsUI('#auto-capitalize-switcher', 'capitalize', s.autoCapitalize ? 'on' : 'off');
            this.updateSettingsUI('#confirm-import-switcher', 'import', s.confirmImport ? 'on' : 'off');
            this.elements.defaultTabSelect.value = s.defaultTab;
            this.elements.autoBackupSelect.value = s.autoBackup;
        }
        
        updateSetting(key, value, recordHistory = true) { this.updateState(data => { data.settings[key] = value; }, recordHistory); }
        updateSettingsUI(containerId, dataAttr, value) { getAll(`${containerId} button`).forEach(btn => btn.classList.toggle('active', btn.dataset[dataAttr] == value)); }
        
        async resetSettings() { 
            if(await this.confirmAction({text: '–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?'})) {
                this.updateState(data => { data.settings = this.getDefaultData().settings; });
            }
        }

        switchTab(tabName, callback, record = true) {
            get('.tab.active')?.classList.remove('active');
            get('.tab-content.active')?.classList.remove('active');
            const newTab = get(`.tab[data-tab="${tabName}"]`);
            const newContent = get(`#${tabName}`);
            if (newTab) newTab.classList.add('active');
            if (newContent) newContent.classList.add('active');
            if (record) this.updateSetting('activeTab', tabName, false);
            if (callback) setTimeout(callback, 50);
        }

        addOrUpdateServiceTemplate() {
            const { templateName, templatePrice, templateCount, templateType } = this.elements;
            const name = templateName.value.trim();
            const price = this.parseMoney(templatePrice.value);
            const count = parseInt(templateCount.value) || 1;
            
            if (!name || price <= 0) { this.showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω—É', 'danger'); return; }
            
            const isDuplicate = this.data.serviceTemplates.some((t, i) => t.name.toLowerCase() === name.toLowerCase() && i !== this.editingTemplateIndex);
            if (isDuplicate) { this.showToast('–®–∞–±–ª–æ–Ω —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'danger'); return; }

            this.updateState(data => {
                if (this.editingTemplateIndex !== null) { data.serviceTemplates[this.editingTemplateIndex] = { name, price, count, type: templateType.value };
                } else { data.serviceTemplates.push({ name, price, count, type: templateType.value }); }
            });
            this.resetTemplateForm();
        }
        
        editServiceTemplate(index) {
            const template = this.data.serviceTemplates[index];
            if (!template) return;
            this.editingTemplateIndex = index;
            this.elements.templateName.value = template.name;
            this.elements.templatePrice.value = template.price;
            this.elements.templateCount.value = template.count;
            this.elements.templateType.value = template.type;
            this.elements.addServiceTemplateBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            this.elements.addServiceTemplateBtn.classList.add('success');
            this.elements.cancelEditTemplateBtn.style.display = 'inline-flex';
            this.elements.templateName.focus();
        }

        resetTemplateForm() {
            this.editingTemplateIndex = null;
            this.elements.templateName.value = ''; 
            this.elements.templatePrice.value = '';
            this.elements.templateCount.value = '1'; 
            this.elements.templateType.value = 'income';
            const btn = this.elements.addServiceTemplateBtn;
            btn.textContent = '–î–æ–±–∞–≤–∏—Ç—å'; 
            btn.classList.remove('success');
            this.elements.cancelEditTemplateBtn.style.display = 'none';
        }

        async deleteServiceTemplate(index) { 
            if (this.data.settings.confirmDelete && !await this.confirmAction({text: "–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω?"})) return;
            this.updateState(data => { data.serviceTemplates.splice(index, 1); }); 
        }

        renderServiceTemplates() { 
            const list = this.elements.serviceTemplatesList;
            const incomeDatalist = get('#service-templates-datalist-income');
            const expenseDatalist = get('#service-templates-datalist-expense');
            list.innerHTML = ''; incomeDatalist.innerHTML = ''; expenseDatalist.innerHTML = '';
            (this.data.serviceTemplates || []).forEach((template, index) => {
                list.innerHTML += `<div class="template-item ${template.type === 'income' ? 'income-template' : 'expense-template'}" data-index="${index}"><span>${template.name} - ${template.count}—à—Ç x ${this.renderMoney(template.price)}</span><div class="template-actions"><button class="btn-action btn-edit" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg></button><button class="btn-action btn-delete" title="–£–¥–∞–ª–∏—Ç—å">&times;</button></div></div>`;
                const option = `<option value="${template.name}">`;
                template.type === 'income' ? incomeDatalist.innerHTML += option : expenseDatalist.innerHTML += option;
            }); 
        }

        sortData(tableKey) {
            const sortState = this.data.settings.sort[tableKey];
            if (!sortState || !sortState.key) return;
            this.data[tableKey].sort((a, b) => {
                let valA = a[sortState.key], valB = b[sortState.key];
                if (['amount', 'count', 'price', 'totalAmount', 'quantity'].includes(sortState.key)) { valA = this.parseMoney(valA); valB = this.parseMoney(valB);
                } else if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = String(valB || '').toLowerCase(); }
                const result = valA < valB ? -1 : valA > valB ? 1 : 0;
                return sortState.dir === 'asc' ? result : -result;
            });
        }

        sortTable(tableKey, newKey) {
            const sortState = this.data.settings.sort[tableKey];
            const newDir = (sortState.key === newKey && sortState.dir === 'desc') ? 'asc' : 'desc';
            this.updateState(data => { data.settings.sort[tableKey] = { key: newKey, dir: newDir }; }, false);
        }

        updateSortHeaders() {
            this.elements.allSortableHeaders.forEach(th => { th.classList.remove('sort-asc', 'sort-desc'); th.setAttribute('aria-sort', 'none'); });
            Object.entries(this.data.settings.sort).forEach(([key, sortState]) => {
                if (sortState && sortState.key) {
                    const header = get(`#${key}Table th[data-sort-key="${sortState.key}"]`);
                    if (header) {
                        header.classList.add(`sort-${sortState.dir}`);
                        header.setAttribute('aria-sort', sortState.dir === 'asc' ? 'ascending' : 'descending');
                    }
                }
            });
        }
        
        renderDashboard() {
            const renderContainer = (containerId, cards, visibleKeys) => {
                const container = get(containerId);
                container.innerHTML = Object.entries(cards).map(([id, card], index) => {
                    if (!visibleKeys.includes(id)) return '';
                    const specialClass = card.specialClass || '';
                    return `<div class="result-card ${specialClass}" id="${id}Card" data-card-id="${id}" style="animation-delay: ${index*0.05}s;"><div class="label">${card.label}</div><div class="value" id="${id}">0</div></div>`;
                }).join('');
            };
            renderContainer('#dashboardCardsContainer', this.dashboardCards, this.data.settings.visibleDashboardCards);
            renderContainer('#dashboardClientCardsContainer', this.clientCards, this.data.settings.visibleClientCards);
        }

        showDashboardSettingsModal() {
            const populateCheckboxes = (containerId, cardDefs, visibleKeys) => {
                const container = get(containerId);
                container.innerHTML = Object.entries(cardDefs).map(([id, card]) => `<label class="checkbox-label"><input type="checkbox" data-card-id="${id}" ${visibleKeys.includes(id) ? 'checked' : ''}><span>${card.label}</span></label>`).join('');
            };
            populateCheckboxes('#main-cards-settings', this.dashboardCards, this.data.settings.visibleDashboardCards);
            populateCheckboxes('#client-cards-settings', this.clientCards, this.data.settings.visibleClientCards);
            this.elements.dashboardSettingsModal.classList.add('visible');
        }

        saveDashboardSettings() {
            const getSelected = (containerId) => [...getAll(`${containerId} input:checked`)].map(input => input.dataset.cardId);
            this.updateState(d => {
                d.settings.visibleDashboardCards = getSelected('#main-cards-settings');
                d.settings.visibleClientCards = getSelected('#client-cards-settings');
            });
            this.elements.dashboardSettingsModal.classList.remove('visible');
            this.showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
        }
        
        renderTodos() {
            const sortedTodos = (this.data.todos || []).sort((a,b) => a.completed - b.completed || (b.id || '').localeCompare(a.id || ''));
            this.elements.todoList.innerHTML = sortedTodos.map(todo => `<div class="todo-item ${todo.completed ? 'completed' : ''}" data-id="${todo.id}"><label class="switch" style="margin-top: 5px;"><input type="checkbox" ${todo.completed ? 'checked' : ''}><span class="slider round"></span></label><textarea class="todo-text" rows="1">${this.sanitizeHTML(todo.text)}</textarea><button class="btn-action btn-delete" title="–£–¥–∞–ª–∏—Ç—å" style="margin-top: 5px;">&times;</button></div>`).join('');
            this.elements.todoList.querySelectorAll('.todo-text').forEach(this.autoResizeTextarea);
        }
        
        addTodo() { const text = this.elements.newTodoInput.value.trim(); if(!text) return; this.updateState(d => { if(!d.todos) d.todos = []; d.todos.unshift({id: this.uuid(), text: text, completed: false }); }); this.elements.newTodoInput.value = ''; }
        handleTodoChange(textarea) { const id = textarea.closest('.todo-item').dataset.id; this.updateState(d => { const todo = d.todos.find(t => t.id === id); if(todo) todo.text = textarea.value; }); this.showSavedToast(); }
        autoResizeTextarea(textarea) { textarea.style.height = 'auto'; textarea.style.height = textarea.scrollHeight + 'px'; }
        toggleTodo(id) { this.updateState(d => { const todo = d.todos.find(t => t.id === id); if(todo) todo.completed = !todo.completed; }); this.showSavedToast(); }
        deleteTodo(id) { this.updateState(d => { d.todos = d.todos.filter(t => t.id !== id); }); }
        
        generateReport() {
            const start = this.elements.reportStartDate.value, end = this.elements.reportEndDate.value;
            if(!start || !end) { this.showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥', 'danger'); return; }
            const filteredIncome = this.data.income.filter(i => i.date >= start && i.date <= end);
            const filteredExpenses = this.data.expenses.filter(e => e.date >= start && e.date <= end);
            const totalIncome = filteredIncome.reduce((s, i) => s + this.parseMoney(i.totalAmount), 0);
            const totalExpenses = filteredExpenses.reduce((s, i) => s + this.parseMoney(i.totalAmount), 0);
            const netProfit = totalIncome - totalExpenses;
            const topService = Object.entries(filteredIncome.reduce((acc, item) => { if(item.service) acc[item.service] = (acc[item.service] || 0) + 1; return acc; }, {})).sort((a,b) => b[1] - a[1])[0];
            this.elements.reportResults.innerHTML = `<div class="report-section"><h3>–û—Ç—á–µ—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥ —Å ${start} –ø–æ ${end}</h3><div class="report-grid"><div class="report-item"><div class="report-item-label">–î–æ—Ö–æ–¥</div><div class="report-item-value positive">${this.renderMoney(totalIncome)}</div></div><div class="report-item"><div class="report-item-label">–†–∞—Å—Ö–æ–¥</div><div class="report-item-value negative">${this.renderMoney(totalExpenses)}</div></div><div class="report-item"><div class="report-item-label">–ü—Ä–∏–±—ã–ª—å</div><div class="report-item-value ${netProfit >= 0 ? 'positive' : 'negative'}">${this.renderMoney(netProfit)}</div></div><div class="report-item"><div class="report-item-label">–ö–æ–ª-–≤–æ —á–µ–∫–æ–≤</div><div class="report-item-value">${filteredIncome.length}</div></div><div class="report-item"><div class="report-item-label">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</div><div class="report-item-value">${this.renderMoney(filteredIncome.length > 0 ? totalIncome/filteredIncome.length : 0)}</div></div><div class="report-item"><div class="report-item-label">–¢–æ–ø —É—Å–ª—É–≥–∞</div><div class="report-item-value">${topService ? `${topService[0]} (${topService[1]} —Ä–∞–∑)` : '–ù–µ—Ç'}</div></div></div></div>`;
        }

        handleCalculatorInput(key) {
            let state = this.miniCalculatorState;
            if (/\d/.test(key)) { this.inputDigit(key, state); }
            else if (key === '.') { this.inputDecimal(state); }
            else if (['+', '-', '*', '/'].includes(key)) { this.handleOperator(key, state); }
            else if (key === '=') { this.handleEquals(state); }
            else if (key === 'clear') { this.resetCalculator(state); }
            else if (key === 'backspace') { this.backspace(state); }
            else if (key === 'percent') { this.handlePercent(state); }
            this.updateCalculatorDisplay();
        }
        inputDigit(digit, state) { if (state.waitingForSecondOperand) { state.displayValue = digit; state.waitingForSecondOperand = false; } else { state.displayValue = state.displayValue === '0' ? digit : state.displayValue + digit; } }
        inputDecimal(state) { if (state.waitingForSecondOperand) { state.displayValue = '0.'; state.waitingForSecondOperand = false; return; } if (!state.displayValue.includes('.')) { state.displayValue += '.'; } }
        handleOperator(nextOperator, state) {
            const { firstOperand, displayValue, operator } = state; const inputValue = parseFloat(displayValue);
            if (operator && state.waitingForSecondOperand) { state.operator = nextOperator; return; }
            if (firstOperand === null) { state.firstOperand = inputValue; } 
            else if (operator) { const result = this.calculate(firstOperand, inputValue, operator); state.displayValue = `${parseFloat(result.toFixed(7))}`; state.firstOperand = result; }
            state.waitingForSecondOperand = true; state.operator = nextOperator;
        }
        calculate(first, second, op) { if (op === '+') return first + second; if (op === '-') return first - second; if (op === '*') return first * second; if (op === '/') return second !== 0 ? first / second : '–û—à–∏–±–∫–∞'; return second; }
        handleEquals(state) { const { firstOperand, displayValue, operator } = state; if (firstOperand === null || operator === null) return; const result = this.calculate(firstOperand, parseFloat(displayValue), operator); state.displayValue = `${parseFloat(result.toFixed(7))}`; state.firstOperand = null; state.operator = null; state.waitingForSecondOperand = false; }
        resetCalculator(state) { state.displayValue = '0'; state.firstOperand = null; state.waitingForSecondOperand = false; state.operator = null; }
        backspace(state) { state.displayValue = state.displayValue.slice(0, -1) || '0'; }
        handlePercent(state) { state.displayValue = `${parseFloat(state.displayValue) / 100}`; }
        updateCalculatorDisplay() {
            const display = this.elements.miniCalcDisplay;
            let value = this.miniCalculatorState.displayValue;
            const baseFontSize = 2, threshold = 12;
            display.style.fontSize = value.length > threshold ? `${Math.max(baseFontSize/2, baseFontSize - (value.length - threshold) * 0.15)}em` : `${baseFontSize}em`;
            display.textContent = value;
        }

        toggleMiniCalc() { this.elements.miniCalcContainer.classList.toggle('visible'); }
        setupMiniCalcListeners() {
            const { miniCalcContainer, miniCalcHeader, miniCalcCloseBtn, miniCalcKeys } = this.elements;
            miniCalcCloseBtn.addEventListener('click', () => this.toggleMiniCalc());
            miniCalcKeys.addEventListener('click', e => e.target.matches('button') && this.handleCalculatorInput(e.target.dataset.key));
            let isDragging = false, offsetX, offsetY;
            miniCalcHeader.addEventListener('mousedown', e => { isDragging = true; offsetX = e.clientX - miniCalcContainer.offsetLeft; offsetY = e.clientY - miniCalcContainer.offsetTop; miniCalcContainer.style.transition = 'none'; });
            document.addEventListener('mousemove', e => { if (isDragging) { miniCalcContainer.style.left = `${e.clientX - offsetX}px`; miniCalcContainer.style.top = `${e.clientY - offsetY}px`; } });
            document.addEventListener('mouseup', () => { isDragging = false; miniCalcContainer.style.transition = ''; });
        }

        handleAutoBackup() {
            const backupSetting = this.data.settings.autoBackup;
            if (backupSetting === '0' || !backupSetting) return;
            const interval = backupSetting === 'hourly' ? 3600000 : parseInt(backupSetting) * 86400000;
            if (isNaN(interval)) return;
            const now = Date.now();
            const lastBackup = parseInt(localStorage.getItem('tireServiceBackupTimestamp_v4') || '0');
            if (now - lastBackup > interval) {
                const currentData = localStorage.getItem('tireServiceData_v4');
                if (currentData) {
                    localStorage.setItem('tireServiceBackupData_v4', currentData);
                    localStorage.setItem('tireServiceBackupTimestamp_v4', now.toString());
                    this.showToast('–°–æ–∑–¥–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è', 'info');
                }
            }
        }
        
        async saveBackupNow() {
            if (!await this.confirmAction({text: '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é? –≠—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â—É—é.', confirmClass: 'info'})) return;
            try {
                const currentData = localStorage.getItem('tireServiceData_v4');
                if (currentData) {
                    localStorage.setItem('tireServiceBackupData_v4', currentData);
                    localStorage.setItem('tireServiceBackupTimestamp_v4', Date.now().toString());
                    this.showToast('–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
                } else {
                     this.showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.', 'warning');
                }
            } catch (e) {
                this.showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏.', 'danger');
                console.error(e);
            }
        }

        async restoreFromBackup() {
            const backupData = localStorage.getItem('tireServiceBackupData_v4');
            if (!backupData) {
                this.showToast('–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'warning');
                return;
            }
            const lastBackupTimestamp = parseInt(localStorage.getItem('tireServiceBackupTimestamp_v4') || '0');
            const backupDate = new Date(lastBackupTimestamp).toLocaleString();
            if (await this.confirmAction({text: `–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –æ—Ç ${backupDate}? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω–µ–Ω—ã.`, confirmClass: 'warning'})) {
                try {
                    const parsed = JSON.parse(backupData);
                    this.loadState(parsed, true);
                    this.showToast('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ –∫–æ–ø–∏–∏', 'success');
                } catch (e) {
                    this.showToast('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: —Ñ–∞–π–ª –∫–æ–ø–∏–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω', 'danger');
                }
            }
        }

        performGlobalPhoneSearch(query) {
            const searchTerm = query.trim();
            if (!searchTerm) {
                this.elements.globalSearchResults.innerHTML = '';
                return;
            }
            const results = [];
            const cleanQuery = searchTerm.replace(/[\s-()+]/g, '');
            if (cleanQuery) {
                this.data.clients.forEach(client => {
                    const clientPhone = (client.phone || '').replace(/[\s-()+]/g, '');
                    if (clientPhone.includes(cleanQuery)) {
                        results.push({ type: 'clients', label: '–ö–ª–∏–µ–Ω—Ç', data: client });
                    }
                });
                this.data.debts.forEach(debt => {
                    const debtPhone = (debt.phone || '').replace(/[\s-()+]/g, '');
                    if (debtPhone.includes(cleanQuery)) {
                        results.push({ type: 'debts', label: '–î–æ–ª–≥', data: debt });
                    }
                });
            }
            this.renderGlobalSearchResults(results, searchTerm);
        }

        renderGlobalSearchResults(results, searchTerm) {
            const container = this.elements.globalSearchResults;
            if (results.length === 0) {
                container.innerHTML = `<div class="search-result-wrapper"><h2>–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É</h2><p style="padding: 15px 0;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p></div>`;
                return;
            }
            const highlight = (text) => this.sanitizeHTML(text).replace(new RegExp(searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'), (match) => `<mark>${match}</mark>`);
            container.innerHTML = `<div class="search-result-wrapper"><h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ –Ω–æ–º–µ—Ä—É</h2>` + results.map(res => {
                const { type, label, data } = res;
                let details = '';
                if (type === 'clients') {
                    details = `<p><strong>–ò–º—è:</strong> ${this.sanitizeHTML(data.name) || 'N/A'}</p><p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${highlight(data.phone || 'N/A')}</p><p><strong>–ì–æ—Å. –Ω–æ–º–µ—Ä:</strong> ${this.sanitizeHTML(data.plate) || 'N/A'}</p>`;
                } else if (type === 'debts') {
                    details = `<p><strong>–ö—Ç–æ –¥–æ–ª–∂–µ–Ω:</strong> ${this.sanitizeHTML(data.name) || 'N/A'}</p><p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${highlight(data.phone || 'N/A')}</p><p><strong>–°—É–º–º–∞:</strong> ${this.renderMoney(data.amount)}</p><p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${data.isPaid ? '–û–ø–ª–∞—á–µ–Ω' : '–ù–µ –æ–ø–ª–∞—á–µ–Ω'}</p>`;
                }
                return `<div class="search-result-card"><div class="search-result-header"><span class="search-result-title">${label}</span><button class="button info" data-goto-type="${type}" data-goto-id="${data.id}">–ü–µ—Ä–µ–π—Ç–∏</button></div><div class="search-result-body">${details}</div></div>`;
            }).join('') + `</div>`;
        }
        
        handleSearchResultClick(event) {
            const button = event.target.closest('button[data-goto-id]');
            if (!button) return;
            const { gotoType, gotoId } = button.dataset;
            this.switchTab(gotoType, () => {
                const targetRow = get(`#${gotoType}Table tbody tr[data-id="${gotoId}"]`);
                if (targetRow) {
                    targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    getAll(`#${gotoType}Table tbody tr`).forEach(r => r.classList.remove('highlight', 'keyboard-focus'));
                    targetRow.classList.add('highlight');
                    setTimeout(() => targetRow.classList.remove('highlight'), 2500);
                }
            });
        }
    }
    const app = new TireServiceApp();
    app.init();
});
</script>
</body>
</html>
