<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>–£—á–µ—Ç –®–∏–Ω–æ–º–æ–Ω—Ç–∞–∂–∞ Pro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Manrope:wght@400;500;600;700;800&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
    --primary: #3b82f6;
    --primary-dark: #2563eb;
    --primary-light: #60a5fa;
    --primary-glow: rgba(59, 130, 246, 0.4);
    --bg-body: #0f172a;
    --bg-card: rgba(30, 41, 59, 0.7);
    --bg-card-hover: rgba(51, 65, 85, 0.9);
    --bg-input: rgba(15, 23, 42, 0.5);
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --border: rgba(148, 163, 184, 0.15);
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --radius: 16px;
    --nav-height: 76px;
    --sidebar-width: 260px;
    --header-height: 70px;
    --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    --glass: blur(12px) saturate(160%);
    --font-scale: 1;
    --table-padding: 14px;
    --font-main: 'Inter', sans-serif;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --sidebar-bg: var(--bg-card);
}

body.design-glass {
    --bg-body: #050505;
    --bg-card: rgba(255, 255, 255, 0.03);
    --bg-card-hover: rgba(255, 255, 255, 0.08);
    --bg-input: rgba(0, 0, 0, 0.3);
    --border: rgba(255, 255, 255, 0.08);
    --glass: blur(24px) saturate(180%);
    --radius: 24px;
    --font-main: 'Outfit', sans-serif;
    --shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.5);
    background-image: 
        radial-gradient(circle at 15% 50%, rgba(var(--primary-rgb), 0.15) 0%, transparent 40%),
        radial-gradient(circle at 85% 30%, rgba(139, 92, 246, 0.15) 0%, transparent 40%),
        radial-gradient(circle at 50% 90%, rgba(16, 185, 129, 0.1) 0%, transparent 50%);
    background-color: #050505;
    background-attachment: fixed;
}

body.design-glass.light-theme {
    --bg-body: #f0f4f8;
    --bg-card: rgba(255, 255, 255, 0.65);
    --bg-card-hover: rgba(255, 255, 255, 0.85);
    --bg-input: rgba(255, 255, 255, 0.5);
    --border: rgba(50, 50, 93, 0.1);
    --text-main: #1e293b;
    --text-muted: #64748b;
    --shadow: 0 10px 40px -10px rgba(0,0,0,0.1);
    background-image: 
        radial-gradient(circle at 10% 20%, rgba(var(--primary-rgb), 0.12) 0%, transparent 50%),
        radial-gradient(circle at 90% 80%, rgba(236, 72, 153, 0.08) 0%, transparent 50%);
    background-color: #f0f4f8;
}

body.design-soft {
    --bg-body: #f3f4f6;
    --bg-card: #ffffff;
    --bg-card-hover: #f9fafb;
    --bg-input: #f3f4f6;
    --text-main: #111827;
    --text-muted: #6b7280;
    --border: #e5e7eb;
    --radius: 8px;
    --font-main: 'Manrope', sans-serif;
    --glass: none;
    --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    --sidebar-bg: #ffffff;
    --primary-glow: transparent;
}

body.design-soft.dark-theme {
    --bg-body: #0d1117;
    --bg-card: #161b22;
    --bg-card-hover: #21262d;
    --bg-input: #0d1117;
    --text-main: #c9d1d9;
    --text-muted: #8b949e;
    --border: #30363d;
    --shadow: none;
    --sidebar-bg: #161b22;
}

body.design-soft .sidebar { border-right: 1px solid var(--border); box-shadow: none; margin: 0; height: 100%; border-radius: 0; background: var(--sidebar-bg); }
body.design-soft .nav-item { border-radius: 6px; font-weight: 700; letter-spacing: -0.01em; }
body.design-soft .nav-item.active { box-shadow: none; background: var(--bg-input); color: var(--primary); border: 1px solid var(--border); }
body.design-soft .stat-card { border-radius: 8px; box-shadow: var(--shadow); border: 1px solid var(--border); }
body.design-soft .btn { border-radius: 6px; box-shadow: none; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.8rem; font-weight: 800; }
body.design-soft .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
body.design-soft .data-table-container { border-radius: 8px; border: 1px solid var(--border); box-shadow: var(--shadow); }
body.design-soft .search-input { border-radius: 6px; border: 1px solid var(--border); background: var(--bg-card); }
body.design-soft .icon-btn { border-radius: 6px; border: 1px solid var(--border); box-shadow: none; }

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
body { font-family: var(--font-main); background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; font-size: calc(14px * var(--font-scale)); transition: var(--transition); }

body.light-theme {
    --bg-body: #f8fafc;
    --bg-card: #ffffff;
    --bg-card-hover: #f1f5f9;
    --bg-input: #f1f5f9;
    --text-main: #0f172a;
    --text-muted: #64748b;
    --border: #e2e8f0;
}

body.compact-mode { --table-padding: 8px; }
body.no-anim * { animation: none !important; transition: none !important; }

::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

input, select, textarea, button { font-family: inherit; border: none; background: transparent; color: inherit; font-size: inherit; }
button { cursor: pointer; user-select: none; }

.app-container { display: flex; width: 100%; height: 100%; position: relative; z-index: 1; transition: var(--transition); }

.sidebar { width: var(--sidebar-width); background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; backdrop-filter: var(--glass); -webkit-backdrop-filter: var(--glass); z-index: 20; transition: var(--transition); flex-shrink: 0; }

body.design-glass .sidebar {
    background: linear-gradient(160deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
    border: 1px solid var(--border);
    margin: 16px;
    margin-right: 0;
    border-radius: var(--radius);
    height: calc(100% - 32px);
    box-shadow: var(--shadow);
}
body.design-glass.light-theme .sidebar { background: linear-gradient(160deg, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0.4) 100%); border: 1px solid var(--border); }

.logo-area { height: var(--header-height); display: flex; align-items: center; padding: 0 24px; font-weight: 800; font-size: 1.4rem; letter-spacing: -0.5px; color: var(--text-main); gap: 12px; border-bottom: 1px solid var(--border); transition: var(--transition); }
body.design-glass .logo-area { border-bottom: 1px solid transparent; }
body.design-soft .logo-area { border-bottom: 1px solid var(--border); }

.logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius: 12px; display: grid; place-items: center; color: white; box-shadow: 0 8px 16px var(--primary-glow); position: relative; overflow: hidden; font-size: 1.2rem; }
body.design-soft .logo-icon { border-radius: 8px; box-shadow: none; background: var(--primary); }

.nav-menu { flex: 1; overflow-y: auto; padding: 20px 16px; display: flex; flex-direction: column; gap: 6px; }
.nav-item { display: flex; align-items: center; gap: 14px; padding: 12px 16px; color: var(--text-muted); text-decoration: none; border-radius: 12px; transition: var(--transition); font-weight: 600; font-size: 0.95rem; }
.nav-item:hover { background: var(--bg-card-hover); color: var(--text-main); }
.nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px var(--primary-glow); }
body.design-glass .nav-item.active { background: linear-gradient(90deg, var(--primary), var(--primary-dark)); border: 1px solid rgba(255,255,255,0.2); }
body.design-glass.light-theme .nav-item.active { border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 8px 20px -4px var(--primary-glow); }
.nav-item svg { width: 22px; height: 22px; stroke-width: 2px; }

.main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; min-width: 0; transition: var(--transition); }
body.design-glass .main-content { padding: 16px; gap: 16px; }
body.design-soft .main-content { background: var(--bg-body); padding: 0; }

.top-header { height: var(--header-height); background: var(--bg-card); backdrop-filter: var(--glass); -webkit-backdrop-filter: var(--glass); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 32px; z-index: 10; flex-shrink: 0; transition: var(--transition); }
body.design-glass .top-header { border-radius: var(--radius); border: 1px solid var(--border); background: rgba(255,255,255,0.03); margin-bottom: 0; }
body.design-glass.light-theme .top-header { background: rgba(255,255,255,0.6); }
body.design-soft .top-header { background: var(--bg-card); border-bottom: 1px solid var(--border); box-shadow: var(--shadow); }

.header-title { font-size: 1.8rem; font-weight: 800; letter-spacing: -0.8px; display: flex; flex-direction: column; line-height: 1; }
body.design-soft .header-title { font-size: 1.4rem; letter-spacing: -0.02em; }
.header-subtitle { font-size: 0.8rem; color: var(--text-muted); font-weight: 500; letter-spacing: 0; margin-top: 4px; }
.header-actions { display: flex; gap: 12px; }

.icon-btn { width: 44px; height: 44px; border-radius: 12px; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); display: grid; place-items: center; font-size: 1.2rem; transition: var(--transition); cursor: pointer; }
.icon-btn:hover { border-color: var(--primary); color: var(--primary); background: var(--bg-card-hover); transform: translateY(-2px); }
.icon-btn:active { transform: scale(0.95); }

.content-scroll { flex: 1; overflow-y: auto; padding: 24px 32px; padding-bottom: 100px; scroll-behavior: smooth; }
body.design-glass .content-scroll { padding: 8px; padding-bottom: 20px; }
body.design-soft .content-scroll { padding: 32px; }

.tab-content { display: none; flex-direction: column; animation: fadeIn 0.4s ease forwards; }
.tab-content.active { display: flex; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px; }
.stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 24px; position: relative; overflow: hidden; transition: var(--transition); display: flex; flex-direction: column; justify-content: space-between; height: 100%; min-height: 140px; }
body.design-glass .stat-card { background: linear-gradient(145deg, rgba(255,255,255,0.07), rgba(255,255,255,0.02)); box-shadow: 0 10px 30px -5px rgba(0,0,0,0.2); }
body.design-glass.light-theme .stat-card { background: linear-gradient(145deg, rgba(255,255,255,0.9), rgba(255,255,255,0.5)); border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05); }
.stat-card:hover { transform: translateY(-4px); border-color: var(--primary-light); box-shadow: 0 15px 30px -5px rgba(0,0,0,0.2); }

.stat-icon { position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; border-radius: 10px; background: var(--bg-input); display: grid; place-items: center; color: var(--text-muted); transition: var(--transition); }
body.design-soft .stat-icon { border-radius: 6px; background: var(--bg-body); }
.stat-card:hover .stat-icon { background: var(--primary); color: white; transform: rotate(10deg); }

.stat-label { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; z-index: 2; }
.stat-value { font-size: 2.2rem; font-weight: 800; color: var(--text-main); margin-top: 8px; z-index: 2; letter-spacing: -1px; }
.stat-sub { font-size: 0.8rem; color: var(--text-muted); margin-top: 8px; display: flex; align-items: center; gap: 4px; }
.stat-sub.up { color: var(--success); }
.stat-sub.down { color: var(--danger); }

.info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; margin-top: 24px; }
.info-item { background: var(--bg-input); border-radius: 14px; padding: 16px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 4px; transition: var(--transition); }
body.design-glass .info-item { background: rgba(255,255,255,0.03); }
body.design-glass.light-theme .info-item { background: rgba(255,255,255,0.5); }
body.design-soft .info-item { background: var(--bg-card); border-radius: 8px; box-shadow: var(--shadow); }
.info-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
.info-val { font-size: 1.1rem; font-weight: 700; color: var(--text-main); }

.controls-bar { display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; align-items: center; background: var(--bg-card); padding: 12px; border-radius: 20px; border: 1px solid var(--border); flex-shrink: 0; }
body.design-glass .controls-bar { background: linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); }
body.design-glass.light-theme .controls-bar { background: rgba(255,255,255,0.6); }
body.design-soft .controls-bar { border: 1px solid var(--border); border-radius: 8px; padding: 16px; box-shadow: var(--shadow); background: var(--bg-card); }

.btn { padding: 0 24px; height: 48px; border-radius: 12px; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 10px; background: var(--primary); color: white; font-size: 0.95rem; transition: var(--transition); white-space: nowrap; border: 1px solid transparent; }
body.design-soft .btn { box-shadow: none; }
.btn:hover { filter: brightness(1.1); transform: translateY(-1px); box-shadow: 0 8px 20px var(--primary-glow); }
.btn:active { transform: scale(0.97); }
.btn.ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
.btn.ghost:hover { border-color: var(--text-main); color: var(--text-main); background: var(--bg-input); box-shadow: none; }
.btn.danger { background: var(--danger); --primary-glow: rgba(239, 68, 68, 0.4); }
.btn.warning { background: var(--warning); --primary-glow: rgba(245, 158, 11, 0.4); }
.btn.success { background: var(--success); --primary-glow: rgba(16, 185, 129, 0.4); }
.btn-sm { height: 36px; padding: 0 16px; font-size: 0.85rem; border-radius: 10px; }

.search-input { flex: 1; background: var(--bg-input); border: 1px solid transparent; padding: 0 20px; height: 48px; border-radius: 12px; color: var(--text-main); min-width: 240px; transition: var(--transition); font-weight: 500; font-size: 0.95rem; }
.search-input:focus { background: var(--bg-card); border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-glow); }

.data-table-container { flex: 1; border-radius: 20px; border: 1px solid var(--border); background: var(--bg-card); overflow: hidden; display: flex; flex-direction: column; min-height: 400px; }
body.design-glass .data-table-container { background: rgba(255,255,255,0.02); }
body.design-glass.light-theme .data-table-container { background: rgba(255,255,255,0.4); }

.data-table { width: 100%; border-collapse: collapse; text-align: left; position: relative; }
.data-table th { position: sticky; top: 0; z-index: 5; background: var(--bg-card); color: var(--text-muted); font-weight: 700; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.8px; padding: 16px var(--table-padding); border-bottom: 1px solid var(--border); cursor: pointer; user-select: none; }
.data-table th:hover { color: var(--primary); }
.data-table td { padding: var(--table-padding); border-bottom: 1px solid var(--border); vertical-align: middle; transition: background 0.1s; }
.data-table tr:hover td { background: var(--bg-card-hover); }
.data-table tr:last-child td { border-bottom: none; }

.table-input { background: transparent; border: 1px solid transparent; color: inherit; padding: 6px 10px; border-radius: 8px; width: 100%; transition: all 0.2s; font-weight: 500; }
.table-input:hover { background: var(--bg-input); }
.table-input:focus { background: var(--bg-input); border-color: var(--primary); }

.btn-trash { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); transition: all 0.2s; background: transparent; opacity: 0.6; cursor: pointer; }
.btn-trash:hover { background: rgba(239, 68, 68, 0.15); color: var(--danger); opacity: 1; transform: scale(1.1); }

.settings-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; overflow-y: auto; padding-bottom: 20px; }
.settings-group { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 28px; height: fit-content; transition: var(--transition); }
body.design-soft .settings-group { border-radius: 8px; border: 1px solid var(--border); box-shadow: var(--shadow); }
body.design-glass.light-theme .settings-group { background: rgba(255,255,255,0.6); }

.settings-group h3 { margin-bottom: 24px; color: var(--primary); font-size: 1.2rem; font-weight: 800; display: flex; align-items: center; gap: 10px; }
.setting-row { display: flex; justify-content: space-between; align-items: center; padding: 18px 0; border-bottom: 1px solid var(--border); }
.setting-row:last-child { border-bottom: none; }

.toggle-switch { position: relative; width: 52px; height: 28px; background: var(--bg-input); border-radius: 20px; cursor: pointer; transition: 0.3s; border: 1px solid var(--border); }
.toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 22px; height: 22px; background: var(--text-muted); border-radius: 50%; transition: 0.3s; transform: scale(0.8); }
.toggle-switch.active { background: var(--primary); border-color: var(--primary); }
.toggle-switch.active::after { left: 26px; background: white; transform: scale(1); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

.color-picker { display: flex; gap: 10px; }
.color-btn { width: 32px; height: 32px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; transition: transform 0.2s; position: relative; }
.color-btn.active { border-color: var(--text-main); transform: scale(1.15); }
.color-btn::after { content: ''; position: absolute; inset: 3px; border-radius: 50%; background: var(--color); }

.font-selector { display: flex; background: var(--bg-input); padding: 4px; border-radius: 10px; border: 1px solid var(--border); }
.font-btn { padding: 6px 12px; border-radius: 7px; font-size: 0.8rem; font-weight: 600; color: var(--text-muted); cursor: pointer; flex: 1; text-align: center; transition: var(--transition); }
.font-btn:hover { color: var(--text-main); }
.font-btn.active { background: var(--bg-card); color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
.modal-overlay.visible { opacity: 1; pointer-events: auto; }
.modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 28px; padding: 40px; width: 90%; max-width: 460px; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 40px 80px -20px rgba(0,0,0,0.6); }
.modal-overlay.visible .modal { transform: scale(1); }

.mini-calc { position: fixed; bottom: 40px; right: 40px; width: 300px; background: var(--bg-card); backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: 24px; z-index: 90; box-shadow: 0 30px 60px rgba(0,0,0,0.4); display: none; overflow: hidden; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.mini-calc.visible { display: block; }
.calc-header { background: var(--primary); color: white; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; cursor: move; font-weight: 700; }
.calc-display { background: rgba(0,0,0,0.1); padding: 24px; text-align: right; font-size: 2.5rem; font-weight: 300; font-family: monospace; color: var(--text-main); letter-spacing: -1px; }
.calc-pad { display: grid; grid-template-columns: repeat(4, 1fr); padding: 12px; gap: 8px; }
.calc-btn { border-radius: 14px; font-size: 1.2rem; height: 56px; background: var(--bg-input); transition: background 0.1s; color: var(--text-main); }
.calc-btn:hover { background: var(--bg-card-hover); }
.calc-btn.op { color: var(--primary); font-weight: 700; background: rgba(var(--primary-rgb), 0.1); }
.calc-btn.eq { background: var(--primary); color: white; grid-column: span 4; font-weight: 700; }

.toast { position: fixed; bottom: 30px; right: 30px; background: var(--bg-card); color: var(--text-main); padding: 16px 24px; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); z-index: 200; display: flex; align-items: center; gap: 16px; animation: slideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); border-left: 4px solid var(--success); font-weight: 600; border: 1px solid var(--border); }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

.template-editor { border: 1px solid var(--border); border-radius: 14px; padding: 16px; margin-bottom: 12px; background: var(--bg-input); }
body.design-soft .template-editor { border-radius: 8px; }
.template-inputs-row { display: flex; gap: 12px; margin-bottom: 12px; }
.template-types { display: flex; gap: 12px; margin-top: 12px; }
.checkbox-label { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; cursor: pointer; }

@media (max-width: 900px) {
    body { flex-direction: column; }
    .sidebar { width: 100%; height: auto; position: fixed; bottom: 0; left: 0; flex-direction: row; border-right: none; border-top: 1px solid var(--border); padding: 6px; z-index: 100; justify-content: space-around; }
    .nav-menu { flex-direction: row; padding: 0; gap: 4px; overflow: visible; width: 100%; justify-content: space-between; }
    .nav-item { flex-direction: column; padding: 8px 4px; font-size: 0.65rem; gap: 4px; flex: 1; justify-content: center; text-align: center; border-radius: 8px; }
    .nav-item svg { width: 20px; height: 20px; }
    .nav-item span { display: block; }
    .logo-area { display: none; }
    .main-content { padding-bottom: 80px; }
    .top-header { padding: 0 16px; height: 60px; }
    .content-scroll { padding: 16px; }
    .data-table-container { box-shadow: none; border: none; background: transparent; }
    .data-table thead { display: none; }
    .data-table tr { display: block; background: var(--bg-card); border-radius: 16px; margin-bottom: 12px; padding: 12px; border: 1px solid var(--border); }
    body.design-soft .data-table tr { border-radius: 8px; }
    .data-table td { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border: none; text-align: right; }
    .data-table td::before { content: attr(data-label); font-weight: 600; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; margin-right: 12px; }
    .table-input { text-align: right; }
    .mini-calc { bottom: 90px; right: 5%; width: 90%; }
    .controls-bar { flex-direction: column; align-items: stretch; }
    .template-inputs-row { flex-wrap: wrap; }
    #tplName { width: 100%; flex: none; }
}
</style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <div class="logo-area">
            <div class="logo-icon">P</div>
            <div>ShinaPro</div>
        </div>
        <nav class="nav-menu">
            <a class="nav-item active" data-tab="total">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                <span>–û–±–∑–æ—Ä</span>
            </a>
            <a class="nav-item" data-tab="income">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span>–î–æ—Ö–æ–¥—ã</span>
            </a>
            <a class="nav-item" data-tab="expenses">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span>–†–∞—Å—Ö–æ–¥—ã</span>
            </a>
            <a class="nav-item" data-tab="clients">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                <span>–ö–ª–∏–µ–Ω—Ç—ã</span>
            </a>
            <a class="nav-item" data-tab="warehouse">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                <span>–°–∫–ª–∞–¥</span>
            </a>
            <a class="nav-item" data-tab="debts">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span>–î–æ–ª–≥–∏</span>
            </a>
            <a class="nav-item" data-tab="settings">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066 2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            </a>
        </nav>
    </aside>

    <main class="main-content">
        <header class="top-header">
            <div class="header-title">
                <span id="page-title">–°–≤–æ–¥–∫–∞</span>
                <span class="header-subtitle" id="currentDate">–°–µ–≥–æ–¥–Ω—è</span>
            </div>
            <div class="header-actions">
                <button class="icon-btn" id="undoBtn" title="–û—Ç–º–µ–Ω–∞">‚Ü∂</button>
                <button class="icon-btn" id="redoBtn" title="–ü–æ–≤—Ç–æ—Ä">‚Ü∑</button>
                <button class="icon-btn" id="calcBtn" title="–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä">üßÆ</button>
            </div>
        </header>

        <div class="content-scroll">
            <div id="total" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
                        <div class="stat-label">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</div>
                        <div class="stat-value" id="totalProfit">0</div>
                        <div class="stat-sub up" id="marginVal">–ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å 0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg></div>
                        <div class="stat-label">–î–æ—Ö–æ–¥ —Å–µ–≥–æ–¥–Ω—è</div>
                        <div class="stat-value" id="incomeToday">0</div>
                        <div class="stat-sub" id="avgCheck">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫: 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg></div>
                        <div class="stat-label">–°–∫–ª–∞–¥</div>
                        <div class="stat-value" id="warehouseCount">0</div>
                        <div class="stat-sub" id="stockValue">–°—Ç–æ–∏–º–æ—Å—Ç—å: 0</div>
                    </div>
                </div>

                <div class="info-grid" style="margin-bottom: 30px;">
                    <div class="info-item"><span class="info-label">–†–∞—Å—Ö–æ–¥ —Å–µ–≥–æ–¥–Ω—è</span><span class="info-val" id="expenseToday">0</span></div>
                    <div class="info-item"><span class="info-label">–ù–∞–ª–æ–≥ (—Ä–∞—Å—á.)</span><span class="info-val" id="taxEst">0</span></div>
                    <div class="info-item"><span class="info-label">–ö–ª–∏–µ–Ω—Ç–æ–≤ –≤—Å–µ–≥–æ</span><span class="info-val" id="clientsCount">0</span></div>
                    <div class="info-item"><span class="info-label">–°—É–º–º–∞ –¥–æ–ª–≥–æ–≤</span><span class="info-val" style="color:var(--danger)" id="debtsTotal">0</span></div>
                    <div class="info-item"><span class="info-label">–¢–æ–ø —É—Å–ª—É–≥–∞</span><span class="info-val" id="topService">-</span></div>
                    <div class="info-item"><span class="info-label">–ü—Ä–æ–≥–Ω–æ–∑ (–º–µ—Å)</span><span class="info-val" id="projMonth">0</span></div>
                    <div class="info-item"><span class="info-label">–û–±–æ—Ä–æ—Ç —Å—Ä–µ–¥—Å—Ç–≤</span><span class="info-val" id="turnover">0</span></div>
                    <div class="info-item"><span class="info-label">–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞</span><span class="info-val" id="loadPerClient">0</span></div>
                    <div class="info-item"><span class="info-label">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span><span class="info-val" id="efficiency">0%</span></div>
                </div>

                <div class="controls-bar">
                    <button class="btn ghost" id="importBtn">–ò–º–ø–æ—Ä—Ç</button>
                    <button class="btn ghost" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
                    <button class="btn danger" id="clearBtn">–°–±—Ä–æ—Å</button>
                    <input type="text" id="globalSearch" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–π –±–∞–∑–µ...">
                </div>
                <div id="globalSearchResults"></div>
            </div>

            <div id="income" class="tab-content">
                <div class="controls-bar">
                    <button class="btn success" onclick="app.addIncomeRow()">+ –î–æ—Ö–æ–¥</button>
                    <input type="text" class="search-input" id="incomeSearch" placeholder="–ü–æ–∏—Å–∫ —É—Å–ª—É–≥–∏...">
                </div>
                <div class="data-table-container">
                    <table class="data-table" id="incomeTable">
                        <thead>
                            <tr>
                                <th width="140" onclick="app.sort('income', 'date')">–î–∞—Ç–∞</th>
                                <th onclick="app.sort('income', 'service')">–£—Å–ª—É–≥–∞</th>
                                <th width="100" onclick="app.sort('income', 'price')">–¶–µ–Ω–∞</th>
                                <th width="80">–ö–æ–ª-–≤–æ</th>
                                <th width="120" onclick="app.sort('income', 'total')">–ò—Ç–æ–≥–æ</th>
                                <th width="50"></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="expenses" class="tab-content">
                <div class="controls-bar">
                    <button class="btn danger" onclick="app.addExpenseRow()">+ –†–∞—Å—Ö–æ–¥</button>
                    <input type="text" class="search-input" id="expenseSearch" placeholder="–ü–æ–∏—Å–∫ —Ä–∞—Å—Ö–æ–¥–∞...">
                </div>
                <div class="data-table-container">
                    <table class="data-table" id="expensesTable">
                        <thead>
                            <tr>
                                <th width="140" onclick="app.sort('expenses', 'date')">–î–∞—Ç–∞</th>
                                <th onclick="app.sort('expenses', 'desc')">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                <th width="100" onclick="app.sort('expenses', 'price')">–¶–µ–Ω–∞</th>
                                <th width="80">–ö–æ–ª-–≤–æ</th>
                                <th width="120" onclick="app.sort('expenses', 'total')">–ò—Ç–æ–≥–æ</th>
                                <th width="50"></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="clients" class="tab-content">
                <div class="controls-bar">
                    <button class="btn" onclick="app.addClientRow()">+ –ö–ª–∏–µ–Ω—Ç</button>
                    <input type="text" class="search-input" id="clientSearch" placeholder="–ò–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –∞–≤—Ç–æ...">
                </div>
                <div class="data-table-container">
                    <table class="data-table" id="clientsTable">
                        <thead>
                            <tr>
                                <th width="140">–î–∞—Ç–∞</th>
                                <th>–ò–º—è</th>
                                <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                <th>–ê–≤—Ç–æ</th>
                                <th width="80">–í–∏–∑–∏—Ç—ã</th>
                                <th width="50"></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="warehouse" class="tab-content">
                <div class="controls-bar">
                    <button class="btn warning" onclick="app.addWarehouseRow()">+ –¢–æ–≤–∞—Ä</button>
                    <input type="text" class="search-input" id="warehouseSearch" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞...">
                </div>
                <div class="data-table-container">
                    <table class="data-table" id="warehouseTable">
                        <thead>
                            <tr>
                                <th onclick="app.sort('warehouse', 'name')">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th width="120" onclick="app.sort('warehouse', 'price')">–ó–∞–∫—É–ø–∫–∞</th>
                                <th width="100" onclick="app.sort('warehouse', 'qty')">–û—Å—Ç–∞—Ç–æ–∫</th>
                                <th width="50"></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="debts" class="tab-content">
                <div class="controls-bar">
                    <button class="btn danger" onclick="app.addDebtRow()">+ –î–æ–ª–≥</button>
                    <input type="text" class="search-input" id="debtSearch" placeholder="–ü–æ–∏—Å–∫ –¥–æ–ª–∂–Ω–∏–∫–∞...">
                </div>
                <div class="data-table-container">
                    <table class="data-table" id="debtsTable">
                        <thead>
                            <tr>
                                <th width="140">–î–∞—Ç–∞</th>
                                <th>–ò–º—è</th>
                                <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                <th width="120">–°—É–º–º–∞</th>
                                <th width="120">–°—Ç–∞—Ç—É—Å</th>
                                <th width="50"></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="settings" class="tab-content">
                <div class="settings-container">
                    <div class="settings-group">
                        <h3>üé® –í–Ω–µ—à–Ω–∏–π –≤–∏–¥</h3>
                        <div class="setting-row">
                            <span>–î–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</span>
                            <select class="table-input" id="designSelect" style="width:auto; text-align:right;">
                                <option value="default">–°—Ç–∞–Ω–¥–∞—Ä—Ç</option>
                                <option value="glass">Glass Future</option>
                                <option value="soft">Soft Pro</option>
                            </select>
                        </div>
                        <div class="setting-row">
                            <span>–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                            <div class="toggle-switch active" id="themeToggle"></div>
                        </div>
                        <div class="setting-row">
                            <span>–†–∞–∑–º–µ—Ä –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</span>
                            <div class="font-selector">
                                <div class="font-btn" data-val="0.9">–ú–∏–Ω.</div>
                                <div class="font-btn active" data-val="1">–°—Ä–µ–¥.</div>
                                <div class="font-btn" data-val="1.1">–ú–∞–∫—Å.</div>
                            </div>
                        </div>
                         <div class="setting-row">
                            <span>–ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã</span>
                            <div class="toggle-switch active" id="animToggle"></div>
                        </div>
                         <div class="setting-row">
                            <span>–ö–æ–º–ø–∞–∫—Ç–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</span>
                            <div class="toggle-switch" id="compactToggle"></div>
                        </div>
                        <div class="setting-row">
                            <span>–¶–≤–µ—Ç –∞–∫—Ü–µ–Ω—Ç–∞</span>
                            <div class="color-picker" id="colorPicker">
                                <div class="color-btn" data-color="#3b82f6" style="--color: #3b82f6"></div>
                                <div class="color-btn" data-color="#8b5cf6" style="--color: #8b5cf6"></div>
                                <div class="color-btn" data-color="#10b981" style="--color: #10b981"></div>
                                <div class="color-btn" data-color="#f59e0b" style="--color: #f59e0b"></div>
                                <div class="color-btn" data-color="#ec4899" style="--color: #ec4899"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h3>‚öôÔ∏è –°–∏—Å—Ç–µ–º–∞</h3>
                        <div class="setting-row">
                            <span>–í–∞–ª—é—Ç–∞</span>
                            <input type="text" class="table-input" id="currencyInput" value="‚ÇΩ" style="width: 50px; text-align: center; background: var(--bg-input);">
                        </div>
                        <div class="setting-row">
                            <span>–ü–æ–∑–∏—Ü–∏—è –≤–∞–ª—é—Ç—ã</span>
                            <select class="table-input" id="currencyPosSelect" style="width:auto; text-align:right;">
                                <option value="right">100 ‚ÇΩ</option>
                                <option value="left">‚ÇΩ 100</option>
                            </select>
                        </div>
                        <div class="setting-row">
                            <span>–ù–∞–ª–æ–≥ (%)</span>
                            <input type="number" class="table-input" id="taxRateInput" placeholder="0" style="width: 60px; text-align: center;">
                        </div>
                        <div class="setting-row">
                            <span>–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã</span>
                            <select class="table-input" id="dateFormatSelect" style="width:auto; text-align:right;">
                                <option value="ru">–î–î.–ú–ú.–ì–ì–ì–ì</option>
                                <option value="iso">–ì–ì–ì–ì-–ú–ú-–î–î</option>
                            </select>
                        </div>
                         <div class="setting-row">
                            <span>–ö—Ä–∏—Ç–∏—á. –æ—Å—Ç–∞—Ç–æ–∫ —Å–∫–ª–∞–¥–∞</span>
                            <input type="number" class="table-input" id="lowStockInput" placeholder="5" style="width: 60px; text-align: center;">
                        </div>
                        <div class="setting-row">
                            <span>–û–∫—Ä—É–≥–ª—è—Ç—å —Å—É–º–º—ã</span>
                            <div class="toggle-switch" id="roundToggle"></div>
                        </div>
                        <div class="setting-row">
                            <span>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–æ–ø–µ–π–∫–∏</span>
                            <div class="toggle-switch active" id="decimalsToggle"></div>
                        </div>
                         <div class="setting-row">
                            <span>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</span>
                            <div class="toggle-switch active" id="confirmToggle"></div>
                        </div>
                    </div>

                    <div class="settings-group" style="grid-column: 1 / -1;">
                        <h3>üìã –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —à–∞–±–ª–æ–Ω–æ–≤</h3>
                        <div class="template-editor">
                            <div class="template-inputs-row">
                                <input type="text" id="tplName" class="search-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ / —Ç–æ–≤–∞—Ä–∞" style="flex-grow:1;">
                                <input type="number" id="tplPrice" class="search-input" placeholder="–¶–µ–Ω–∞" style="width: 100px; flex:none;">
                                <input type="number" id="tplQty" class="search-input" placeholder="–ö–æ–ª-–≤–æ" style="width: 80px; flex:none;" value="1">
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                                <div class="template-types">
                                    <label class="checkbox-label"><input type="checkbox" id="tplUseInc" checked> –î–æ—Ö–æ–¥—ã</label>
                                    <label class="checkbox-label"><input type="checkbox" id="tplUseExp"> –†–∞—Å—Ö–æ–¥—ã</label>
                                    <label class="checkbox-label"><input type="checkbox" id="tplUseWh"> –°–∫–ª–∞–¥</label>
                                </div>
                                <button class="btn success btn-sm" onclick="app.addTemplate()">–î–æ–±–∞–≤–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
                            </div>
                        </div>
                        <div id="templateList" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:10px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div class="mini-calc" id="miniCalc">
    <div class="calc-header" id="calcHeader">
        <span>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</span>
        <span id="closeCalc" style="cursor:pointer;opacity:0.8">‚úï</span>
    </div>
    <div class="calc-display" id="calcDisplay">0</div>
    <div class="calc-pad">
        <button class="calc-btn" onclick="calc.clear()">C</button>
        <button class="calc-btn op" onclick="calc.op('/')">√∑</button>
        <button class="calc-btn op" onclick="calc.op('*')">√ó</button>
        <button class="calc-btn" onclick="calc.del()">‚å´</button>
        <button class="calc-btn" onclick="calc.num(7)">7</button>
        <button class="calc-btn" onclick="calc.num(8)">8</button>
        <button class="calc-btn" onclick="calc.num(9)">9</button>
        <button class="calc-btn op" onclick="calc.op('-')">-</button>
        <button class="calc-btn" onclick="calc.num(4)">4</button>
        <button class="calc-btn" onclick="calc.num(5)">5</button>
        <button class="calc-btn" onclick="calc.num(6)">6</button>
        <button class="calc-btn op" onclick="calc.op('+')">+</button>
        <button class="calc-btn" onclick="calc.num(1)">1</button>
        <button class="calc-btn" onclick="calc.num(2)">2</button>
        <button class="calc-btn" onclick="calc.num(3)">3</button>
        <button class="calc-btn eq" onclick="calc.eq()">=</button>
        <button class="calc-btn" onclick="calc.num(0)" style="grid-column: span 2">0</button>
        <button class="calc-btn" onclick="calc.dot()">.</button>
    </div>
</div>

<div class="modal-overlay" id="confirmModal">
    <div class="modal">
        <h2 style="font-size:1.5rem; margin-bottom:10px;">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h2>
        <p style="color:var(--text-muted); margin-bottom:30px;">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?</p>
        <div style="display:flex; justify-content:flex-end; gap:16px;">
            <button class="btn ghost" onclick="app.closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn danger" id="confirmBtnAction">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<div class="toast-container" id="toastArea"></div>
<input type="file" id="importFile" hidden accept=".json">
<datalist id="listIncome"></datalist>
<datalist id="listExpense"></datalist>
<datalist id="listWarehouse"></datalist>

<script>
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const uuid = () => 'id' + Date.now().toString(36) + Math.random().toString(36).substr(2);
const safeFloat = (v) => { const n = parseFloat(v); return isNaN(n) ? 0 : n; };

const calc = {
    curr: '0', prev: null, opVar: null,
    num(n) { this.curr = this.curr === '0' ? String(n) : this.curr + n; this.upd(); },
    dot() { if(!this.curr.includes('.')) this.curr += '.'; this.upd(); },
    op(o) { this.prev = this.curr; this.curr = ''; this.opVar = o; },
    eq() { 
        if(!this.prev || !this.opVar) return;
        const a = safeFloat(this.prev), b = safeFloat(this.curr || this.prev);
        let res = 0;
        if(this.opVar==='+') res = a+b;
        else if(this.opVar==='-') res = a-b;
        else if(this.opVar==='*') res = a*b;
        else if(this.opVar==='/') res = b !== 0 ? a/b : 0;
        this.curr = String(Math.round(res*10000)/10000); this.prev = null; this.opVar = null; this.upd(); 
    },
    clear() { this.curr='0'; this.prev=null; this.opVar=null; this.upd(); },
    del() { this.curr = this.curr.length > 1 ? this.curr.slice(0,-1) : '0'; this.upd(); },
    upd() { $('#calcDisplay').textContent = this.curr; }
};

class App {
    constructor() {
        try {
            const stored = localStorage.getItem('tireData');
            this.data = stored ? JSON.parse(stored) : this.getDefaultData();
            if(Array.isArray(this.data.templates) && typeof this.data.templates[0] === 'object' && !this.data.templates[0].types) {
                this.data.templates = this.data.templates.map(t => ({...t, types: ['income']}));
            }
        } catch (e) {
            this.data = this.getDefaultData();
        }
        
        const d = this.getDefaultData();
        this.data.settings = { ...d.settings, ...this.data.settings };
        if(this.data.settings.decimals === undefined) this.data.settings.decimals = true;
        if(this.data.settings.dateFormat === undefined) this.data.settings.dateFormat = 'ru';
        
        this.history = [];
        this.historyStep = -1;
        this.currentSort = { key: null, dir: 1 };
        this.init();
    }

    getDefaultData() {
        return {
            income: [], expenses: [], clients: [], warehouse: [], debts: [], templates: [], 
            settings: { 
                theme: 'dark', currency: '‚ÇΩ', confirm: true, color: '#3b82f6', 
                scale: '1', anim: true, compact: false, currencyPos: 'right', 
                design: 'glass', taxRate: 6, lowStock: 5, round: false, decimals: true, dateFormat: 'ru' 
            }
        };
    }

    init() {
        this.applySettings();
        this.renderAll();
        this.setupListeners();
        this.setupDraggable();
        this.updateDate();
        this.saveState(true); 
    }

    updateDate() {
        const d = new Date();
        const opts = { weekday: 'long', day: 'numeric', month: 'long' };
        $('#currentDate').textContent = d.toLocaleDateString('ru-RU', opts);
    }

    saveState(skipHistory = false) {
        if (!skipHistory) {
            if(this.historyStep < this.history.length - 1) {
                this.history = this.history.slice(0, this.historyStep + 1);
            }
            this.history.push(JSON.stringify(this.data));
            if(this.history.length > 50) this.history.shift();
            else this.historyStep++;
        } else if (this.history.length === 0) {
            this.history.push(JSON.stringify(this.data));
            this.historyStep = 0;
        }
        this.persist();
    }

    persist() {
        try {
            localStorage.setItem('tireData', JSON.stringify(this.data));
            this.updateDashboard();
            this.updateDataLists();
        } catch (e) {
            this.showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!');
        }
    }

    undo() {
        if(this.historyStep > 0) {
            this.historyStep--;
            this.data = JSON.parse(this.history[this.historyStep]);
            this.renderAll();
            this.persist();
            this.showToast('–û—Ç–º–µ–Ω–µ–Ω–æ');
        }
    }

    redo() {
        if(this.historyStep < this.history.length - 1) {
            this.historyStep++;
            this.data = JSON.parse(this.history[this.historyStep]);
            this.renderAll();
            this.persist();
            this.showToast('–ü–æ–≤—Ç–æ—Ä–µ–Ω–æ');
        }
    }

    applySettings() {
        const s = this.data.settings;
        document.body.className = `${s.design === 'glass' ? 'design-glass' : s.design === 'soft' ? 'design-soft' : ''} ${s.theme === 'light' ? 'light-theme' : 'dark-theme'} ${s.compact ? 'compact-mode' : ''} ${!s.anim ? 'no-anim' : ''}`;
        
        $('#themeToggle').classList.toggle('active', s.theme === 'dark');
        $('#confirmToggle').classList.toggle('active', s.confirm);
        $('#animToggle').classList.toggle('active', s.anim);
        $('#compactToggle').classList.toggle('active', s.compact);
        $('#roundToggle').classList.toggle('active', s.round);
        $('#decimalsToggle').classList.toggle('active', s.decimals);
        
        $('#currencyInput').value = s.currency;
        $('#currencyPosSelect').value = s.currencyPos;
        $('#dateFormatSelect').value = s.dateFormat;
        $('#designSelect').value = s.design;
        $('#taxRateInput').value = s.taxRate;
        $('#lowStockInput').value = s.lowStock;

        $$('.font-btn').forEach(b => b.classList.toggle('active', b.dataset.val === s.scale));
        document.documentElement.style.setProperty('--primary', s.color);
        const r = parseInt(s.color.substr(1,2), 16), g = parseInt(s.color.substr(3,2), 16), b = parseInt(s.color.substr(5,2), 16);
        document.documentElement.style.setProperty('--primary-rgb', `${r}, ${g}, ${b}`);
        document.documentElement.style.setProperty('--font-scale', s.scale);

        $$('.color-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.color === s.color));
    }

    formatMoney(amount) {
        let val = safeFloat(amount);
        if(this.data.settings.round) val = Math.round(val);
        const fmtOpts = this.data.settings.decimals ? {minimumFractionDigits: 2, maximumFractionDigits: 2} : {minimumFractionDigits: 0, maximumFractionDigits: 0};
        const fmt = val.toLocaleString('ru-RU', fmtOpts);
        const c = this.data.settings.currency;
        return this.data.settings.currencyPos === 'left' ? `${c} ${fmt}` : `${fmt} ${c}`;
    }

    formatDate(dateStr) {
        if(!dateStr) return '';
        if(this.data.settings.dateFormat === 'iso') return dateStr;
        const [y, m, d] = dateStr.split('-');
        return `${d}.${m}.${y}`;
    }

    renderAll() {
        this.renderTable('income', this.data.income);
        this.renderTable('expenses', this.data.expenses);
        this.renderClients();
        this.renderTable('warehouse', this.data.warehouse);
        this.renderDebts();
        this.renderTemplates();
        this.updateDashboard();
    }

    updateDashboard() {
        const today = new Date().toISOString().slice(0,10);
        const incToday = this.data.income.filter(i => i.date === today).reduce((a,b) => a + safeFloat(b.total), 0);
        const expToday = this.data.expenses.filter(e => e.date === today).reduce((a,b) => a + safeFloat(b.total), 0);
        
        const totalInc = this.data.income.reduce((a,b) => a + safeFloat(b.total), 0);
        const totalExp = this.data.expenses.reduce((a,b) => a + safeFloat(b.total), 0);
        const netProfit = totalInc - totalExp;
        const debts = this.data.debts.filter(d => !d.paid).reduce((a,b) => a + safeFloat(b.amount), 0);

        const avgCheck = this.data.income.length ? totalInc / this.data.income.length : 0;
        const margin = totalInc ? ((totalInc - totalExp) / totalInc) * 100 : 0;
        const tax = netProfit > 0 ? netProfit * (this.data.settings.taxRate / 100) : 0;
        
        const dates = [...new Set(this.data.income.map(i => i.date))];
        const daysActive = dates.length || 1;
        const projected = (totalInc / daysActive) * 30;

        const stockVal = this.data.warehouse.reduce((a,b) => a + (safeFloat(b.price) * safeFloat(b.qty)), 0);
        const totalTurnover = totalInc + totalExp;
        const loadPerClient = this.data.clients.length ? totalInc / this.data.clients.length : 0;
        const efficiency = totalExp ? (totalInc / totalExp) * 100 : totalInc > 0 ? 100 : 0;

        const serviceCounts = {};
        this.data.income.forEach(i => serviceCounts[i.service] = (serviceCounts[i.service]||0) + 1);
        const topSvc = Object.entries(serviceCounts).sort((a,b) => b[1]-a[1])[0];
        
        const topCli = this.data.clients.sort((a,b) => (b.visits||0) - (a.visits||0))[0];

        $('#totalProfit').textContent = this.formatMoney(netProfit);
        $('#incomeToday').textContent = this.formatMoney(incToday);
        $('#expenseToday').textContent = this.formatMoney(expToday);
        $('#warehouseCount').textContent = this.data.warehouse.reduce((a,b)=>a+safeFloat(b.qty), 0);
        $('#stockValue').textContent = `‚âà ${this.formatMoney(stockVal)}`;
        $('#clientsCount').textContent = this.data.clients.length;
        $('#debtsTotal').textContent = this.formatMoney(debts);
        
        $('#avgCheck').textContent = `–°—Ä. —á–µ–∫: ${this.formatMoney(avgCheck)}`;
        $('#marginVal').textContent = `–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å: ${Math.round(margin)}%`;
        $('#taxEst').textContent = this.formatMoney(tax);
        $('#topService').textContent = topSvc ? `${topSvc[0]} (${topSvc[1]})` : '-';
        $('#projMonth').textContent = this.formatMoney(projected);
        
        $('#turnover').textContent = this.formatMoney(totalTurnover);
        $('#loadPerClient').textContent = this.formatMoney(loadPerClient);
        $('#efficiency').textContent = `${Math.round(efficiency)}%`;
    }

    updateDataLists() {
        const fill = (id, type) => {
            const list = $(`#${id}`);
            if(list) list.innerHTML = this.data.templates.filter(t => t.types.includes(type)).map(t => `<option value="${t.name}">`).join('');
        };
        fill('listIncome', 'income');
        fill('listExpense', 'expense');
        fill('listWarehouse', 'warehouse');
    }

    renderTable(type, dataArr) {
        if(type === 'clients' || type === 'debts') return;
        const tbody = $(`#${type}Table tbody`);
        const searchInput = $(`#${type === 'income' ? 'income' : type === 'expenses' ? 'expense' : 'warehouse'}Search`);
        const term = searchInput ? searchInput.value.toLowerCase() : '';
        const isIso = this.data.settings.dateFormat === 'iso';
        
        const html = dataArr.filter(item => Object.values(item).some(v => String(v).toLowerCase().includes(term))).map((item) => {
            if(type === 'warehouse') {
                const isLow = safeFloat(item.qty) <= this.data.settings.lowStock;
                return `
                <tr data-id="${item.id}" style="${isLow ? 'border-left:3px solid var(--warning)' : ''}">
                    <td data-label="–ù–∞–∑–≤–∞–Ω–∏–µ"><input class="table-input" value="${item.name}" onchange="app.update('${type}', '${item.id}', 'name', this.value)" placeholder="–¢–æ–≤–∞—Ä"></td>
                    <td data-label="–ó–∞–∫—É–ø–∫–∞"><input type="number" class="table-input" value="${item.price}" onchange="app.update('${type}', '${item.id}', 'price', this.value)" placeholder="0"></td>
                    <td data-label="–û—Å—Ç–∞—Ç–æ–∫"><input type="number" class="table-input" value="${item.qty}" onchange="app.update('${type}', '${item.id}', 'qty', this.value)" style="${isLow?'color:var(--warning);font-weight:bold':''}"></td>
                    <td data-label="–î–µ–π—Å—Ç–≤–∏—è"><button class="btn-trash" onclick="app.del('${type}', '${item.id}')">${this.getTrashIcon()}</button></td>
                </tr>`;
            }
            const isInc = type === 'income';
            return `
            <tr data-id="${item.id}">
                <td data-label="–î–∞—Ç–∞"><input type="date" class="table-input" value="${item.date}" onchange="app.update('${type}', '${item.id}', 'date', this.value)"></td>
                <td data-label="${isInc?'–£—Å–ª—É–≥–∞':'–û–ø–∏—Å–∞–Ω–∏–µ'}"><input type="text" list="${isInc?'listIncome':'listExpense'}" class="table-input" value="${isInc?item.service:item.desc}" onchange="app.update('${type}', '${item.id}', '${isInc?'service':'desc'}', this.value)" placeholder="..."></td>
                <td data-label="–¶–µ–Ω–∞"><input type="number" class="table-input" value="${item.price}" onchange="app.updateCalc('${type}', '${item.id}', 'price', this.value)"></td>
                <td data-label="–ö–æ–ª-–≤–æ"><input type="number" class="table-input" value="${item.qty}" onchange="app.updateCalc('${type}', '${item.id}', 'qty', this.value)"></td>
                <td data-label="–ò—Ç–æ–≥–æ"><input type="text" class="table-input" value="${this.formatMoney(item.total).replace(/[^0-9.,]/g,'')}" readonly style="opacity:0.8; font-weight:700; border:none; color:var(--primary);"></td>
                <td data-label="–î–µ–π—Å—Ç–≤–∏—è"><button class="btn-trash" onclick="app.del('${type}', '${item.id}')">${this.getTrashIcon()}</button></td>
            </tr>`;
        }).join('');
        if (tbody.innerHTML !== html) tbody.innerHTML = html;
    }

    renderClients() {
        const tbody = $('#clientsTable tbody');
        const term = $('#clientSearch').value.toLowerCase();
        const html = this.data.clients.filter(c => (c.name+c.phone+c.plate).toLowerCase().includes(term)).map((c) => `
            <tr data-id="${c.id}">
                <td data-label="–î–∞—Ç–∞"><input type="date" class="table-input" value="${c.date}" onchange="app.update('clients', '${c.id}', 'date', this.value)"></td>
                <td data-label="–ò–º—è"><input class="table-input" value="${c.name}" onchange="app.update('clients', '${c.id}', 'name', this.value)"></td>
                <td data-label="–¢–µ–ª–µ—Ñ–æ–Ω"><input class="table-input" value="${c.phone}" onchange="app.update('clients', '${c.id}', 'phone', this.value)"></td>
                <td data-label="–ê–≤—Ç–æ"><input class="table-input" value="${c.plate}" onchange="app.update('clients', '${c.id}', 'plate', this.value)"></td>
                <td data-label="–í–∏–∑–∏—Ç—ã"><span style="font-weight:700; color:var(--primary)">${c.visits || 1}</span></td>
                <td data-label="–î–µ–π—Å—Ç–≤–∏—è"><button class="btn-trash" onclick="app.del('clients', '${c.id}')">${this.getTrashIcon()}</button></td>
            </tr>
        `).join('');
        if (tbody.innerHTML !== html) tbody.innerHTML = html;
    }

    renderDebts() {
        const tbody = $('#debtsTable tbody');
        const term = $('#debtSearch').value.toLowerCase();
        const html = this.data.debts.filter(d => (d.name+d.phone).toLowerCase().includes(term)).map((d) => `
            <tr style="${d.paid ? 'opacity:0.5' : ''}" data-id="${d.id}">
                <td data-label="–î–∞—Ç–∞"><input type="date" class="table-input" value="${d.date}" onchange="app.update('debts', '${d.id}', 'date', this.value)"></td>
                <td data-label="–ò–º—è"><input class="table-input" value="${d.name}" onchange="app.update('debts', '${d.id}', 'name', this.value)"></td>
                <td data-label="–¢–µ–ª–µ—Ñ–æ–Ω"><input class="table-input" value="${d.phone}" onchange="app.update('debts', '${d.id}', 'phone', this.value)"></td>
                <td data-label="–°—É–º–º–∞"><input type="number" class="table-input" value="${d.amount}" onchange="app.update('debts', '${d.id}', 'amount', this.value)"></td>
                <td data-label="–°—Ç–∞—Ç—É—Å"><button class="btn-sm ${d.paid?'success':'danger'}" style="width:100%; height:30px; font-size:0.7rem;" onclick="app.toggleDebt('${d.id}')">${d.paid?'–û–ø–ª–∞—á–µ–Ω':'–î–æ–ª–≥'}</button></td>
                <td data-label="–î–µ–π—Å—Ç–≤–∏—è"><button class="btn-trash" onclick="app.del('debts', '${d.id}')">${this.getTrashIcon()}</button></td>
            </tr>
        `).join('');
        if (tbody.innerHTML !== html) tbody.innerHTML = html;
    }

    renderTemplates() {
        const c = {income: '–î–æ—Ö–æ–¥', expense: '–†–∞—Å—Ö–æ–¥', warehouse: '–°–∫–ª–∞–¥'};
        $('#templateList').innerHTML = this.data.templates.map((t, idx) => `
            <div style="background:var(--bg-input); padding:10px; border-radius:12px; display:flex; flex-direction:column; gap:4px; position:relative; border:1px solid var(--border);">
                <div style="font-weight:700;">${t.name}</div>
                <div style="font-size:0.8rem; color:var(--text-muted);">${t.qty} —à—Ç ‚Ä¢ ${this.formatMoney(t.price)}</div>
                <div style="font-size:0.7rem; display:flex; gap:4px; flex-wrap:wrap;">
                    ${t.types.map(x => `<span style="background:var(--bg-card); padding:2px 6px; border-radius:4px;">${c[x]}</span>`).join('')}
                </div>
                <button onclick="app.delTemplate(${idx})" style="position:absolute; top:8px; right:8px; color:var(--danger); background:none; border:none; cursor:pointer;">‚úï</button>
            </div>
        `).join('');
    }

    addIncomeRow() { this.data.income.unshift({ id: uuid(), date: new Date().toISOString().slice(0,10), service: '', price: 0, qty: 1, total: 0 }); this.renderTable('income', this.data.income); this.saveState(); }
    addExpenseRow() { this.data.expenses.unshift({ id: uuid(), date: new Date().toISOString().slice(0,10), desc: '', price: 0, qty: 1, total: 0 }); this.renderTable('expenses', this.data.expenses); this.saveState(); }
    addClientRow() { this.data.clients.unshift({ id: uuid(), date: new Date().toISOString().slice(0,10), name: '', phone: '', plate: '', visits: 1 }); this.renderClients(); this.saveState(); }
    addWarehouseRow() { this.data.warehouse.unshift({ id: uuid(), name: '', qty: 0, price: 0 }); this.renderTable('warehouse', this.data.warehouse); this.saveState(); }
    addDebtRow() { this.data.debts.unshift({ id: uuid(), date: new Date().toISOString().slice(0,10), name: '', phone: '', amount: 0, paid: false }); this.renderDebts(); this.saveState(); }
    
    addTemplate() { 
        const name = $('#tplName').value.trim();
        const price = safeFloat($('#tplPrice').value);
        const qty = safeFloat($('#tplQty').value) || 1;
        const types = [];
        if($('#tplUseInc').checked) types.push('income');
        if($('#tplUseExp').checked) types.push('expense');
        if($('#tplUseWh').checked) types.push('warehouse');

        if(name && types.length) {
            this.data.templates.push({ name, price, qty, types });
            $('#tplName').value = ''; $('#tplPrice').value = '';
            this.renderTemplates(); this.saveState();
            this.showToast('–®–∞–±–ª–æ–Ω –¥–æ–±–∞–≤–ª–µ–Ω');
        } else {
            this.showToast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
        }
    }
    
    update(type, id, key, val) {
        const item = this.data[type].find(i => i.id === id);
        if(!item) return;
        item[key] = val;

        if(type === 'clients' && key === 'phone' && val.length > 5) {
            const exist = this.data.clients.find(c => c.phone === val && c.id !== id);
            if(exist) {
                exist.visits = (exist.visits || 1) + 1;
                exist.date = item.date; 
                this.data.clients = this.data.clients.filter(c => c.id !== id); 
                this.renderClients();
                this.saveState();
                this.showToast(`–ö–ª–∏–µ–Ω—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω: ${exist.name}`);
                return;
            }
        }

        if((key === 'service' || key === 'desc' || key === 'name') && (type === 'income' || type === 'expenses' || type === 'warehouse')) {
            const cat = type === 'income' ? 'income' : type === 'expenses' ? 'expense' : 'warehouse';
            const tpl = this.data.templates.find(t => t.name.toLowerCase() === val.toLowerCase() && t.types.includes(cat));
            if(tpl) { 
                item.price = tpl.price; 
                item.qty = tpl.qty; 
                if(type !== 'warehouse') item.total = safeFloat(item.price) * safeFloat(item.qty);
                this.renderTable(type, this.data[type]); 
            }
        }
        this.saveState();
    }
    
    updateCalc(type, id, key, val) {
        const item = this.data[type].find(i => i.id === id);
        if(item) { 
            item[key] = val; 
            item.total = Math.round((safeFloat(item.price) * safeFloat(item.qty)) * 100) / 100; 
            const row = $(`tr[data-id="${id}"]`);
            if(row) {
                const totalInput = row.querySelector('td[data-label="–ò—Ç–æ–≥–æ"] input');
                if(totalInput) totalInput.value = this.formatMoney(item.total).replace(/[^0-9.,]/g,'');
            }
            this.updateDashboard(); 
            this.persist();
        }
    }

    del(type, id) {
        const doit = () => {
            this.data[type] = this.data[type].filter(i => i.id !== id);
            if (type==='income') this.renderTable('income', this.data.income);
            else if (type==='expenses') this.renderTable('expenses', this.data.expenses);
            else if (type==='warehouse') this.renderTable('warehouse', this.data.warehouse);
            else if (type==='clients') this.renderClients();
            else if (type==='debts') this.renderDebts();
            this.saveState();
            this.showToast('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞');
        };
        if(this.data.settings.confirm) this.confirmAction(doit); else doit();
    }

    delTemplate(idx) { this.data.templates.splice(idx, 1); this.renderTemplates(); this.saveState(); }
    toggleDebt(id) { const d = this.data.debts.find(i => i.id === id); if(d) { d.paid = !d.paid; this.renderDebts(); this.saveState(); } }
    
    sort(type, key) { 
        this.data[type].sort((a,b) => {
            const valA = a[key] || ''; const valB = b[key] || '';
            const numA = parseFloat(valA), numB = parseFloat(valB);
            if(!isNaN(numA) && !isNaN(numB)) return (numA - numB) * this.currentSort.dir;
            return String(valA).localeCompare(String(valB)) * this.currentSort.dir;
        });
        this.currentSort.dir *= -1; 
        this.renderAll(); 
    }
    
    getTrashIcon() { return `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`; }

    confirmAction(callback) { $('#confirmModal').classList.add('visible'); $('#confirmBtnAction').onclick = () => { callback(); this.closeModal(); }; }
    closeModal() { $('#confirmModal').classList.remove('visible'); }
    showToast(msg) { 
        const t = document.createElement('div'); t.className = 'toast'; 
        t.innerHTML = `<span>‚úì</span> ${msg}`; 
        $('#toastArea').appendChild(t); 
        setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateX(100%)'; setTimeout(()=>t.remove(), 400); }, 2500); 
    }

    setupListeners() {
        $$('.nav-item').forEach(el => {
            el.onclick = (e) => {
                e.preventDefault();
                $$('.nav-item').forEach(n => n.classList.remove('active')); el.classList.add('active');
                $$('.tab-content').forEach(t => t.classList.remove('active')); $(`#${el.dataset.tab}`).classList.add('active');
                $('#page-title').textContent = el.querySelector('span').textContent;
            }
        });
        $('#calcBtn').onclick = () => $('#miniCalc').classList.toggle('visible');
        $('#closeCalc').onclick = () => $('#miniCalc').classList.remove('visible');
        
        $('#themeToggle').onclick = () => { this.data.settings.theme = this.data.settings.theme === 'dark' ? 'light' : 'dark'; this.applySettings(); this.saveState(); };
        $('#confirmToggle').onclick = () => { this.data.settings.confirm = !this.data.settings.confirm; this.applySettings(); this.saveState(); };
        $('#animToggle').onclick = () => { this.data.settings.anim = !this.data.settings.anim; this.applySettings(); this.saveState(); };
        $('#compactToggle').onclick = () => { this.data.settings.compact = !this.data.settings.compact; this.applySettings(); this.saveState(); };
        $('#roundToggle').onclick = () => { this.data.settings.round = !this.data.settings.round; this.renderAll(); this.saveState(); };
        $('#decimalsToggle').onclick = () => { this.data.settings.decimals = !this.data.settings.decimals; this.renderAll(); this.saveState(); };
        
        $('#currencyInput').onchange = (e) => { this.data.settings.currency = e.target.value; this.renderAll(); this.saveState(); };
        $('#currencyPosSelect').onchange = (e) => { this.data.settings.currencyPos = e.target.value; this.renderAll(); this.saveState(); };
        $('#dateFormatSelect').onchange = (e) => { this.data.settings.dateFormat = e.target.value; this.renderAll(); this.saveState(); };
        $('#designSelect').onchange = (e) => { this.data.settings.design = e.target.value; this.applySettings(); this.saveState(); };
        $('#taxRateInput').onchange = (e) => { this.data.settings.taxRate = parseFloat(e.target.value); this.updateDashboard(); this.saveState(); };
        $('#lowStockInput').onchange = (e) => { this.data.settings.lowStock = parseFloat(e.target.value); this.renderTable('warehouse', this.data.warehouse); this.saveState(); };

        $$('.color-btn').forEach(btn => {
            btn.onclick = () => {
                this.data.settings.color = btn.dataset.color;
                this.applySettings();
                this.saveState();
            }
        });

        $$('.font-btn').forEach(btn => {
            btn.onclick = () => {
                this.data.settings.scale = btn.dataset.val;
                this.applySettings();
                this.saveState();
            }
        });

        $('#undoBtn').onclick = () => this.undo();
        $('#redoBtn').onclick = () => this.redo();
        
        const debouncedRender = (type) => {
            clearTimeout(this.debounceTimer);
            this.debounceTimer = setTimeout(() => {
                if(type === 'income') this.renderTable('income', this.data.income);
                else if(type === 'expenses') this.renderTable('expenses', this.data.expenses);
                else if(type === 'clients') this.renderClients();
                else if(type === 'warehouse') this.renderTable('warehouse', this.data.warehouse);
                else if(type === 'debts') this.renderDebts();
            }, 300);
        };

        ['incomeSearch', 'expenseSearch', 'clientSearch', 'warehouseSearch', 'debtSearch'].forEach(id => { 
            $('#'+id).addEventListener('input', (e) => {
                const type = id.replace('Search', '');
                debouncedRender(type === 'expense' ? 'expenses' : type);
            }); 
        });

        $('#globalSearch').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            const res = $('#globalSearchResults');
            if(!val) { res.innerHTML = ''; return; }
            const clients = this.data.clients.filter(c => c.phone.includes(val) || c.plate.toLowerCase().includes(val));
            res.innerHTML = clients.map(c => `
                <div style="background:var(--bg-input); padding:12px; margin-bottom:8px; border-radius:12px; cursor:pointer;" onclick="$('#clientSearch').value='${c.phone}'; app.renderClients(); $('.nav-item[data-tab=clients]').click();">
                    <div style="font-weight:bold;color:var(--primary)">${c.name}</div>
                    <div style="font-size:0.8rem;color:var(--text-muted)">${c.phone} ‚Ä¢ ${c.plate}</div>
                </div>`).join('');
        });
        $('#clearBtn').onclick = () => this.confirmAction(() => { localStorage.removeItem('tireData'); location.reload(); });
        $('#exportBtn').onclick = () => { const blob = new Blob([JSON.stringify(this.data)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `shina_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); }
        $('#importBtn').onclick = () => $('#importFile').click();
        $('#importFile').onchange = (e) => { const fr = new FileReader(); fr.onload = (ev) => { try { this.data = JSON.parse(ev.target.result); this.saveState(); this.renderAll(); this.showToast('–ë–∞–∑–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'); } catch(e) { alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞'); } }; fr.readAsText(e.target.files[0]); };
    }

    setupDraggable() {
        const elm = $('#miniCalc'), header = $('#calcHeader');
        let pos1=0, pos2=0, pos3=0, pos4=0;
        const start = (e) => { if(e.target.id === 'closeCalc') return; e = e.type==='touchstart'?e.touches[0]:e; pos3 = e.clientX; pos4 = e.clientY; document.onmouseup = close; document.onmousemove = move; document.ontouchend = close; document.ontouchmove = move; };
        const move = (e) => { e = e.type==='touchmove'?e.touches[0]:e; pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; elm.style.top = (elm.offsetTop - pos2) + "px"; elm.style.left = (elm.offsetLeft - pos1) + "px"; };
        const close = () => { document.onmouseup = null; document.onmousemove = null; document.ontouchend = null; document.ontouchmove = null; };
        header.onmousedown = start; header.ontouchstart = start;
    }
}

const app = new App();
</script>
</body>
</html>
