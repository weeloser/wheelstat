<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–£—á–µ—Ç –®–∏–Ω–æ–º–æ–Ω—Ç–∞–∂–∞ Pro</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
:root {
--primary: #3b82f6;
--primary-dark: #2563eb;
--primary-glow: rgba(59, 130, 246, 0.5);
--bg-body: #0f172a;
--bg-card: #1e293b;
--bg-card-hover: #334155;
--text-main: #f1f5f9;
--text-muted: #94a3b8;
--border: #334155;
--success: #10b981;
--danger: #ef4444;
--warning: #f59e0b;
--radius: 16px;
--shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
--nav-height: 70px;
--sidebar-width: 260px;
--header-height: 70px;
--font-size: 15px;
--cell-padding: 15px;
}
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; font-size: var(--font-size); transition: background 0.3s, color 0.3s; }
body.light-theme {
--bg-body: #f8fafc;
--bg-card: #ffffff;
--bg-card-hover: #f1f5f9;
--text-main: #0f172a;
--text-muted: #64748b;
--border: #e2e8f0;
}
body.compact-mode { --cell-padding: 8px; --font-size: 14px; }
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
input, select, textarea, button { font-family: inherit; outline: none; }
button { cursor: pointer; transition: all 0.2s ease; }
.app-container { display: flex; width: 100%; height: 100%; position: relative; }
.sidebar { width: var(--sidebar-width); background: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 20; transition: transform 0.3s ease; }
.logo-area { height: var(--header-height); display: flex; align-items: center; padding: 0 20px; font-weight: 700; font-size: 1.2rem; color: var(--primary); border-bottom: 1px solid var(--border); gap: 10px; }
.logo-icon { width: 32px; height: 32px; background: var(--primary); border-radius: 8px; display: grid; place-items: center; color: white; }
.nav-menu { flex: 1; overflow-y: auto; padding: 20px 10px; display: flex; flex-direction: column; gap: 5px; }
.nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: var(--text-muted); text-decoration: none; border-radius: 12px; transition: all 0.2s; cursor: pointer; font-weight: 500; }
.nav-item:hover { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
.nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px var(--primary-glow); }
.nav-item svg { width: 20px; height: 20px; }
.main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; background: var(--bg-body); }
.top-header { height: var(--header-height); background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 10; position: sticky; top: 0; }
.light-theme .top-header { background: rgba(255, 255, 255, 0.8); }
.header-title { font-size: 1.2rem; font-weight: 600; }
.header-actions { display: flex; gap: 10px; }
.icon-btn { width: 40px; height: 40px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-main); display: grid; place-items: center; font-size: 1.1rem; }
.icon-btn:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-1px); }
.content-scroll { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }
.tab-content { display: none; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
.stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; position: relative; overflow: hidden; transition: transform 0.2s; }
.stat-card:hover { transform: translateY(-3px); border-color: var(--primary); }
.stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--primary); }
.stat-card.success::before { background: var(--success); }
.stat-card.danger::before { background: var(--danger); }
.stat-card.warning::before { background: var(--warning); }
.stat-label { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 8px; }
.stat-value { font-size: 1.8rem; font-weight: 700; color: var(--text-main); }
.controls-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; background: var(--bg-card); padding: 15px; border-radius: var(--radius); border: 1px solid var(--border); }
.btn { padding: 10px 20px; border-radius: 10px; border: none; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; background: var(--primary); color: white; font-size: 0.95rem; }
.btn:hover { background: var(--primary-dark); box-shadow: 0 4px 12px var(--primary-glow); transform: translateY(-1px); }
.btn:active { transform: translateY(0); }
.btn.success { background: var(--success); }
.btn.danger { background: var(--danger); }
.btn.warning { background: var(--warning); }
.btn.ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
.btn.ghost:hover { border-color: var(--primary); color: var(--primary); background: transparent; }
.search-input { flex: 1; background: var(--bg-body); border: 1px solid var(--border); padding: 10px 15px; border-radius: 10px; color: var(--text-main); min-width: 200px; }
.search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-glow); }
.data-table-container { border-radius: var(--radius); border: 1px solid var(--border); background: var(--bg-card); overflow: hidden; transition: all 0.3s; }
.data-table { width: 100%; border-collapse: collapse; }
.data-table th { text-align: left; padding: var(--cell-padding); background: rgba(0,0,0,0.2); color: var(--text-muted); font-weight: 600; font-size: 0.85rem; text-transform: uppercase; border-bottom: 1px solid var(--border); cursor: pointer; user-select: none; }
.data-table td { padding: var(--cell-padding); border-bottom: 1px solid var(--border); vertical-align: middle; }
.data-table tr { transition: background 0.2s; animation: slideIn 0.3s ease forwards; }
.data-table tr:last-child td { border-bottom: none; }
.data-table tr:hover td { background: rgba(255,255,255,0.02); }
.data-table tr.highlight { background: rgba(59, 130, 246, 0.15) !important; }
@keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
.table-input { background: transparent; border: 1px solid transparent; color: inherit; padding: 6px; border-radius: 6px; width: 100%; transition: all 0.2s; font-size: 0.95rem; }
.table-input:focus { background: var(--bg-body); border-color: var(--border); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
.btn-trash { background: transparent; border: none; color: var(--text-muted); padding: 8px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
.btn-trash:hover { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
.btn-trash svg { width: 18px; height: 18px; }
.badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
.badge.paid { background: rgba(16, 185, 129, 0.2); color: var(--success); }
.badge.unpaid { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: all 0.3s; }
.modal-overlay.visible { opacity: 1; pointer-events: auto; }
.modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 30px; width: 100%; max-width: 500px; transform: scale(0.9); transition: all 0.3s; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
.modal-overlay.visible .modal { transform: scale(1); }
.modal h2 { margin-bottom: 20px; color: var(--primary); }
.modal-actions { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }
.toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 200; display: flex; flex-direction: column; gap: 10px; }
.toast { background: var(--bg-card); border-left: 4px solid var(--primary); padding: 15px 20px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); animation: slideInRight 0.3s ease; display: flex; align-items: center; gap: 10px; border: 1px solid var(--border); }
@keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
.mini-calc { position: fixed; bottom: 100px; right: 30px; width: 280px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); z-index: 90; box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: none; animation: popUp 0.3s ease; overflow: hidden; }
.mini-calc.visible { display: block; }
.calc-header { background: var(--primary); color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; cursor: grab; user-select: none; font-weight: 600; font-size: 0.9rem; }
.calc-header:active { cursor: grabbing; }
.calc-close { background: transparent; border: none; color: white; font-size: 1.2rem; line-height: 1; opacity: 0.8; padding: 0 5px; }
.calc-close:hover { opacity: 1; }
.calc-display { background: var(--bg-body); padding: 20px; text-align: right; font-size: 1.8rem; border-bottom: 1px solid var(--border); font-family: monospace; letter-spacing: -1px; }
.calc-pad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: var(--border); }
.calc-btn { border: none; background: var(--bg-card); padding: 15px 0; font-size: 1.1rem; color: var(--text-main); height: 60px; }
.calc-btn:active { background: var(--bg-body); }
.calc-btn.op { color: var(--primary); background: rgba(59, 130, 246, 0.05); }
.calc-btn.eq { background: var(--primary); color: white; grid-column: span 4; }
@keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
@media (max-width: 768px) {
    body { flex-direction: column; }
    .sidebar { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height); flex-direction: row; border-right: none; border-top: 1px solid var(--border); padding: 0; z-index: 100; justify-content: space-around; align-items: center; background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px); }
    .logo-area { display: none; }
    .nav-menu { flex-direction: row; overflow-x: auto; width: 100%; padding: 0; gap: 0; height: 100%; }
    .nav-item { flex-direction: column; gap: 4px; padding: 8px; flex: 1; border-radius: 0; font-size: 0.7rem; justify-content: center; text-align: center; }
    .nav-item svg { width: 24px; height: 24px; margin-bottom: 2px; }
    .nav-item span { display: block; }
    .main-content { height: calc(100% - var(--nav-height)); }
    .content-scroll { padding: 15px; padding-bottom: 80px; }
    .top-header { padding: 0 15px; }
    .dashboard-grid { grid-template-columns: 1fr; }
    .controls-bar { flex-direction: column; align-items: stretch; gap: 15px; }
    .data-table thead { display: none; }
    .data-table tbody tr { display: block; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 15px; padding: 15px; position: relative; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .data-table td { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); text-align: right; }
    .data-table td:last-child { border-bottom: none; justify-content: flex-end; margin-top: 10px; padding-top: 15px; border-top: 1px solid var(--border); }
    .data-table td::before { content: attr(data-label); font-weight: 600; color: var(--text-muted); font-size: 0.85rem; margin-right: 15px; text-align: left; }
    .table-input { text-align: right; width: auto; background: rgba(0,0,0,0.2); border: 1px solid var(--border); padding: 8px 12px; }
    .btn-trash { padding: 10px; background: rgba(239, 68, 68, 0.1); color: var(--danger); width: 100%; }
    .mini-calc { top: 50%; left: 50%; transform: translate(-50%, -50%) !important; width: 90%; max-width: 320px; bottom: auto; right: auto; animation: none; }
}
.todo-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--bg-body); border-radius: 10px; border: 1px solid var(--border); margin-bottom: 10px; transition: opacity 0.3s; }
.todo-item.completed { opacity: 0.6; }
.todo-item.completed span { text-decoration: line-through; }
.checkbox-wrapper { position: relative; display: inline-block; width: 20px; height: 20px; }
.settings-group { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; animation: fadeIn 0.5s ease; }
.setting-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 10px; }
.setting-row:last-child { border-bottom: none; }
.toggle-switch { position: relative; width: 50px; height: 26px; background: var(--bg-body); border-radius: 20px; border: 1px solid var(--border); cursor: pointer; transition: 0.3s; }
.toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: var(--text-muted); border-radius: 50%; transition: 0.3s; }
.toggle-switch.active { background: rgba(59, 130, 246, 0.2); border-color: var(--primary); }
.toggle-switch.active::after { left: 26px; background: var(--primary); }
</style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <div class="logo-area">
            <div class="logo-icon">üõ†Ô∏è</div>
            –£—á–µ—Ç –®–∏–Ω–æ–º–æ–Ω—Ç–∞–∂–∞
        </div>
        <nav class="nav-menu">
            <a class="nav-item active" data-tab="total">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                <span>–ì–ª–∞–≤–Ω–∞—è</span>
            </a>
            <a class="nav-item" data-tab="income">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span>–î–æ—Ö–æ–¥—ã</span>
            </a>
            <a class="nav-item" data-tab="expenses">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span>–†–∞—Å—Ö–æ–¥—ã</span>
            </a>
            <a class="nav-item" data-tab="clients">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                <span>–ö–ª–∏–µ–Ω—Ç—ã</span>
            </a>
            <a class="nav-item" data-tab="warehouse">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                <span>–°–∫–ª–∞–¥</span>
            </a>
            <a class="nav-item" data-tab="debts">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span>–î–æ–ª–≥–∏</span>
            </a>
            <a class="nav-item" data-tab="todos">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                <span>–ó–∞–º–µ—Ç–∫–∏</span>
            </a>
            <a class="nav-item" data-tab="settings">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066 2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            </a>
        </nav>
    </aside>

    <main class="main-content">
        <header class="top-header">
            <div class="header-title" id="page-title">–û–±–∑–æ—Ä</div>
            <div class="header-actions">
                <button class="icon-btn" id="undoBtn" title="–û—Ç–º–µ–Ω–∏—Ç—å">‚Ü∂</button>
                <button class="icon-btn" id="redoBtn" title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å">‚Ü∑</button>
                <button class="icon-btn" id="calcBtn" title="–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä">üßÆ</button>
            </div>
        </header>

        <div class="content-scroll">
            <div id="total" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="stat-card success">
                        <div class="stat-label">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</div>
                        <div class="stat-value" id="totalProfit">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–î–æ—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</div>
                        <div class="stat-value" id="incomeToday">0</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-label">–†–∞—Å—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</div>
                        <div class="stat-value" id="expenseToday">0</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-label">–ù–∞ —Å–∫–ª–∞–¥–µ –ø–æ–∑–∏—Ü–∏–π</div>
                        <div class="stat-value" id="warehouseCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ö–ª–∏–µ–Ω—Ç–æ–≤ –≤ –±–∞–∑–µ</div>
                        <div class="stat-value" id="clientsCount">0</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-label">–°—É–º–º–∞ –¥–æ–ª–≥–æ–≤</div>
                        <div class="stat-value" id="debtsTotal">0</div>
                    </div>
                </div>

                <div class="controls-bar">
                    <button class="btn ghost" id="importBtn">–ò–º–ø–æ—Ä—Ç</button>
                    <button class="btn ghost" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
                    <button class="btn danger" id="clearBtn">–°–±—Ä–æ—Å</button>
                    <input type="text" id="globalSearch" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞...">
                </div>
                <div id="globalSearchResults"></div>
            </div>

            <div id="income" class="tab-content">
                <div class="controls-bar">
                    <button class="btn success" onclick="app.addIncomeRow()">+ –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</button>
                    <input type="text" class="search-input" id="incomeSearch" placeholder="–ü–æ–∏—Å–∫ –¥–æ—Ö–æ–¥–∞...">
                </div>
                <div class="data-table-container">
                    <table class="data-table" id="incomeTable">
                        <thead>
                            <tr>
                                <th onclick="app.sort('income', 'date')">–î–∞—Ç–∞</th>
                                <th onclick="app.sort('income', 'service')">–£—Å–ª—É–≥–∞</th>
                                <th onclick="app.sort('income', 'price')">–¶–µ–Ω–∞</th>
                                <th>–ö–æ–ª-–≤–æ</th>
                                <th onclick="app.sort('income', 'total')">–ò—Ç–æ–≥–æ</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="expenses" class="tab-content">
                <div class="controls-bar">
                    <button class="btn danger" onclick="app.addExpenseRow()">+ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
                    <input type="text" class="search-input" id="expenseSearch" placeholder="–ü–æ–∏—Å–∫ —Ä–∞—Å—Ö–æ–¥–∞...">
                </div>
                <div class="data-table-container">
                    <table class="data-table" id="expensesTable">
                        <thead>
                            <tr>
                                <th onclick="app.sort('expenses', 'date')">–î–∞—Ç–∞</th>
                                <th onclick="app.sort('expenses', 'desc')">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                <th onclick="app.sort('expenses', 'price')">–¶–µ–Ω–∞</th>
                                <th>–ö–æ–ª-–≤–æ</th>
                                <th onclick="app.sort('expenses', 'total')">–ò—Ç–æ–≥–æ</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="clients" class="tab-content">
                <div class="controls-bar">
                    <button class="btn" onclick="app.addClientRow()">+ –ö–ª–∏–µ–Ω—Ç</button>
                    <input type="text" class="search-input" id="clientSearch" placeholder="–ò–º—è, –Ω–æ–º–µ—Ä –∏–ª–∏ –∞–≤—Ç–æ...">
                </div>
                <div class="data-table-container">
                    <table class="data-table" id="clientsTable">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–ò–º—è</th>
                                <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                <th>–ê–≤—Ç–æ</th>
                                <th>–í–∏–∑–∏—Ç–æ–≤</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="warehouse" class="tab-content">
                <div class="controls-bar">
                    <button class="btn warning" onclick="app.addWarehouseRow()">+ –¢–æ–≤–∞—Ä</button>
                    <input type="text" class="search-input" id="warehouseSearch" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞...">
                </div>
                <div class="data-table-container">
                    <table class="data-table" id="warehouseTable">
                        <thead>
                            <tr>
                                <th onclick="app.sort('warehouse', 'name')">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th onclick="app.sort('warehouse', 'qty')">–û—Å—Ç–∞—Ç–æ–∫</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="debts" class="tab-content">
                <div class="controls-bar">
                    <button class="btn danger" onclick="app.addDebtRow()">+ –î–æ–ª–≥</button>
                    <input type="text" class="search-input" id="debtSearch" placeholder="–ü–æ–∏—Å–∫ –¥–æ–ª–∂–Ω–∏–∫–∞...">
                </div>
                <div class="data-table-container">
                    <table class="data-table" id="debtsTable">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–ò–º—è</th>
                                <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="todos" class="tab-content">
                <div class="controls-bar">
                    <input type="text" id="newTodoInput" class="search-input" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞...">
                    <button class="btn success" onclick="app.addTodo()">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                <div id="todoList"></div>
            </div>

            <div id="settings" class="tab-content">
                <div class="settings-group">
                    <h3>–í–Ω–µ—à–Ω–∏–π –≤–∏–¥</h3>
                    <div class="setting-row">
                        <span>–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                        <div class="toggle-switch active" id="themeToggle"></div>
                    </div>
                    <div class="setting-row">
                        <span>–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥ —Ç–∞–±–ª–∏—Ü</span>
                        <div class="toggle-switch" id="compactToggle"></div>
                    </div>
                </div>
                <div class="settings-group">
                    <h3>–û—Å–Ω–æ–≤–Ω—ã–µ</h3>
                    <div class="setting-row">
                        <span>–°–∏–º–≤–æ–ª –≤–∞–ª—é—Ç—ã</span>
                        <input type="text" class="table-input" id="currencyInput" value="‚ÇΩ" style="width: 60px; text-align: center;">
                    </div>
                    <div class="setting-row">
                        <span>–ó–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</span>
                        <div class="toggle-switch active" id="confirmToggle"></div>
                    </div>
                </div>
                <div class="settings-group">
                    <h3>–®–∞–±–ª–æ–Ω—ã —É—Å–ª—É–≥</h3>
                    <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap: wrap;">
                        <input type="text" id="tplName" class="table-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" style="flex:2; border:1px solid var(--border)">
                        <input type="number" id="tplPrice" class="table-input" placeholder="–¶–µ–Ω–∞" style="flex:1; border:1px solid var(--border)">
                        <button class="btn success" onclick="app.addTemplate()">+</button>
                    </div>
                    <div id="templateList"></div>
                </div>
                <div class="settings-group">
                    <h3>–î–∞–Ω–Ω—ã–µ</h3>
                    <div style="color: var(--text-muted); font-size: 0.9rem; line-height: 1.5;">
                        –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div class="mini-calc" id="miniCalc">
    <div class="calc-header" id="calcHeader">
        <span>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</span>
        <button class="calc-close" id="closeCalc">√ó</button>
    </div>
    <div class="calc-display" id="calcDisplay">0</div>
    <div class="calc-pad">
        <button class="calc-btn" onclick="calc.clear()">C</button>
        <button class="calc-btn op" onclick="calc.op('/')">√∑</button>
        <button class="calc-btn op" onclick="calc.op('*')">√ó</button>
        <button class="calc-btn" onclick="calc.del()">‚å´</button>
        <button class="calc-btn" onclick="calc.num(7)">7</button>
        <button class="calc-btn" onclick="calc.num(8)">8</button>
        <button class="calc-btn" onclick="calc.num(9)">9</button>
        <button class="calc-btn op" onclick="calc.op('-')">-</button>
        <button class="calc-btn" onclick="calc.num(4)">4</button>
        <button class="calc-btn" onclick="calc.num(5)">5</button>
        <button class="calc-btn" onclick="calc.num(6)">6</button>
        <button class="calc-btn op" onclick="calc.op('+')">+</button>
        <button class="calc-btn" onclick="calc.num(1)">1</button>
        <button class="calc-btn" onclick="calc.num(2)">2</button>
        <button class="calc-btn" onclick="calc.num(3)">3</button>
        <button class="calc-btn eq" onclick="calc.eq()">=</button>
        <button class="calc-btn" onclick="calc.num(0)" style="grid-column: span 2">0</button>
        <button class="calc-btn" onclick="calc.dot()">.</button>
    </div>
</div>

<div class="modal-overlay" id="confirmModal">
    <div class="modal">
        <h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h2>
        <p id="confirmText">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
        <div class="modal-actions">
            <button class="btn ghost" onclick="app.closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn danger" id="confirmBtnAction">–î–∞, –≤—ã–ø–æ–ª–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<div class="toast-container" id="toastArea"></div>
<input type="file" id="importFile" hidden>

<datalist id="serviceList"></datalist>

<script>
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const uuid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

const calc = {
    curr: '0', prev: null, opVar: null,
    num(n) { this.curr = this.curr === '0' ? String(n) : this.curr + n; this.upd(); },
    dot() { if(!this.curr.includes('.')) this.curr += '.'; this.upd(); },
    op(o) { this.prev = this.curr; this.curr = ''; this.opVar = o; },
    eq() { 
        if(!this.prev || !this.opVar) return;
        const a = parseFloat(this.prev), b = parseFloat(this.curr || this.prev);
        const res = this.opVar==='+'?a+b : this.opVar==='-'?a-b : this.opVar==='*'?a*b : a/b;
        this.curr = String(Math.round(res*100)/100); this.prev = null; this.opVar = null; this.upd(); 
    },
    clear() { this.curr='0'; this.prev=null; this.opVar=null; this.upd(); },
    del() { this.curr = this.curr.length > 1 ? this.curr.slice(0,-1) : '0'; this.upd(); },
    upd() { $('#calcDisplay').textContent = this.curr; }
};

class App {
    constructor() {
        this.data = JSON.parse(localStorage.getItem('tireData')) || {
            income: [], expenses: [], clients: [], warehouse: [], debts: [], todos: [], templates: [], 
            settings: { theme: 'dark', compact: false, currency: '‚ÇΩ', confirm: true }
        };
        this.history = [];
        this.historyStep = -1;
        this.currentSort = { key: null, dir: 1 };
        this.init();
    }

    init() {
        this.applySettings();
        this.renderAll();
        this.setupListeners();
        this.setupDraggable();
        this.saveState(); 
    }

    saveState() {
        if(this.historyStep < this.history.length - 1) {
            this.history = this.history.slice(0, this.historyStep + 1);
        }
        this.history.push(JSON.stringify(this.data));
        if(this.history.length > 20) this.history.shift();
        else this.historyStep++;
        this.persist();
    }

    persist() {
        localStorage.setItem('tireData', JSON.stringify(this.data));
        this.updateDashboard();
        this.updateDataList();
    }

    undo() {
        if(this.historyStep > 0) {
            this.historyStep--;
            this.data = JSON.parse(this.history[this.historyStep]);
            this.renderAll();
            this.applySettings();
            this.persist();
        }
    }

    redo() {
        if(this.historyStep < this.history.length - 1) {
            this.historyStep++;
            this.data = JSON.parse(this.history[this.historyStep]);
            this.renderAll();
            this.applySettings();
            this.persist();
        }
    }

    applySettings() {
        const s = this.data.settings;
        if(!s) return; 
        document.body.classList.toggle('light-theme', s.theme === 'light');
        document.body.classList.toggle('compact-mode', s.compact);
        $('#themeToggle').classList.toggle('active', s.theme === 'dark');
        $('#compactToggle').classList.toggle('active', s.compact);
        $('#confirmToggle').classList.toggle('active', s.confirm);
        $('#currencyInput').value = s.currency || '‚ÇΩ';
    }

    renderAll() {
        this.renderTable('income', this.data.income);
        this.renderTable('expenses', this.data.expenses);
        this.renderClients();
        this.renderTable('warehouse', this.data.warehouse);
        this.renderDebts();
        this.renderTodos();
        this.renderTemplates();
        this.updateDashboard();
    }

    updateDashboard() {
        const curr = this.data.settings.currency || '‚ÇΩ';
        const incToday = this.data.income.filter(i => i.date === new Date().toISOString().slice(0,10)).reduce((a,b) => a + (parseFloat(b.total)||0), 0);
        const expToday = this.data.expenses.filter(e => e.date === new Date().toISOString().slice(0,10)).reduce((a,b) => a + (parseFloat(b.total)||0), 0);
        const totalInc = this.data.income.reduce((a,b) => a + (parseFloat(b.total)||0), 0);
        const totalExp = this.data.expenses.reduce((a,b) => a + (parseFloat(b.total)||0), 0);
        const debts = this.data.debts.filter(d => !d.paid).reduce((a,b) => a + (parseFloat(b.amount)||0), 0);

        $('#totalProfit').textContent = (totalInc - totalExp).toLocaleString() + ' ' + curr;
        $('#incomeToday').textContent = incToday.toLocaleString() + ' ' + curr;
        $('#expenseToday').textContent = expToday.toLocaleString() + ' ' + curr;
        $('#warehouseCount').textContent = this.data.warehouse.length;
        $('#clientsCount').textContent = this.data.clients.length;
        $('#debtsTotal').textContent = debts.toLocaleString() + ' ' + curr;
    }

    updateDataList() {
        const dl = $('#serviceList');
        dl.innerHTML = this.data.templates.map(t => `<option value="${t.name}">`).join('');
    }

    renderTable(type, dataArr) {
        if(type === 'clients' || type === 'debts') return; 
        const tbody = $(`#${type}Table tbody`);
        const term = $(`#${type === 'income' ? 'income' : type === 'expenses' ? 'expense' : 'warehouse'}Search`).value.toLowerCase();
        
        tbody.innerHTML = dataArr.filter(item => Object.values(item).some(v => String(v).toLowerCase().includes(term))).map(item => {
            if(type === 'warehouse') return `
                <tr data-id="${item.id}">
                    <td data-label="–ù–∞–∑–≤–∞–Ω–∏–µ"><input class="table-input" value="${item.name}" onchange="app.update('${type}', '${item.id}', 'name', this.value)"></td>
                    <td data-label="–û—Å—Ç–∞—Ç–æ–∫"><input type="number" class="table-input" value="${item.qty}" onchange="app.update('${type}', '${item.id}', 'qty', this.value)"></td>
                    <td data-label="–î–µ–π—Å—Ç–≤–∏—è"><button class="btn-trash" onclick="app.del('${type}', '${item.id}')">${this.getTrashIcon()}</button></td>
                </tr>`;
            
            const isInc = type === 'income';
            return `
            <tr data-id="${item.id}">
                <td data-label="–î–∞—Ç–∞"><input type="date" class="table-input" value="${item.date}" onchange="app.update('${type}', '${item.id}', 'date', this.value)"></td>
                <td data-label="${isInc?'–£—Å–ª—É–≥–∞':'–û–ø–∏—Å–∞–Ω–∏–µ'}"><input type="text" list="${isInc?'serviceList':''}" class="table-input" value="${isInc?item.service:item.desc}" onchange="app.update('${type}', '${item.id}', '${isInc?'service':'desc'}', this.value)"></td>
                <td data-label="–¶–µ–Ω–∞"><input type="number" class="table-input" value="${item.price}" onchange="app.updateCalc('${type}', '${item.id}', 'price', this.value)"></td>
                <td data-label="–ö–æ–ª-–≤–æ"><input type="number" class="table-input" value="${item.qty}" onchange="app.updateCalc('${type}', '${item.id}', 'qty', this.value)"></td>
                <td data-label="–ò—Ç–æ–≥–æ"><input type="number" class="table-input" value="${item.total}" readonly style="opacity:0.7"></td>
                <td data-label="–î–µ–π—Å—Ç–≤–∏—è"><button class="btn-trash" onclick="app.del('${type}', '${item.id}')">${this.getTrashIcon()}</button></td>
            </tr>`;
        }).join('');
    }

    renderClients() {
        const tbody = $('#clientsTable tbody');
        const term = $('#clientSearch').value.toLowerCase();
        tbody.innerHTML = this.data.clients.filter(c => (c.name+c.phone+c.plate).toLowerCase().includes(term)).map(c => `
            <tr data-id="${c.id}">
                <td data-label="–î–∞—Ç–∞"><input type="date" class="table-input" value="${c.date}" onchange="app.update('clients', '${c.id}', 'date', this.value)"></td>
                <td data-label="–ò–º—è"><input class="table-input" value="${c.name}" onchange="app.update('clients', '${c.id}', 'name', this.value)"></td>
                <td data-label="–¢–µ–ª–µ—Ñ–æ–Ω"><input class="table-input" value="${c.phone}" onchange="app.update('clients', '${c.id}', 'phone', this.value)"></td>
                <td data-label="–ê–≤—Ç–æ"><input class="table-input" value="${c.plate}" onchange="app.update('clients', '${c.id}', 'plate', this.value)"></td>
                <td data-label="–í–∏–∑–∏—Ç–æ–≤"><span class="badge">${c.visits || 1}</span></td>
                <td data-label="–î–µ–π—Å—Ç–≤–∏—è"><button class="btn-trash" onclick="app.del('clients', '${c.id}')">${this.getTrashIcon()}</button></td>
            </tr>
        `).join('');
    }

    renderDebts() {
        const tbody = $('#debtsTable tbody');
        const term = $('#debtSearch').value.toLowerCase();
        tbody.innerHTML = this.data.debts.filter(d => (d.name+d.phone).toLowerCase().includes(term)).map(d => `
            <tr style="${d.paid ? 'opacity:0.5' : ''}" data-id="${d.id}">
                <td data-label="–î–∞—Ç–∞"><input type="date" class="table-input" value="${d.date}" onchange="app.update('debts', '${d.id}', 'date', this.value)"></td>
                <td data-label="–ò–º—è"><input class="table-input" value="${d.name}" onchange="app.update('debts', '${d.id}', 'name', this.value)"></td>
                <td data-label="–¢–µ–ª–µ—Ñ–æ–Ω"><input class="table-input" value="${d.phone}" onchange="app.update('debts', '${d.id}', 'phone', this.value)"></td>
                <td data-label="–°—É–º–º–∞"><input type="number" class="table-input" value="${d.amount}" onchange="app.update('debts', '${d.id}', 'amount', this.value)"></td>
                <td data-label="–°—Ç–∞—Ç—É—Å"><button class="badge ${d.paid?'paid':'unpaid'}" style="border:none;cursor:pointer" onclick="app.toggleDebt('${d.id}')">${d.paid?'–û–ø–ª–∞—á–µ–Ω':'–ù–µ –æ–ø–ª–∞—á–µ–Ω'}</button></td>
                <td data-label="–î–µ–π—Å—Ç–≤–∏—è"><button class="btn-trash" onclick="app.del('debts', '${d.id}')">${this.getTrashIcon()}</button></td>
            </tr>
        `).join('');
    }

    renderTodos() {
        $('#todoList').innerHTML = this.data.todos.map(t => `
            <div class="todo-item ${t.done ? 'completed' : ''}">
                <div class="checkbox-wrapper"><input type="checkbox" ${t.done ? 'checked' : ''} onchange="app.toggleTodo('${t.id}')" style="width:20px;height:20px;"></div>
                <span style="flex:1">${t.text}</span>
                <button class="btn-trash" onclick="app.delTodo('${t.id}')">${this.getTrashIcon()}</button>
            </div>
        `).join('');
    }

    renderTemplates() {
        $('#templateList').innerHTML = this.data.templates.map((t, idx) => `
            <div class="todo-item" style="justify-content:space-between">
                <span>${t.name} - ${t.price} ${this.data.settings.currency}</span>
                <button class="btn-trash" onclick="app.delTemplate(${idx})">${this.getTrashIcon()}</button>
            </div>
        `).join('');
    }

    addIncomeRow() { this.data.income.unshift({ id: uuid(), date: new Date().toISOString().slice(0,10), service: '', price: 0, qty: 1, total: 0 }); this.renderTable('income', this.data.income); this.saveState(); }
    addExpenseRow() { this.data.expenses.unshift({ id: uuid(), date: new Date().toISOString().slice(0,10), desc: '', price: 0, qty: 1, total: 0 }); this.renderTable('expenses', this.data.expenses); this.saveState(); }
    addClientRow() { this.data.clients.unshift({ id: uuid(), date: new Date().toISOString().slice(0,10), name: '', phone: '', plate: '', visits: 1 }); this.renderClients(); this.saveState(); }
    addWarehouseRow() { this.data.warehouse.unshift({ id: uuid(), name: '', qty: 0 }); this.renderTable('warehouse', this.data.warehouse); this.saveState(); }
    addDebtRow() { this.data.debts.unshift({ id: uuid(), date: new Date().toISOString().slice(0,10), name: '', phone: '', amount: 0, paid: false }); this.renderDebts(); this.saveState(); }
    addTodo() { const val = $('#newTodoInput').value.trim(); if(val) { this.data.todos.unshift({ id: uuid(), text: val, done: false }); $('#newTodoInput').value = ''; this.renderTodos(); this.saveState(); } }
    addTemplate() { const name = $('#tplName').value.trim(); const price = $('#tplPrice').value; if(name && price) { this.data.templates.push({ name, price }); $('#tplName').value = ''; $('#tplPrice').value = ''; this.renderTemplates(); this.saveState(); } }
    
    update(type, id, key, val) {
        const item = this.data[type].find(i => i.id === id);
        if(!item) return;
        item[key] = val;

        if(type === 'clients' && key === 'phone' && val.length > 3) {
            const exist = this.data.clients.find(c => c.phone === val && c.id !== id);
            if(exist) {
                exist.visits = (exist.visits || 1) + 1;
                exist.date = item.date; 
                this.data.clients = this.data.clients.filter(c => c.id !== id); 
                this.renderClients();
                this.saveState();
                this.showToast(`–ö–ª–∏–µ–Ω—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω —Å ${exist.name}!`);
                const row = $(`tr[data-id="${exist.id}"]`);
                if(row) { row.scrollIntoView({behavior:'smooth'}); row.classList.add('highlight'); setTimeout(()=>row.classList.remove('highlight'),2000); }
                return;
            }
        }

        if((key === 'service' || key === 'desc') && type !== 'warehouse') {
            const tpl = this.data.templates.find(t => t.name === val);
            if(tpl) { item.price = tpl.price; item.total = item.price * item.qty; this.renderTable(type, this.data[type]); }
        }
        this.saveState();
    }
    
    updateCalc(type, id, key, val) {
        const item = this.data[type].find(i => i.id === id);
        if(item) { item[key] = val; item.total = (parseFloat(item.price) || 0) * (parseFloat(item.qty) || 0); this.renderTable(type, this.data[type]); this.saveState(); }
    }

    del(type, id) {
        if(this.data.settings.confirm) {
            this.confirmAction(() => { this.data[type] = this.data[type].filter(i => i.id !== id); this.renderAll(); this.saveState(); });
        } else {
            this.data[type] = this.data[type].filter(i => i.id !== id); this.renderAll(); this.saveState();
        }
    }

    delTodo(id) { this.data.todos = this.data.todos.filter(t => t.id !== id); this.renderTodos(); this.saveState(); }
    delTemplate(idx) { this.data.templates.splice(idx, 1); this.renderTemplates(); this.saveState(); }
    toggleDebt(id) { const d = this.data.debts.find(i => i.id === id); if(d) { d.paid = !d.paid; this.renderDebts(); this.saveState(); } }
    toggleTodo(id) { const t = this.data.todos.find(i => i.id === id); if(t) { t.done = !t.done; this.renderTodos(); this.saveState(); } }
    sort(type, key) { this.data[type].sort((a,b) => (a[key] > b[key] ? 1 : -1) * this.currentSort.dir); this.currentSort.dir *= -1; this.renderAll(); }
    
    getTrashIcon() { return `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`; }

    confirmAction(callback) { $('#confirmModal').classList.add('visible'); $('#confirmBtnAction').onclick = () => { callback(); this.closeModal(); }; }
    closeModal() { $('#confirmModal').classList.remove('visible'); }
    showToast(msg) { const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; $('#toastArea').appendChild(t); setTimeout(() => t.remove(), 3000); }

    setupListeners() {
        $$('.nav-item').forEach(el => {
            el.onclick = () => {
                $$('.nav-item').forEach(n => n.classList.remove('active')); el.classList.add('active');
                $$('.tab-content').forEach(t => t.classList.remove('active')); $(`#${el.dataset.tab}`).classList.add('active');
                $('#page-title').textContent = el.querySelector('span').textContent;
                if(window.innerWidth <= 768) $('.main-content').scrollTop = 0;
            }
        });
        $('#calcBtn').onclick = () => $('#miniCalc').classList.toggle('visible');
        $('#closeCalc').onclick = () => $('#miniCalc').classList.remove('visible');
        
        $('#themeToggle').onclick = () => { this.data.settings.theme = this.data.settings.theme === 'dark' ? 'light' : 'dark'; this.applySettings(); this.saveState(); };
        $('#compactToggle').onclick = () => { this.data.settings.compact = !this.data.settings.compact; this.applySettings(); this.saveState(); };
        $('#confirmToggle').onclick = () => { this.data.settings.confirm = !this.data.settings.confirm; this.applySettings(); this.saveState(); };
        $('#currencyInput').onchange = (e) => { this.data.settings.currency = e.target.value; this.renderAll(); this.saveState(); };

        $('#undoBtn').onclick = () => this.undo();
        $('#redoBtn').onclick = () => this.redo();
        ['incomeSearch', 'expenseSearch', 'clientSearch', 'warehouseSearch', 'debtSearch'].forEach(id => { $('#'+id).addEventListener('input', () => this.renderAll()); });
        $('#globalSearch').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            const res = $('#globalSearchResults');
            if(!val) { res.innerHTML = ''; return; }
            const clients = this.data.clients.filter(c => c.phone.includes(val) || c.plate.toLowerCase().includes(val));
            res.innerHTML = clients.map(c => `<div class="todo-item">–ö–ª–∏–µ–Ω—Ç: ${c.name} (${c.phone}) - ${c.plate}</div>`).join('');
        });
        $('#clearBtn').onclick = () => this.confirmAction(() => { localStorage.removeItem('tireData'); location.reload(); });
        $('#exportBtn').onclick = () => { const blob = new Blob([JSON.stringify(this.data)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'tire_backup.json'; a.click(); }
        $('#importBtn').onclick = () => $('#importFile').click();
        $('#importFile').onchange = (e) => { const fr = new FileReader(); fr.onload = (ev) => { try { this.data = JSON.parse(ev.target.result); this.saveState(); this.renderAll(); this.showToast('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã'); } catch(e) { alert('–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞'); } }; fr.readAsText(e.target.files[0]); };
    }

    setupDraggable() {
        const elm = $('#miniCalc'), header = $('#calcHeader');
        let pos1=0, pos2=0, pos3=0, pos4=0;
        header.onmousedown = dragMouseDown;
        header.ontouchstart = dragMouseDown;
        function dragMouseDown(e) {
            e = e || window.event;
            if(e.type === 'touchstart') { pos3 = e.touches[0].clientX; pos4 = e.touches[0].clientY; } else { e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY; }
            document.onmouseup = closeDragElement; document.onmousemove = elementDrag;
            document.ontouchend = closeDragElement; document.ontouchmove = elementDrag;
        }
        function elementDrag(e) {
            e = e || window.event;
            let cx, cy;
            if(e.type === 'touchmove') { cx = e.touches[0].clientX; cy = e.touches[0].clientY; } else { e.preventDefault(); cx = e.clientX; cy = e.clientY; }
            pos1 = pos3 - cx; pos2 = pos4 - cy; pos3 = cx; pos4 = cy;
            elm.style.top = (elm.offsetTop - pos2) + "px"; elm.style.left = (elm.offsetLeft - pos1) + "px";
        }
        function closeDragElement() { document.onmouseup = null; document.onmousemove = null; document.ontouchend = null; document.ontouchmove = null; }
    }
}

const app = new App();
</script>
</body>
</html>
