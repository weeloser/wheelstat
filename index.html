<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Учет Шиномонтажа</title>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/CLyKKjZP/LOGO.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #111827; --bg-light: #1F2937; --bg-card-dark: #1F2937; --bg-card-light: #FFFFFF; --bg-input-dark: #374151; --bg-input-light: #F3F4F6;
            --primary: #38BDF8; --primary-hover: #7DD3FC; --primary-light: rgba(56, 189, 248, 0.1);
            --text-dark: #F9FAFB; --text-light: #111827; --text-muted-dark: #9CA3AF; --text-muted-light: #6B7280;
            --danger: #F43F5E; --success: #34D399; --warning: #FBBF24; --border-color-dark: #374151; --border-color-light: #E5E7EB;
            --border-radius: 12px; --transition-speed: 0.3s;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark); color: var(--text-dark); min-height: 100vh;
            padding: 15px; font-size: 16px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }
        body:not(.animations-disabled) button,
        body:not(.animations-disabled) .button,
        body:not(.animations-disabled) .tab,
        body:not(.animations-disabled) .result-card,
        body:not(.animations-disabled) .modal-content,
        body:not(.animations-disabled) .modal-overlay,
        body:not(.animations-disabled) input,
        body:not(.animations-disabled) select,
        body:not(.animations-disabled) tr,
        body:not(.animations-disabled) .icon {
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease, border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease, transform var(--transition-speed) ease, opacity var(--transition-speed) ease;
        }
        body.light-theme { --bg-dark: #F9FAFB; --bg-light: #FFFFFF; --bg-card-dark: #FFFFFF; --bg-input-dark: #F3F4F6; --text-dark: #111827; --text-muted-dark: #6B7280; --border-color-dark: #E5E7EB; }
        body.font-size-small { font-size: 14px; } body.font-size-large { font-size: 18px; }
        .container { max-width: 1800px; margin: 0 auto; animation: fadeIn 0.8s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        h1 { font-size: clamp(1.8rem, 5vw, 2.5rem); color: var(--primary); text-shadow: 0 0 15px rgba(56, 189, 248, 0.4); }
        .history-controls button { background: var(--bg-light); color: var(--text-dark); border: none; width: 45px; height: 45px; font-size: 1.5em; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; }
        .history-controls button:hover:not(:disabled) { background: var(--primary); color: var(--text-light); transform: translateY(-3px) scale(1.1); }
        .history-controls button:disabled { opacity: 0.4; cursor: not-allowed; transform: none; background: var(--bg-light); color: var(--text-dark); }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; flex-wrap: wrap; }
        .tab { padding: 10px 20px; background: var(--bg-light); border: 2px solid transparent; color: var(--text-muted-dark); cursor: pointer; font-size: 1em; font-weight: 600; border-radius: var(--border-radius); display: flex; align-items: center; gap: 8px; }
        .tab:hover { color: var(--primary); transform: translateY(-3px); }
        .tab.active { background: var(--primary); color: var(--bg-dark); box-shadow: 0 0 20px rgba(56, 189, 248, 0.5); transform: translateY(-2px); }
        .tab .icon { width: 22px; height: 22px; stroke-width: 2; }
        .tab:hover .icon { transform: scale(1.2) rotate(-5deg); }
        .tab-content { display: none; } .tab-content.active { display: block; animation: slideIn 0.5s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .controls { background: var(--bg-light); padding: 15px; margin-bottom: 20px; border-radius: var(--border-radius); display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        button, .button { padding: 10px 20px; background: var(--primary); color: var(--bg-dark); border: none; cursor: pointer; font-size: 1em; font-weight: 600; border-radius: var(--border-radius); display: inline-flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; }
        button:hover, .button:hover { filter: brightness(1.2); transform: scale(1.05) translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.25); }
        button:active, .button:active { transform: scale(0.98) translateY(1px); filter: brightness(0.9); box-shadow: 0 1px 5px rgba(0,0,0,0.2); }
        button.danger { background: var(--danger); } button.success { background: var(--success); } button.warning { background: var(--warning); }
        input[type="date"], input[type="search"], input[type="text"], input[type="number"], input[type="color"], input[type="tel"], select { padding: 10px; background: var(--bg-input-dark); color: var(--text-dark); border: 2px solid var(--border-color-dark); font-size: 1em; border-radius: var(--border-radius); width: 100%; }
        input:focus, select:focus { outline: none; box-shadow: 0 0 0 3px var(--primary-light); border-color: var(--primary); }
        .controls input { width: auto; flex-grow: 1; }
        .table-wrapper { overflow-x: auto; background: var(--bg-light); border-radius: var(--border-radius); padding: 5px; }
        table { width: 100%; border-collapse: collapse; }
        tbody tr.row-enter { animation: rowSlideIn 0.4s ease-out forwards, newRowHighlight 1.5s ease-out .2s; }
        tbody tr.row-exit { animation: rowSlideOut 0.4s ease-in forwards; }
        @keyframes rowSlideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes rowSlideOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        @keyframes newRowHighlight { from { background-color: var(--primary-light); } to { background-color: transparent; } }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color-dark); vertical-align: middle; white-space: nowrap; }
        th[data-sort-key] { cursor: pointer; user-select: none; }
        th[data-sort-key]:hover { background: var(--primary-hover); color: var(--bg-dark); }
        th.sort-asc::after { content: ' ▲'; font-size: 0.8em; }
        th.sort-desc::after { content: ' ▼'; font-size: 0.8em; }
        .table-density-compact td, .table-density-compact th { padding: 8px; } .table-density-spacious td, .table-density-spacious th { padding: 20px; }
        thead { background: var(--primary); color: var(--bg-dark); position: sticky; top: 0; z-index: 1; }
        tbody tr:hover { background: var(--primary-light); }
        tbody tr.highlight { animation: highlight-row 2s ease-out; }
        tr.paid-debt { opacity: 0.6; }
        tr.paid-debt input { text-decoration: line-through; }
        .status-cell { text-align: center; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--danger); transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        @keyframes highlight-row { 0%, 100% { background-color: transparent; } 50% { background-color: rgba(251, 191, 36, 0.3); } }
        td input { max-width: 250px; }
        .actions-cell { display: flex; align-items: center; gap: 10px; min-width: 100px; }
        .btn-action { background: transparent; border: none; cursor: pointer; font-size: 1.5em; padding: 5px; color: var(--text-muted-dark); }
        .btn-action:hover { transform: scale(1.2) rotate(10deg); box-shadow: none; color: var(--primary); }
        .btn-delete:hover { color: var(--danger); } .btn-expand:hover { color: var(--success); } .btn-edit:hover { color: var(--warning); }
        .sub-row { background: rgba(56, 189, 248, 0.05); } .sub-row td:nth-child(3), .sub-row td:nth-child(5), .sub-row td:nth-child(6) { opacity: 0.5; }
        .summary-container { display: flex; flex-direction: column; gap: 30px; }
        .summary-category h2 { margin-bottom: 15px; color: var(--primary); border-bottom: 2px solid var(--bg-light); padding-bottom: 10px; }
        .total-results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .result-card { background: var(--bg-card-dark); padding: 25px; border-radius: var(--border-radius); border-left: 5px solid var(--primary); animation: cardEnter 0.5s ease-out forwards; opacity: 0; border-top: 1px solid transparent; border-right: 1px solid transparent; }
        @keyframes cardEnter { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .result-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); border-color: var(--primary); }
        .result-card .label { font-size: 1.1em; color: var(--text-muted-dark); margin-bottom: 10px; }
        .result-card .value { font-size: 2em; font-weight: 700; color: var(--text-dark); word-break: break-all; }
        .result-card .value.positive { color: var(--success); } .result-card .value.negative { color: var(--danger); }
        .result-card.best-client { grid-column: 1 / -1; border-color: var(--warning); cursor: pointer; }
        .best-client .value { font-size: 1.2em; line-height: 1.6; } .best-client .highlight-text { color: var(--warning); font-weight: bold; }
        .notification { position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: var(--bg-dark); padding: 15px 25px; border-radius: var(--border-radius); font-weight: bold; animation: slideInUp 0.5s ease, slideOutDown 0.5s ease 2.5s; z-index: 1000; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        @keyframes slideInUp { from { transform: translateY(100px) opacity(0); } to { transform: translateY(0) opacity(1); } }
        @keyframes slideOutDown { from { transform: translateY(0) opacity(1); } to { transform: translateY(100px) opacity(0); } }
        .settings-page { background: var(--bg-light); padding: 20px; border-radius: var(--border-radius); max-width: 800px; margin: 0 auto; }
        .settings-page h2 { margin-bottom: 20px; color: var(--primary); }
        .setting-item { display: flex; flex-direction: column; align-items: flex-start; gap: 10px; margin-bottom: 25px; }
        .setting-item > label { font-weight: bold; }
        .setting-controls { display: flex; gap: 10px; flex-wrap: wrap; width: 100%; }
        .setting-controls button { background-color: var(--bg-dark); color: var(--text-dark); border: 2px solid transparent; }
        .setting-controls button.active { border-color: var(--primary); }
        #service-templates-list { width: 100%; display: flex; flex-direction: column; gap: 5px; }
        .template-item { display: flex; justify-content: space-between; align-items: center; background: var(--bg-dark); padding: 8px; border-radius: 8px; width: 100%;}
        .template-item.income-template { border-left: 3px solid var(--success); }
        .template-item.expense-template { border-left: 3px solid var(--danger); }
        .template-item span { flex-grow: 1; margin-left: 10px;}
        .template-item .template-actions { display: flex; gap: 5px;}
        .template-form-grid { display: grid; grid-template-columns: 1fr 100px 80px 100px auto; gap: 10px; width: 100%;}
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; pointer-events: none; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--bg-light); padding: 30px; border-radius: var(--border-radius); text-align: center; max-width: 90%; width: 500px; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content p { margin-bottom: 20px; font-size: 1.2em; color: var(--text-dark); }
        .modal-actions { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;}
        body.animations-disabled * { animation: none !important; transition: none !important; }
        .number-input-wrapper { position: relative; display: flex; align-items: center; }
        .number-input-wrapper input[type="number"] { padding-right: 2rem; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .stepper-controls { position: absolute; right: 1px; top: 1px; bottom: 1px; width: 1.8rem; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: opacity 0.2s ease-in-out; }
        .number-input-wrapper:hover .stepper-controls, .number-input-wrapper input:focus + .stepper-controls { opacity: 1; pointer-events: all; }
        .stepper-btn { flex: 1; background: var(--bg-input-dark); border: none; color: var(--text-muted-dark); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s, color 0.2s; }
        .stepper-btn:hover { background: var(--bg-light); color: var(--primary); }
        .stepper-up { border-bottom: 1px solid var(--border-color-dark); border-top-right-radius: var(--border-radius); }
        .stepper-down { border-bottom-right-radius: var(--border-radius); }
        #faqModal .modal-content { text-align: left; max-width: 800px; max-height: 80vh; overflow-y: auto; }
        #faqModal h2 { color: var(--primary); text-align: center; margin-bottom: 20px; }
        #faqModal details { background: var(--bg-dark); border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--border-color-dark); }
        #faqModal summary { font-weight: bold; cursor: pointer; padding: 15px; color: var(--primary); }
        #faqModal details[open] summary { border-bottom: 1px solid var(--border-color-dark); }
        #faqModal .faq-content { padding: 15px; border-top: 1px solid var(--border-color-dark); }
        .calculator-container { max-width: 400px; margin: 20px auto; background: var(--bg-light); padding: 20px; border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .calculator-display { background: var(--bg-dark); color: var(--text-dark); text-align: right; padding: 20px; font-size: 2.5em; border-radius: var(--border-radius); margin-bottom: 20px; word-wrap: break-word; word-break: break-all; }
        .calculator-keys { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .calculator-keys button { height: 60px; font-size: 1.5em; background: var(--bg-input-dark); color: var(--text-dark); }
        .calculator-keys button.operator { background: var(--primary); color: var(--bg-dark); }
        .calculator-keys button.function { background: var(--bg-light); }
        .calculator-keys button.equals { grid-column: span 2; background: var(--success); }
        .calculator-keys button.zero { grid-column: span 2; }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .top-bar { flex-direction: column; align-items: center; text-align: center; }
            .controls { flex-direction: column; align-items: stretch; }
            .tab { padding: 10px 15px; font-size: 0.9em; }
            .tab .icon { width: 18px; height: 18px; }
            .template-form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="top-bar">
        <h1>Учет Шиномонтажа</h1>
        <div class="history-controls">
            <button id="undoBtn" title="Отменить (Ctrl+Z)" aria-label="Отменить">↶</button>
            <button id="redoBtn" title="Повторить (Ctrl+Y)" aria-label="Повторить">↷</button>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" data-tab="total" role="tab"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg><span>Общий результат</span></div>
        <div class="tab" data-tab="income" role="tab"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg><span>Доходы</span></div>
        <div class="tab" data-tab="expenses" role="tab"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg><span>Расходы</span></div>
        <div class="tab" data-tab="clients" role="tab"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg><span>Клиенты</span></div>
        <div class="tab" data-tab="debts" role="tab"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg><span>Долги</span></div>
        <div class="tab" data-tab="calculator" role="tab"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg><span>Калькулятор</span></div>
        <div class="tab" data-tab="settings" role="tab"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg><span>Настройки</span></div>
    </div>
    
    <div class="tab-content active" id="total">
        <div class="controls">
            <label for="importFile" class="button">📂 Импорт</label>
            <input type="file" id="importFile" style="display:none" accept=".json">
            <button class="success" id="exportDataBtn">💾 Экспорт</button>
            <button class="warning" id="copySummaryBtn">📋 Копировать сводку</button>
            <button class="danger" id="clearAllDataBtn">🗑️ Очистить все</button>
        </div>
        <div class="summary-container">
            <div class="summary-category">
                <h2>Сводка</h2>
                <div class="total-results-grid">
                    <div class="result-card" style="animation-delay: 0s;"><div class="label">💰 Чистая прибыль</div><div class="value" id="totalProfit">0.00 ₽</div></div>
                    <div class="result-card" style="animation-delay: 0.1s;"><div class="label">📈 Общий доход</div><div class="value positive" id="totalIncome">0.00 ₽</div></div>
                    <div class="result-card" style="animation-delay: 0.2s;"><div class="label">📉 Общий расход</div><div class="value negative" id="totalExpenses">0.00 ₽</div></div>
                    <div class="result-card" style="animation-delay: 0.3s;"><div class="label">💸 Общая сумма долгов</div><div class="value negative" id="totalDebt">0.00 ₽</div></div>
                </div>
            </div>
            <div class="summary-category">
                <h2>Клиенты (Инфо)</h2>
                <div class="total-results-grid">
                    <div class="result-card" style="animation-delay: 0.4s;"><div class="label">👥 Всего клиентов</div><div class="value" id="totalClients">0</div></div>
                    <div class="result-card" style="animation-delay: 0.5s;"><div class="label">🚗 Всего посещений</div><div class="value" id="totalVisits">0</div></div>
                    <div class="result-card" style="animation-delay: 0.6s;"><div class="label">📊 Средний чек</div><div class="value" id="avgClientCheck">0.00 ₽</div></div>
                    <div class="result-card best-client" id="bestClientCard" style="animation-delay: 0.7s;"><div class="label">👑 Лучший клиент</div><div class="value" id="bestClientInfo">Нет данных</div></div>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-content" id="income">
        <div class="controls"> <button id="addIncomeRowBtn">➕ Добавить доход</button> <input type="search" id="incomeSearch" placeholder="Поиск по услугам, комментариям..." aria-label="Поиск по доходам"></div>
        <div class="table-wrapper"><table id="incomeTable"><thead><tr><th scope="col" data-sort-key="date" aria-sort="none">Дата</th><th scope="col" data-sort-key="price" aria-sort="none">Цена за шт.</th><th scope="col" data-sort-key="count" aria-sort="none">Кол-во</th><th scope="col" data-sort-key="totalAmount" aria-sort="none">Общая сумма</th><th scope="col" data-sort-key="service" aria-sort="none">Услуга</th><th scope="col" data-sort-key="comment" aria-sort="none">Комментарий</th><th scope="col">Действия</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div class="tab-content" id="expenses">
        <div class="controls"><button id="addExpenseRowBtn">➕ Добавить расход</button><input type="search" id="expensesSearch" placeholder="Поиск по описанию..." aria-label="Поиск по расходам"></div>
        <div class="table-wrapper"><table id="expensesTable"><thead><tr><th scope="col" data-sort-key="date" aria-sort="none">Дата</th><th scope="col" data-sort-key="price" aria-sort="none">Цена за шт.</th><th scope="col" data-sort-key="count" aria-sort="none">Кол-во</th><th scope="col" data-sort-key="totalAmount" aria-sort="none">Общая сумма</th><th scope="col" data-sort-key="description" aria-sort="none">Что именно?</th><th scope="col">Действия</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div class="tab-content" id="clients">
        <div class="controls"><button id="addClientRowBtn">➕ Добавить клиента</button><input type="search" id="clientSearch" placeholder="Поиск по дате, номеру, имени..." aria-label="Поиск по клиентам"></div>
        <div class="table-wrapper"><table id="clientsTable"><thead><tr><th scope="col" data-sort-key="date" aria-sort="none">Дата</th><th scope="col" data-sort-key="amount" aria-sort="none">Сумма из заметки</th><th scope="col" data-sort-key="phone" aria-sort="none">Номер</th><th scope="col" data-sort-key="plate" aria-sort="none">Гос номер</th><th scope="col" data-sort-key="name" aria-sort="none">Имя</th><th scope="col">Кол-во посещений</th><th scope="col">Действия</th></tr></thead><tbody></tbody></table></div>
    </div>
    
    <div class="tab-content" id="debts">
        <div class="controls"><button id="addDebtRowBtn">➕ Добавить долг</button><input type="search" id="debtSearch" placeholder="Поиск по имени, телефону, комментарию..." aria-label="Поиск по долгам"></div>
        <div class="table-wrapper"><table id="debtsTable"><thead><tr><th scope="col" data-sort-key="date" aria-sort="none">Дата</th><th scope="col" data-sort-key="amount" aria-sort="none">Сумма</th><th scope="col" data-sort-key="name" aria-sort="none">Кто должен</th><th scope="col" data-sort-key="phone" aria-sort-none">Телефон</th><th scope="col" data-sort-key="comment" aria-sort="none">Комментарий</th><th scope="col" data-sort-key="isPaid" aria-sort="none">Статус</th><th scope="col">Действия</th></tr></thead><tbody></tbody></table></div>
    </div>
    
    <div class="tab-content" id="calculator">
        <div class="calculator-container">
            <div id="calculator-display" class="calculator-display">0</div>
            <div class="calculator-keys">
                <button class="function" data-key="clear">AC</button>
                <button class="function" data-key="backspace">C</button>
                <button class="function" data-key="percent">%</button>
                <button class="operator" data-key="/">÷</button>
                <button data-key="7">7</button>
                <button data-key="8">8</button>
                <button data-key="9">9</button>
                <button class="operator" data-key="*">×</button>
                <button data-key="4">4</button>
                <button data-key="5">5</button>
                <button data-key="6">6</button>
                <button class="operator" data-key="-">−</button>
                <button data-key="1">1</button>
                <button data-key="2">2</button>
                <button data-key="3">3</button>
                <button class="operator" data-key="+">+</button>
                <button class="zero" data-key="0">0</button>
                <button data-key=".">.</button>
                <button class="equals" data-key="=">=</button>
            </div>
        </div>
    </div>

    <div class="tab-content" id="settings">
        <div class="settings-page">
            <h2>Настройки</h2>
            <div class="setting-item"><label>Тема:</label><div class="setting-controls" id="theme-switcher"><button data-theme="dark" class="active">Темная</button><button data-theme="light">Светлая</button></div></div>
            <div class="setting-item"><label for="primaryColorPicker">Основной цвет:</label><input type="color" id="primaryColorPicker" value="#38BDF8"></div>
            <div class="setting-item"><label for="currencySymbol">Символ валюты:</label><input type="text" id="currencySymbol" value="₽" style="width: 50px; text-align: center;"></div>
            <div class="setting-item"><label>Анимации:</label><div class="setting-controls" id="animation-switcher"><button data-anim="on" class="active">Вкл</button><button data-anim="off">Выкл</button></div></div>
            <div class="setting-item"><label>Плотность таблиц:</label><div class="setting-controls" id="density-switcher"><button data-density="compact">Компактно</button><button data-density="normal" class="active">Нормально</button><button data-density="spacious">Просторно</button></div></div>
            <div class="setting-item"><label>Размер шрифта:</label><div class="setting-controls" id="font-size-switcher"><button data-size="small">Мелкий</button><button data-size="normal" class="active">Обычный</button><button data-size="large">Крупный</button></div></div>
            <div class="setting-item"><label>Подтверждение удаления:</label><div class="setting-controls" id="confirm-delete-switcher"><button data-confirm="on" class="active">Вкл</button><button data-confirm="off">Выкл</button></div></div>
            <div class="setting-item" title="При равенстве основного критерия, сортировка происходит по вторичному (Сумма -> Посещения, Посещения -> Сумма)"><label>Критерий "Лучшего клиента":</label><div class="setting-controls" id="best-client-metric-switcher"><button data-metric="profit" class="active">По сумме</button><button data-metric="visits">По посещениям</button></div></div>
            <div class="setting-item"><label>Показывать погашенные долги:</label><div class="setting-controls" id="show-paid-debts-switcher"><button data-show="on" class="active">Вкл</button><button data-show="off">Выкл</button></div></div>
            <div class="setting-item"><label>Шаблоны</label><div class="setting-controls"><div class="template-form-grid"><input type="text" id="templateName" placeholder="Название"><input type="number" id="templatePrice" placeholder="Цена" min="0"><input type="number" id="templateCount" placeholder="Кол-во" value="1" min="1"><select id="templateType" style="width: 100%;"><option value="income">Доход</option><option value="expense">Расход</option></select><button id="addServiceTemplateBtn">Добавить</button></div></div><div id="service-templates-list" style="margin-top: 10px;"></div></div>
            <div class="setting-item"><label>Управление данными</label><div class="setting-controls"><button class="warning" id="resetSettingsBtn">Сбросить настройки</button></div></div>
            <div class="setting-item"><label>Помощь</label><div class="setting-controls"><button id="showFaqBtn">Инструкция по приложению</button></div></div>
        </div>
    </div>
</div>
<datalist id="service-templates-datalist-income"></datalist>
<datalist id="service-templates-datalist-expense"></datalist>

<div id="confirmModal" class="modal-overlay">
    <div class="modal-content">
        <p id="modalText">Вы уверены?</p>
        <div class="modal-actions">
            <button id="modalConfirmBtn" class="button">Да</button>
            <button id="modalCancelBtn" class="button">Отмена</button>
        </div>
    </div>
</div>

<div id="faqModal" class="modal-overlay">
    <div class="modal-content">
        <h2>FAQ / Инструкция</h2>
        <details>
            <summary>Как добавить доход или расход?</summary>
            <div class="faq-content">
                <p>Перейдите на вкладку "Доходы" или "Расходы" и нажмите кнопку "➕ Добавить". Появится новая строка, где вы можете ввести дату, цену за штуку, количество и описание. Общая сумма рассчитается автоматически. Вы также можете ввести общую сумму, и цена за штуку пересчитается.</p>
            </div>
        </details>
        <details>
            <summary>Как работают шаблоны?</summary>
            <div class="faq-content">
                <p>В "Настройках" есть раздел "Шаблоны". Вы можете создать шаблон для часто повторяющихся доходов или расходов, указав название, цену, количество и тип (доход/расход). После создания, при добавлении новой записи о доходе/расходе, начните вводить название в поле "Услуга" или "Что именно?", и вам будет предложен ваш шаблон. При выборе шаблона все поля заполнятся автоматически.</p>
            </div>
        </details>
        <details>
            <summary>Как работают клиенты и долги?</summary>
            <div class="faq-content">
                <p>На вкладке "Клиенты" вы можете вести базу своих клиентов, добавлять их посещения (кнопка ➕ в строке клиента). На вкладке "Долги" можно записывать, кто и сколько вам должен. Статус долга можно изменить переключателем в строке.</p>
            </div>
        </details>
        <details>
            <summary>Что такое "Лучший клиент"?</summary>
            <div class="faq-content">
                <p>На главной странице в сводке отображается "Лучший клиент". Этот клиент определяется либо по общей сумме, которую он вам принес, либо по количеству посещений. Вы можете изменить этот критерий в настройках.</p>
            </div>
        </details>
        <details>
            <summary>Как сохранить и загрузить данные?</summary>
            <div class="faq-content">
                <p>На главной вкладке "Общий результат" есть кнопки "Экспорт" и "Импорт". Экспорт сохраняет все ваши данные в один файл на компьютер. Импорт позволяет загрузить данные из такого файла. При импорте вам будет предложено либо полностью заменить текущие данные, либо объединить их с данными из файла.</p>
            </div>
        </details>
         <details>
            <summary>Какие есть горячие клавиши?</summary>
            <div class="faq-content">
                <p><b>Ctrl + Z</b> - Отменить последнее действие.</p>
                <p><b>Ctrl + Y</b> - Вернуть отмененное действие.</p>
            </div>
        </details>
        <div class="modal-actions" style="margin-top: 20px;">
            <button id="faqCloseBtn" class="button">Закрыть</button>
        </div>
    </div>
</div>

<script>
'use strict';
const get = (selector) => document.querySelector(selector);
const getAll = (selector) => document.querySelectorAll(selector);

class TireServiceApp {
    constructor() {
        this.MAX_HISTORY_STATES = 100;
        this.data = {
            expenses: [], income: [], clients: [], debts: [], serviceTemplates: [],
            settings: {
                version: "2.0",
                theme: 'dark', currency: '₽', primaryColor: '#38BDF8', animations: true,
                tableDensity: 'normal', fontSize: 'normal', confirmDelete: true, bestClientMetric: 'profit',
                showPaidDebts: true,
                incomeFilter: '', expensesFilter: '', clientsFilter: '', debtsFilter: '',
                sort: {
                    income: {key: 'date', dir: 'desc'},
                    expenses: {key: 'date', dir: 'desc'},
                    clients: {key: 'date', dir: 'desc'},
                    debts: {key: 'date', dir: 'desc'}
                }
            }
        };
        this.historyStack = [];
        this.historyIndex = -1;
        this.bestClientGlobal = null;
        this.editingTemplateIndex = null;
        this.debouncedSave = this.debounce(() => this.recordHistoryState(), 500);
        this.calculatorState = { displayValue: '0', firstOperand: null, waitingForSecondOperand: false, operator: null };
    }

    init() {
        this.setupEventListeners();
        this.loadData();
    }
    
    uuid() {
        if (crypto && crypto.randomUUID) {
            return crypto.randomUUID();
        }
        let dt = new Date().getTime();
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = (dt + Math.random()*16)%16 | 0;
            dt = Math.floor(dt/16);
            return (c=='x' ? r :(r&0x3|0x8)).toString(16);
        });
    }

    setupEventListeners() {
        document.addEventListener('keydown', e => {
            if (e.ctrlKey && e.key === 'z') { e.preventDefault(); this.undo(); }
            if (e.ctrlKey && e.key === 'y') { e.preventDefault(); this.redo(); }
        });

        getAll('.tab').forEach(tab => tab.addEventListener('click', (e) => this.switchTab(e.currentTarget.dataset.tab)));
        get('#undoBtn').addEventListener('click', () => this.undo());
        get('#redoBtn').addEventListener('click', () => this.redo());

        get('#addIncomeRowBtn').addEventListener('click', () => this.addIncomeRow());
        get('#addExpenseRowBtn').addEventListener('click', () => this.addExpenseRow());
        get('#addClientRowBtn').addEventListener('click', () => this.addClientRow());
        get('#addDebtRowBtn').addEventListener('click', () => this.addDebtRow());
        get('#addServiceTemplateBtn').addEventListener('click', () => this.addOrUpdateServiceTemplate());
        
        get('#incomeTable tbody').addEventListener('input', e => this.handleTableInput(e, 'income'));
        get('#expensesTable tbody').addEventListener('input', e => this.handleTableInput(e, 'expenses'));
        get('#clientsTable tbody').addEventListener('input', e => this.handleTableInput(e, 'clients'));
        get('#debtsTable tbody').addEventListener('input', e => this.handleTableInput(e, 'debts'));

        get('#incomeTable tbody').addEventListener('click', e => this.handleTableClick(e, 'income'));
        get('#expensesTable tbody').addEventListener('click', e => this.handleTableClick(e, 'expenses'));
        get('#clientsTable tbody').addEventListener('click', e => this.handleTableClick(e, 'clients'));
        get('#debtsTable tbody').addEventListener('click', e => this.handleTableClick(e, 'debts'));
        
        getAll('th[data-sort-key]').forEach(th => th.addEventListener('click', e => {
            const tableId = e.target.closest('table').id;
            const tableKey = tableId.replace('Table', '');
            const sortKey = e.target.dataset.sortKey;
            this.sortTable(tableKey, sortKey);
        }));

        get('#incomeSearch').addEventListener('input', this.debounce(e => { this.updateSetting('incomeFilter', e.target.value, false); this.filterTable('#incomeTable tbody', e.target.value, [4, 5]); }, 300));
        get('#expensesSearch').addEventListener('input', this.debounce(e => { this.updateSetting('expensesFilter', e.target.value, false); this.filterTable('#expensesTable tbody', e.target.value, [4]); }, 300));
        get('#clientSearch').addEventListener('input', this.debounce(e => { this.updateSetting('clientsFilter', e.target.value, false); this.filterClientsTable(e.target.value); }, 300));
        get('#debtSearch').addEventListener('input', this.debounce(e => { this.updateSetting('debtsFilter', e.target.value, false); this.filterTable('#debtsTable tbody', e.target.value, [2, 3, 4]); }, 300));

        get('#exportDataBtn').addEventListener('click', () => this.exportData());
        get('#importFile').addEventListener('change', e => this.importData(e));
        get('#clearAllDataBtn').addEventListener('click', () => this.clearAllData());
        get('#copySummaryBtn').addEventListener('click', () => this.copySummary());
        get('#bestClientCard').addEventListener('click', () => this.goToBestClient());

        get('#theme-switcher').addEventListener('click', e => e.target.dataset.theme && this.updateSetting('theme', e.target.dataset.theme));
        get('#animation-switcher').addEventListener('click', e => e.target.dataset.anim && this.updateSetting('animations', e.target.dataset.anim === 'on'));
        get('#density-switcher').addEventListener('click', e => e.target.dataset.density && this.updateSetting('tableDensity', e.target.dataset.density));
        get('#font-size-switcher').addEventListener('click', e => e.target.dataset.size && this.updateSetting('fontSize', e.target.dataset.size));
        get('#confirm-delete-switcher').addEventListener('click', e => e.target.dataset.confirm && this.updateSetting('confirmDelete', e.target.dataset.confirm === 'on'));
        get('#best-client-metric-switcher').addEventListener('click', e => e.target.dataset.metric && this.updateSetting('bestClientMetric', e.target.dataset.metric));
        get('#show-paid-debts-switcher').addEventListener('click', e => e.target.dataset.show && this.updateSetting('showPaidDebts', e.target.dataset.show === 'on'));
        get('#resetSettingsBtn').addEventListener('click', () => this.resetSettings());
        
        get('#primaryColorPicker').addEventListener('input', this.debounce(e => this.updateSetting('primaryColor', e.target.value), 100));
        get('#currencySymbol').addEventListener('input', this.debounce(e => this.updateSetting('currency', e.target.value), 300));

        get('#service-templates-list').addEventListener('click', async e => {
            const target = e.target.closest('button');
            if (!target) return;
            const item = target.closest('.template-item');
            const index = parseInt(item.dataset.index);
            if (target.classList.contains('btn-delete')) await this.deleteServiceTemplate(index);
            if (target.classList.contains('btn-edit')) this.editServiceTemplate(index);
        });
        
        get('#showFaqBtn').addEventListener('click', () => get('#faqModal').classList.add('visible'));
        get('#faqCloseBtn').addEventListener('click', () => get('#faqModal').classList.remove('visible'));
        get('#faqModal').addEventListener('click', e => { if (e.target.id === 'faqModal') get('#faqModal').classList.remove('visible'); });

        get('.calculator-keys').addEventListener('click', e => {
            if (e.target.matches('button')) {
                this.handleCalculatorInput(e.target.dataset.key);
            }
        });
    }
    
    confirmAction({ text, confirmText = "Да", cancelText = "Отмена", confirmClass = 'danger' }) {
        return new Promise((resolve) => {
            const modal = get('#confirmModal');
            const confirmBtn = get('#modalConfirmBtn');
            const cancelBtn = get('#modalCancelBtn');

            get('#modalText').textContent = text;
            confirmBtn.textContent = confirmText;
            cancelBtn.textContent = cancelText;

            confirmBtn.className = `button ${confirmClass}`;
            cancelBtn.className = 'button';

            modal.classList.add('visible');
            
            const cleanup = () => {
                modal.classList.remove('visible');
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };
            const confirmHandler = () => { cleanup(); resolve(true); };
            const cancelHandler = () => { cleanup(); resolve(false); };
            
            confirmBtn.addEventListener('click', confirmHandler, { once: true });
            cancelBtn.addEventListener('click', cancelHandler, { once: true });
        });
    }

    saveData() {
        try {
            localStorage.setItem('tireServiceData', JSON.stringify(this.data));
        } catch(e) {
            console.error("Failed to save data to localStorage:", e);
            this.showNotification("Ошибка сохранения: Хранилище переполнено", "danger");
        }
    }

    updateState(updater, recordHistory = true) {
        updater(this.data);
        this.saveData();
        if (recordHistory) this.recordHistoryState();
        this.render();
    }
    
    loadState(newState, recordHistory = true) {
        const defaultData = new TireServiceApp().data;
        const sanitizedData = this.sanitizeData(newState);
        this.data = { ...defaultData, ...sanitizedData, settings: { ...defaultData.settings, ...(sanitizedData.settings || {}) }};
        if (recordHistory) this.recordHistoryState();
        this.render();
    }

    render() {
        this.applySettings();
        this.renderAllTables();
        this.renderServiceTemplates();
        this.updateAllCalculations();
        this.updateHistoryButtons();
        this.updateSortHeaders();
        
        const { incomeFilter, expensesFilter, clientsFilter, debtsFilter } = this.data.settings;
        get('#incomeSearch').value = incomeFilter || '';
        this.filterTable('#incomeTable tbody', incomeFilter || '', [4, 5]);
        get('#expensesSearch').value = expensesFilter || '';
        this.filterTable('#expensesTable tbody', expensesFilter || '', [4]);
        get('#clientSearch').value = clientsFilter || '';
        this.filterClientsTable(clientsFilter || '');
        get('#debtSearch').value = debtsFilter || '';
        this.filterTable('#debtsTable tbody', debtsFilter || '', [2, 3, 4]);
    }
    
    recordHistoryState() {
        const currentState = JSON.stringify(this.data);
        if (this.historyIndex > -1 && this.historyStack[this.historyIndex] === currentState) return;

        this.historyStack = this.historyStack.slice(0, this.historyIndex + 1);
        this.historyStack.push(currentState);
        this.historyIndex++;
        
        if (this.historyStack.length > this.MAX_HISTORY_STATES) {
            this.historyStack.shift(); this.historyIndex--;
        }

        this.updateHistoryButtons();
    }

    undo() { if (this.historyIndex > 0) { this.historyIndex--; this.loadState(JSON.parse(this.historyStack[this.historyIndex]), false); }}
    redo() { if (this.historyIndex < this.historyStack.length - 1) { this.historyIndex++; this.loadState(JSON.parse(this.historyStack[this.historyIndex]), false); }}
    updateHistoryButtons() { get('#undoBtn').disabled = this.historyIndex <= 0; get('#redoBtn').disabled = this.historyIndex >= this.historyStack.length - 1; }

    parseMoney(value) {
        if (typeof value !== 'string' && typeof value !== 'number') return 0;
        const stringValue = String(value).replace(',', '.').replace(/[^0-9.-]/g, '');
        let parsed = parseFloat(stringValue);
        return isNaN(parsed) ? 0 : parsed;
    }
    
    renderMoney(value) { return `${this.parseMoney(value).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, " ")} ${this.data.settings.currency || '₽'}`; }
    
    showNotification(message, type = 'success') {
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        notif.textContent = message;
        notif.setAttribute('role', 'alert');
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 3000);
    }
    
    debounce(func, delay) { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; }

    handleTableInput(event, tableKey) {
        const input = event.target;
        if (input.tagName !== 'INPUT') return;
        
        const row = input.closest('tr');
        if (!row) return;

        const { id, subId } = row.dataset;
        const key = input.dataset.key;
        
        const mainKeyMap = {
            income: ['date', 'price', 'count', 'totalAmount', 'service', 'comment'],
            expenses: ['date', 'price', 'count', 'totalAmount', 'description'],
            clients: ['date', 'amount', 'phone', 'plate', 'name'],
            debts: ['date', 'amount', 'name', 'phone', 'comment'],
            clientVisits: ['date', 'amount', null, 'plate']
        };

        const item = this.data[tableKey].find(i => i.id === id);
        if (!item) return;
        
        let targetObject = item;
        if (tableKey === 'clients' && subId) {
            const visit = item.visits.find(v => v.id === subId);
            if (!visit) return;
            targetObject = visit;
        }

        if (key) {
            let value = input.value;
            if ((key === 'price' || key === 'totalAmount' || key === 'amount') && this.parseMoney(value) < 0) {
                value = Math.abs(this.parseMoney(value)).toString();
                input.value = value;
            }
            targetObject[key] = value;
            
            if (tableKey === 'income' || tableKey === 'expenses') {
                this.updateRowCalculation(row, targetObject, key);
                if (key === 'service' || key === 'description') {
                    this.applyTemplate(value, targetObject, row, tableKey);
                }
            }
            
            this.saveData();
            this.updateAllCalculations();
            this.debouncedSave();
        }
    }

    updateRowCalculation(row, item, changedKey) {
        const count = Math.max(1, parseInt(item.count) || 1);
        const price = this.parseMoney(item.price);
        const totalAmount = this.parseMoney(item.totalAmount);

        const priceInput = row.querySelector('input[data-key="price"]');
        const countInput = row.querySelector('input[data-key="count"]');
        const totalAmountInput = row.querySelector('input[data-key="totalAmount"]');
        
        if (changedKey === 'count' || changedKey === 'price') {
            const newTotal = count * price;
            item.totalAmount = newTotal;
            if (totalAmountInput) totalAmountInput.value = newTotal.toFixed(2);
        } else if (changedKey === 'totalAmount') {
            if (count > 0) {
                const newPrice = totalAmount / count;
                item.price = newPrice;
                if (priceInput) priceInput.value = newPrice.toFixed(2);
            }
        }
        if (countInput && (parseInt(countInput.value) || 0) <= 0) {
            countInput.value = 1;
            item.count = 1;
        }
    }
    
    applyTemplate(templateName, item, row, tableKey) {
        const template = (this.data.serviceTemplates || []).find(t => t.name === templateName && t.type === tableKey);
        if (template && item) {
            item.price = template.price;
            item.count = template.count;
            this.updateRowCalculation(row, item, 'price');
            
            const priceInput = row.querySelector('input[data-key="price"]');
            const countInput = row.querySelector('input[data-key="count"]');
            if(priceInput) priceInput.value = item.price;
            if(countInput) countInput.value = item.count;
        }
    }
    
    async handleTableClick(event, tableKey) {
        const target = event.target;
        const row = target.closest('tr');
        if (!row) return;
        const { id } = row.dataset;

        if (target.classList.contains('btn-status')) {
            const item = this.data[tableKey].find(i => i.id === id);
            if (item) {
                item.isPaid = target.checked;
                this.updateState(d => {}, true);
            }
            return;
        }

        const button = target.closest('button');
        if (!button) return;
        
        if (button.classList.contains('stepper-btn')) {
            const wrapper = button.closest('.number-input-wrapper');
            const input = wrapper.querySelector('input[type="number"]');
            const isUp = button.classList.contains('stepper-up');
            const step = 1;

            let currentValue = this.parseMoney(input.value);
            if (isNaN(currentValue)) currentValue = 0;

            let newValue = isUp ? currentValue + step : currentValue - step;
            
            const min = parseFloat(input.min);
            if (!isNaN(min) && newValue < min) {
                newValue = min;
            } else if (newValue < 0) {
                 newValue = 0;
            }
            
            input.value = newValue;
            input.dispatchEvent(new Event('input', { bubbles: true }));
            return;
        }

        const { subId } = row.dataset;

        if (button.classList.contains('btn-delete')) await this.deleteRow(tableKey, id, subId, row);
        if (button.classList.contains('btn-expand')) this.expandClientRow(id);
    }

    addIncomeRow() { this.updateState(data => { data.income.unshift({ id: this.uuid(), date: new Date().toISOString().slice(0, 10), price: '', count: 1, totalAmount: 0, service: '', comment: '' }); }); }
    addExpenseRow() { this.updateState(data => { data.expenses.unshift({ id: this.uuid(), date: new Date().toISOString().slice(0, 10), price: '', count: 1, totalAmount: 0, description: '' }); }); }
    addClientRow() { this.updateState(data => { data.clients.unshift({ id: this.uuid(), date: new Date().toISOString().slice(0, 10), amount: '', phone: '', plate: '', name: '', visits: [] }); }); }
    addDebtRow() { this.updateState(data => { data.debts.unshift({ id: this.uuid(), date: new Date().toISOString().slice(0, 10), amount: '', name: '', phone: '', comment: '', isPaid: false }); }); }

    async deleteRow(tableKey, id, subId, rowElement) {
        if (this.data.settings.confirmDelete) {
            if (!await this.confirmAction({ text: "Удалить эту запись?" })) return;
        }
        
        const animate = this.data.settings.animations;
        if (animate) {
            rowElement.classList.add('row-exit');
            if (tableKey === 'clients' && !subId) {
                let next = rowElement.nextElementSibling;
                while(next && next.classList.contains('sub-row')) {
                    next.classList.add('row-exit');
                    next = next.nextElementSibling;
                }
            }
        }
        
        setTimeout(() => {
            this.updateState(data => {
                if (tableKey === 'clients' && subId) {
                    const client = data.clients.find(c => c.id === id);
                    if (client) client.visits = client.visits.filter(v => v.id !== subId);
                } else {
                    data[tableKey] = data[tableKey].filter(item => item.id !== id);
                }
            });
        }, animate ? 400 : 0);
    }
    
    expandClientRow(clientId) {
        this.updateState(data => {
            const client = data.clients.find(c => c.id === clientId);
            if (client) {
                const plate = client.plate || '';
                client.visits.push({ id: this.uuid(), date: new Date().toISOString().slice(0, 10), amount: '', plate: plate });
            }
        });
    }

    getNumberInputHTML(value, placeholder, min = 0, step = 1, dataKey) {
        return `
            <div class="number-input-wrapper">
                <input type="number" step="${step}" min="${min}" placeholder="${placeholder}" value="${value}" data-key="${dataKey}">
                <div class="stepper-controls">
                    <button type="button" class="stepper-btn stepper-up" aria-label="Увеличить">▲</button>
                    <button type="button" class="stepper-btn stepper-down" aria-label="Уменьшить">▼</button>
                </div>
            </div>`;
    }
    
    renderAllTables() {
        ['income', 'expenses', 'clients', 'debts'].forEach(key => {
            const sortState = this.data.settings.sort[key];
            if (sortState && sortState.key) {
                this.data[key].sort((a, b) => {
                    const sortKey = sortState.key;
                    
                    if (sortKey === 'isPaid') {
                        const valA = a.isPaid || false;
                        const valB = b.isPaid || false;
                        return sortState.dir === 'asc' ? (valA - valB) : (valB - valA);
                    }

                    let valA = a[sortKey];
                    let valB = b[sortKey];

                    if (['amount', 'count', 'price', 'totalAmount'].includes(sortKey)) {
                        valA = this.parseMoney(valA);
                        valB = this.parseMoney(valB);
                        if(isNaN(valA)) valA = 0;
                        if(isNaN(valB)) valB = 0;
                    } else {
                        valA = String(valA || '').toLowerCase();
                        valB = String(valB || '').toLowerCase();
                    }

                    if (valA < valB) return sortState.dir === 'asc' ? -1 : 1;
                    if (valA > valB) return sortState.dir === 'asc' ? 1 : -1;
                    return 0;
                });
            }
        });
        
        this.renderTable('#incomeTable tbody', this.data.income, this.getIncomeRowHTML);
        this.renderTable('#expensesTable tbody', this.data.expenses, this.getExpenseRowHTML);
        this.renderClientsTable();
        const debtsToRender = this.data.settings.showPaidDebts ? this.data.debts : this.data.debts.filter(d => !d.isPaid);
        this.renderTable('#debtsTable tbody', debtsToRender, this.getDebtRowHTML);
    }

    renderTable(tbodySelector, data, rowRenderer) {
        const tbody = get(tbodySelector);
        tbody.innerHTML = data.map(item => rowRenderer.call(this, item)).join('');
    }

    renderClientsTable() {
        const tbody = get('#clientsTable tbody');
        let html = '';
        this.data.clients.forEach(client => {
            const totalVisits = 1 + (client.visits?.length || 0);
            html += `
                <tr data-id="${client.id}">
                    <td><input type="date" value="${client.date || ''}" data-key="date"></td>
                    <td>${this.getNumberInputHTML(client.amount || '', '0', 0, 1, 'amount')}</td>
                    <td><input type="tel" placeholder="+7..." value="${client.phone || ''}" pattern="\\+?[0-9\\s\\-()]+" data-key="phone"></td>
                    <td><input type="text" placeholder="А000АА00" value="${client.plate || ''}" pattern="[А-Яа-яA-Za-z0-9]+" data-key="plate"></td>
                    <td><input type="text" placeholder="Имя" value="${client.name || ''}" data-key="name"></td>
                    <td><input type="number" value="${totalVisits}" readonly></td>
                    <td class="actions-cell">
                        <button class="btn-action btn-delete" title="Удалить клиента" aria-label="Удалить клиента">✖</button>
                        <button class="btn-action btn-expand" title="Добавить посещение" aria-label="Добавить посещение">➕</button>
                    </td>
                </tr>`;
            const sortedVisits = (client.visits || []).sort((a, b) => b.date.localeCompare(a.date));
            sortedVisits.forEach(visit => {
                html += `
                <tr class="sub-row" data-id="${client.id}" data-sub-id="${visit.id}">
                    <td><input type="date" value="${visit.date || ''}" data-key="date"></td>
                    <td>${this.getNumberInputHTML(visit.amount || '', '0', 0, 1, 'amount')}</td>
                    <td></td>
                    <td><input type="text" placeholder="Гос номер" value="${visit.plate || ''}" data-key="plate"></td>
                    <td></td><td></td>
                    <td class="actions-cell"><button class="btn-action btn-delete" title="Удалить посещение" aria-label="Удалить посещение">✖</button></td>
                </tr>`;
            });
        });
        tbody.innerHTML = html;
    }

    getIncomeRowHTML(item) {
        return `<tr data-id="${item.id}">
            <td><input type="date" value="${item.date || ''}" data-key="date"></td>
            <td>${this.getNumberInputHTML(item.price || '', '0', 0, 1, 'price')}</td>
            <td>${this.getNumberInputHTML(item.count || 1, '1', 1, 1, 'count')}</td>
            <td>${this.getNumberInputHTML(item.totalAmount || '0', '0', 0, 1, 'totalAmount')}</td>
            <td><input type="text" placeholder="Услуга" value="${item.service || ''}" list="service-templates-datalist-income" data-key="service"></td>
            <td><input type="text" placeholder="Комментарий" value="${item.comment || ''}" data-key="comment"></td>
            <td class="actions-cell"><button class="btn-action btn-delete" title="Удалить" aria-label="Удалить">✖</button></td>
        </tr>`;
    }
    getExpenseRowHTML(item) {
        return `<tr data-id="${item.id}">
            <td><input type="date" value="${item.date || ''}" data-key="date"></td>
            <td>${this.getNumberInputHTML(item.price || '', '0', 0, 1, 'price')}</td>
            <td>${this.getNumberInputHTML(item.count || 1, '1', 1, 1, 'count')}</td>
            <td>${this.getNumberInputHTML(item.totalAmount || '0', '0', 0, 1, 'totalAmount')}</td>
            <td><input type="text" placeholder="Описание" value="${item.description || ''}" list="service-templates-datalist-expense" data-key="description"></td>
            <td class="actions-cell"><button class="btn-action btn-delete" title="Удалить" aria-label="Удалить">✖</button></td>
        </tr>`;
    }
    getDebtRowHTML(item) {
        const isPaid = item.isPaid || false;
        return `
        <tr data-id="${item.id}" class="${isPaid ? 'paid-debt' : ''}">
            <td><input type="date" value="${item.date || ''}" data-key="date"></td>
            <td>${this.getNumberInputHTML(item.amount || '', '0', 0, 1, 'amount')}</td>
            <td><input type="text" placeholder="Имя" value="${item.name || ''}" data-key="name"></td>
            <td><input type="tel" placeholder="+7..." value="${item.phone || ''}" data-key="phone"></td>
            <td><input type="text" placeholder="Комментарий" value="${item.comment || ''}" data-key="comment"></td>
            <td class="status-cell"><label class="switch"><input type="checkbox" class="btn-status" ${isPaid ? 'checked' : ''}><span class="slider round"></span></label></td>
            <td class="actions-cell"><button class="btn-action btn-delete" title="Удалить" aria-label="Удалить">✖</button></td>
        </tr>`;
    }

    updateAllCalculations() {
        const totalIncome = this.data.income.reduce((sum, item) => sum + this.parseMoney(item.totalAmount), 0);
        const totalExpenses = this.data.expenses.reduce((sum, item) => sum + this.parseMoney(item.totalAmount), 0);
        const netProfit = totalIncome - totalExpenses;
        const totalDebt = this.data.debts.reduce((sum, item) => sum + (!item.isPaid ? this.parseMoney(item.amount) : 0), 0);
        
        let totalVisits = 0;
        let totalFromNotes = 0;
        const clientsData = this.data.clients.map(client => {
            const clientVisitsCount = 1 + (client.visits?.length || 0);
            const clientProfit = this.parseMoney(client.amount) + (client.visits || []).reduce((sum, visit) => sum + this.parseMoney(visit.amount), 0);
            totalVisits += clientVisitsCount;
            totalFromNotes += clientProfit;
            return { id: client.id, name: client.name, phone: client.phone, profit: clientProfit, visits: clientVisitsCount };
        });

        get('#totalIncome').textContent = this.renderMoney(totalIncome);
        get('#totalExpenses').textContent = this.renderMoney(totalExpenses);
        get('#totalProfit').textContent = this.renderMoney(netProfit);
        get('#totalDebt').textContent = this.renderMoney(totalDebt);
        get('#totalClients').textContent = clientsData.length;
        get('#totalVisits').textContent = totalVisits;
        get('#avgClientCheck').textContent = this.renderMoney(totalVisits > 0 ? totalFromNotes / totalVisits : 0);
        
        get('#totalProfit').classList.toggle('positive', netProfit >= 0);
        get('#totalProfit').classList.toggle('negative', netProfit < 0);
        
        this.findBestClient(clientsData);
    }
    
    findBestClient(clientsData) {
        if (clientsData.length === 0) {
            get('#bestClientInfo').textContent = 'Нет данных о клиентах';
            this.bestClientGlobal = null; return;
        }
        const metric = this.data.settings.bestClientMetric || 'profit';
        
        const sortedClients = [...clientsData].sort((a, b) => {
            const primaryDiff = b[metric] - a[metric];
            if (primaryDiff !== 0) return primaryDiff;

            const secondaryMetric = metric === 'profit' ? 'visits' : 'profit';
            const secondaryDiff = b[secondaryMetric] - a[secondaryMetric];
            if (secondaryDiff !== 0) return secondaryDiff;
            
            return (a.name || '').localeCompare(b.name || '');
        });
        
        this.bestClientGlobal = sortedClients[0];
        get('#bestClientInfo').innerHTML = `<span class="highlight-text">${this.bestClientGlobal.name || 'Безымянный'} (${this.bestClientGlobal.phone || 'Без номера'})</span><br>Сумма: <span class="highlight-text">${this.renderMoney(this.bestClientGlobal.profit)}</span> | Посещений: ${this.bestClientGlobal.visits}`;
    }

    goToBestClient() {
        if (!this.bestClientGlobal?.id) return;
        this.switchTab('clients', () => {
            const targetRow = get(`#clientsTable tbody tr[data-id="${this.bestClientGlobal.id}"]`);
            if (targetRow) {
                targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                targetRow.classList.add('highlight');
                setTimeout(() => targetRow.classList.remove('highlight'), 2000);
            }
        });
    }

    filterTable(tbodySelector, searchTerm, cellIndices) {
        const term = searchTerm.toLowerCase();
        getAll(`${tbodySelector} tr`).forEach(row => {
            const rowText = cellIndices.map(index => {
                const cell = row.cells[index];
                const input = cell ? cell.querySelector('input') : null;
                return input ? input.value.toLowerCase() : '';
            }).join(' ');
            row.style.display = rowText.includes(term) ? '' : 'none';
        });
    }
    
    filterClientsTable(term) {
        const lowerTerm = term.toLowerCase();

        if (!lowerTerm) {
            getAll('#clientsTable tbody tr').forEach(row => row.style.display = '');
            return;
        }

        this.data.clients.forEach(client => {
            const mainRow = get(`#clientsTable tbody tr[data-id="${client.id}"]:not(.sub-row)`);
            if (!mainRow) return;

            const clientText = [client.date, client.amount, client.phone, client.plate, client.name].join(' ').toLowerCase();
            const mainRowMatches = clientText.includes(lowerTerm);

            let anySubRowMatches = false;
            (client.visits || []).forEach(visit => {
                const subRow = get(`#clientsTable tbody tr[data-sub-id="${visit.id}"]`);
                if (!subRow) return;
                
                const visitText = [visit.date, visit.amount, visit.plate].join(' ').toLowerCase();
                const subRowMatches = visitText.includes(lowerTerm);

                if (subRowMatches) {
                    subRow.style.display = '';
                    anySubRowMatches = true;
                } else {
                    subRow.style.display = 'none';
                }
            });

            mainRow.style.display = (mainRowMatches || anySubRowMatches) ? '' : 'none';
        });
    }

    validateData(data) {
        return data && typeof data === 'object' &&
               Array.isArray(data.income) &&
               Array.isArray(data.expenses) &&
               Array.isArray(data.clients) &&
               Array.isArray(data.debts) &&
               typeof data.settings === 'object';
    }
    
    sanitizeData(data) {
        if (!this.validateData(data)) return new TireServiceApp().data;

        const sanitizeItem = (item) => ({
            ...item,
            id: item.id || this.uuid(),
            date: typeof item.date === 'string' ? item.date : new Date().toISOString().slice(0, 10),
            price: this.parseMoney(item.price || item.amount),
            count: parseInt(item.count) || 1,
            totalAmount: this.parseMoney(item.totalAmount) || (this.parseMoney(item.price || item.amount) * (parseInt(item.count) || 1))
        });
        
        data.income = Array.isArray(data.income) ? data.income.map(sanitizeItem) : [];
        data.expenses = Array.isArray(data.expenses) ? data.expenses.map(sanitizeItem) : [];
        data.clients = Array.isArray(data.clients) ? data.clients.map(client => ({
            ...client, id: client.id || this.uuid(),
            visits: Array.isArray(client.visits) ? client.visits.map(v => ({...v, id: v.id || this.uuid()})) : []
        })) : [];
        data.debts = Array.isArray(data.debts) ? data.debts.map(d => ({...d, id: d.id || this.uuid(), isPaid: d.isPaid || false})) : [];
        data.serviceTemplates = Array.isArray(data.serviceTemplates) ? data.serviceTemplates : [];
        return data;
    }

    loadData() {
        const savedData = localStorage.getItem('tireServiceData');
        if (savedData) {
            try {
                const parsedData = JSON.parse(savedData);
                this.loadState(parsedData, false);
                this.showNotification('Данные загружены');
            } catch (e) {
                console.error("Failed to load data, resetting to default.", e);
                this.loadState(new TireServiceApp().data, false);
                this.showNotification('Данные повреждены, загружен стандартный набор', 'danger');
            }
        } else {
            this.recordHistoryState();
            this.render();
        }
    }
    
    exportData() { const json = JSON.stringify(this.data, null, 2); const blob = new Blob([json], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `tire_service_data_${new Date().toISOString().slice(0, 10)}.json`; a.click(); URL.revokeObjectURL(url); this.showNotification('Данные экспортированы'); }
    
    async importData(e) { 
        const file = e.target.files[0]; 
        if (!file) return; 
        
        const reader = new FileReader(); 
        reader.onload = async event => { 
            try { 
                const parsed = JSON.parse(event.target.result); 
                if (this.validateData(parsed)) { 
                    const shouldMerge = await this.confirmAction({
                        text: "Как импортировать данные?",
                        confirmText: "Объединить",
                        cancelText: "Заменить все",
                        confirmClass: 'success'
                    });

                    if (shouldMerge) {
                        this.updateState(data => {
                            const newIncome = (parsed.income || []).map(item => ({ ...item, id: this.uuid() }));
                            const newExpenses = (parsed.expenses || []).map(item => ({ ...item, id: this.uuid() }));
                            const newClients = (parsed.clients || []).map(client => ({
                                ...client,
                                id: this.uuid(),
                                visits: (client.visits || []).map(visit => ({ ...visit, id: this.uuid() }))
                            }));
                            const newDebts = (parsed.debts || []).map(item => ({ ...item, id: this.uuid() }));
                            
                            const existingTemplateNames = new Set(data.serviceTemplates.map(t => `${t.name}-${t.type}`));
                            const newTemplates = (parsed.serviceTemplates || []).filter(t => !existingTemplateNames.has(`${t.name}-${t.type}`));

                            data.income.push(...newIncome);
                            data.expenses.push(...newExpenses);
                            data.clients.push(...newClients);
                            data.debts.push(...newDebts);
                            data.serviceTemplates.push(...newTemplates);
                        });
                        this.showNotification('Данные объединены');
                    } else {
                        this.loadState(parsed); 
                        this.showNotification('Данные импортированы и заменены');
                    }
                } else { 
                    this.showNotification('Неверный формат файла импорта', 'danger'); 
                } 
            } catch (err) { 
                this.showNotification('Ошибка импорта', 'danger'); 
                console.error(err);
            } 
        }; 
        reader.readAsText(file); 
        e.target.value = ''; 
    }
    
    async clearAllData() { 
        if (await this.confirmAction({text: 'Вы уверены? Это действие необратимо.'})) {
            const settings = this.data.settings;
            this.updateState(data => {
                data.expenses = []; data.income = []; data.clients = []; data.debts = [];
                data.settings = settings;
            }); 
            this.showNotification('Все данные удалены (настройки сохранены)', 'danger');
        }
    }

    copySummary() { 
        this.updateAllCalculations();
        let text = 'Сводка:\n'; 
        getAll('.summary-category').forEach(cat => { 
            text += `\n--- ${cat.querySelector('h2').textContent} ---\n`; 
            cat.querySelectorAll('.result-card').forEach(card => { 
                text += `${card.querySelector('.label').textContent.trim()}: ${card.querySelector('.value').textContent.trim()}\n`; 
            }); 
        }); 
        this.copyToClipboard(text.trim()); 
    }
    
    async copyToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
            try {
                await navigator.clipboard.writeText(text); this.showNotification('Скопировано!');
            } catch (err) { this.copyToClipboardFallback(text); }
        } else { this.copyToClipboardFallback(text); }
    }
    
    copyToClipboardFallback(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = 'fixed'; textArea.style.top = '-9999px';
        document.body.appendChild(textArea);
        textArea.focus(); textArea.select();
        try {
            document.execCommand('copy'); this.showNotification('Скопировано!');
        } catch (err) { this.showNotification('Ошибка копирования', 'danger'); }
        document.body.removeChild(textArea);
    }
    
    applySettings() {
        const s = this.data.settings;
        document.body.className = '';
        if (s.theme === 'light') document.body.classList.add('light-theme');
        if (!s.animations) document.body.classList.add('animations-disabled');
        if (s.tableDensity && s.tableDensity !== 'normal') document.body.classList.add(`table-density-${s.tableDensity}`);
        if (s.fontSize && s.fontSize !== 'normal') document.body.classList.add(`font-size-${s.fontSize}`);
        document.documentElement.style.setProperty('--primary', s.primaryColor);
        
        get('#primaryColorPicker').value = s.primaryColor;
        get('#currencySymbol').value = s.currency;
        this.updateSettingsUI('#theme-switcher', 'theme', s.theme);
        this.updateSettingsUI('#animation-switcher', 'anim', s.animations ? 'on' : 'off');
        this.updateSettingsUI('#density-switcher', 'density', s.tableDensity);
        this.updateSettingsUI('#font-size-switcher', 'size', s.fontSize);
        this.updateSettingsUI('#confirm-delete-switcher', 'confirm', s.confirmDelete ? 'on' : 'off');
        this.updateSettingsUI('#best-client-metric-switcher', 'metric', s.bestClientMetric);
        this.updateSettingsUI('#show-paid-debts-switcher', 'show', s.showPaidDebts ? 'on' : 'off');
    }
    
    updateSetting(key, value, recordHistory = true) {
        this.updateState(data => { data.settings[key] = value; }, recordHistory);
    }
    updateSettingsUI(containerId, dataAttr, value) { getAll(`${containerId} button`).forEach(btn => btn.classList.toggle('active', btn.dataset[dataAttr] == value)); }
    
    async resetSettings() { 
        if(await this.confirmAction({text: 'Сбросить все настройки к значениям по умолчанию?'})) {
            this.updateState(data => { data.settings = new TireServiceApp().data.settings; });
        }
    }

    switchTab(tabName, callback) {
        get('.tab.active')?.classList.remove('active');
        get('.tab-content.active')?.classList.remove('active');
        get(`.tab[data-tab="${tabName}"]`).classList.add('active');
        get(`#${tabName}`).classList.add('active');
        if (callback) setTimeout(callback, 50);
    }

    addOrUpdateServiceTemplate() {
        const nameInput = get('#templateName');
        const priceInput = get('#templatePrice');
        const countInput = get('#templateCount');
        const typeInput = get('#templateType');
        const name = nameInput.value.trim();
        const price = this.parseMoney(priceInput.value);
        const count = parseInt(countInput.value) || 1;
        const type = typeInput.value;
        
        if (!name || price <= 0) {
            this.showNotification('Введите корректное название и цену', 'danger');
            return;
        }

        this.updateState(data => {
            if (this.editingTemplateIndex !== null) {
                data.serviceTemplates[this.editingTemplateIndex] = { name, price, count, type };
            } else {
                data.serviceTemplates.push({ name, price, count, type });
            }
        });
        
        this.resetTemplateForm();
    }
    
    editServiceTemplate(index) {
        const template = this.data.serviceTemplates[index];
        if (!template) return;
        
        this.editingTemplateIndex = index;
        get('#templateName').value = template.name;
        get('#templatePrice').value = template.price;
        get('#templateCount').value = template.count;
        get('#templateType').value = template.type;
        get('#addServiceTemplateBtn').textContent = 'Сохранить';
        get('#addServiceTemplateBtn').classList.add('success');
        get('#templateName').focus();
    }

    resetTemplateForm() {
        this.editingTemplateIndex = null;
        get('#templateName').value = '';
        get('#templatePrice').value = '';
        get('#templateCount').value = '1';
        get('#templateType').value = 'income';
        const btn = get('#addServiceTemplateBtn');
        btn.textContent = 'Добавить';
        btn.classList.remove('success');
    }

    async deleteServiceTemplate(index) { 
        if (this.data.settings.confirmDelete && !await this.confirmAction({text: "Удалить этот шаблон?"})) return;
        this.updateState(data => { data.serviceTemplates.splice(index, 1); }); 
    }

    renderServiceTemplates() { 
        const list = get('#service-templates-list');
        const incomeDatalist = get('#service-templates-datalist-income');
        const expenseDatalist = get('#service-templates-datalist-expense');
        list.innerHTML = '';
        incomeDatalist.innerHTML = '';
        expenseDatalist.innerHTML = '';
        (this.data.serviceTemplates || []).forEach((template, index) => {
            const isIncome = template.type === 'income';
            list.innerHTML += `
            <div class="template-item ${isIncome ? 'income-template' : 'expense-template'}" data-index="${index}">
                <span>${template.name} - ${template.count}шт x ${this.renderMoney(template.price)}</span>
                <div class="template-actions">
                    <button class="btn-action btn-edit" title="Редактировать шаблон">✎</button>
                    <button class="btn-action btn-delete" title="Удалить шаблон">✖</button>
                </div>
            </div>`;
            const option = `<option value="${template.name}">`;
            if (isIncome) {
                incomeDatalist.innerHTML += option;
            } else {
                expenseDatalist.innerHTML += option;
            }
        }); 
    }

    sortTable(tableKey, newKey) {
        const sortState = this.data.settings.sort[tableKey];
        let newDir = 'desc';
        if (sortState.key === newKey) {
            newDir = sortState.dir === 'desc' ? 'asc' : 'desc';
        }
        this.updateState(data => {
            data.settings.sort[tableKey] = { key: newKey, dir: newDir };
        }, false);
        this.render();
    }

    updateSortHeaders() {
        getAll('th[data-sort-key]').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
            th.setAttribute('aria-sort', 'none');
        });
        ['income', 'expenses', 'clients', 'debts'].forEach(key => {
            const sortState = this.data.settings.sort[key];
            if (sortState && sortState.key) {
                const header = get(`#${key}Table th[data-sort-key="${sortState.key}"]`);
                if (header) {
                    const direction = sortState.dir === 'asc' ? 'ascending' : 'descending';
                    header.classList.add(`sort-${sortState.dir}`);
                    header.setAttribute('aria-sort', direction);
                }
            }
        });
    }

    handleCalculatorInput(key) {
        if (/\d/.test(key)) { this.inputDigit(key); }
        else if (key === '.') { this.inputDecimal(); }
        else if (['+', '-', '*', '/'].includes(key)) { this.handleOperator(key); }
        else if (key === '=') { this.handleEquals(); }
        else if (key === 'clear') { this.resetCalculator(); }
        else if (key === 'backspace') { this.backspace(); }
        else if (key === 'percent') { this.handlePercent(); }
        this.updateCalculatorDisplay();
    }
    inputDigit(digit) {
        const { displayValue, waitingForSecondOperand } = this.calculatorState;
        if (waitingForSecondOperand) {
            this.calculatorState.displayValue = digit;
            this.calculatorState.waitingForSecondOperand = false;
        } else {
            this.calculatorState.displayValue = displayValue === '0' ? digit : displayValue + digit;
        }
    }
    inputDecimal() {
        if (this.calculatorState.waitingForSecondOperand) {
            this.calculatorState.displayValue = '0.';
            this.calculatorState.waitingForSecondOperand = false;
            return;
        }
        if (!this.calculatorState.displayValue.includes('.')) {
            this.calculatorState.displayValue += '.';
        }
    }
    handleOperator(nextOperator) {
        const { firstOperand, displayValue, operator } = this.calculatorState;
        const inputValue = parseFloat(displayValue);
        if (operator && this.calculatorState.waitingForSecondOperand) {
            this.calculatorState.operator = nextOperator;
            return;
        }
        if (firstOperand === null) {
            this.calculatorState.firstOperand = inputValue;
        } else if (operator) {
            const result = this.calculate(firstOperand, inputValue, operator);
            this.calculatorState.displayValue = `${parseFloat(result.toFixed(7))}`;
            this.calculatorState.firstOperand = result;
        }
        this.calculatorState.waitingForSecondOperand = true;
        this.calculatorState.operator = nextOperator;
    }
    calculate(first, second, op) {
        if (op === '+') return first + second;
        if (op === '-') return first - second;
        if (op === '*') return first * second;
        if (op === '/') return first / second;
        return second;
    }
    handleEquals() {
        const { firstOperand, displayValue, operator } = this.calculatorState;
        if (firstOperand === null || operator === null) return;
        const secondOperand = parseFloat(displayValue);
        const result = this.calculate(firstOperand, secondOperand, operator);
        this.calculatorState.displayValue = `${parseFloat(result.toFixed(7))}`;
        this.calculatorState.firstOperand = null;
        this.calculatorState.operator = null;
        this.calculatorState.waitingForSecondOperand = false;
    }
    resetCalculator() {
        this.calculatorState = { displayValue: '0', firstOperand: null, waitingForSecondOperand: false, operator: null };
    }
    backspace() {
        const { displayValue } = this.calculatorState;
        this.calculatorState.displayValue = displayValue.slice(0, -1) || '0';
    }
    handlePercent() {
        const { displayValue } = this.calculatorState;
        const value = parseFloat(displayValue);
        this.calculatorState.displayValue = `${value / 100}`;
    }
    updateCalculatorDisplay() {
        const display = get('#calculator-display');
        display.textContent = this.calculatorState.displayValue;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const app = new TireServiceApp();
    app.init();
});
</script>
</body>
</html>
