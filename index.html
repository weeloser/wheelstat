<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>–£—á–µ—Ç –®–∏–Ω–æ–º–æ–Ω—Ç–∞–∂–∞ Pro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
    --primary: #3b82f6;
    --primary-dark: #2563eb;
    --primary-light: #60a5fa;
    --primary-glow: rgba(59, 130, 246, 0.4);
    --bg-body: #0f172a;
    --bg-card: rgba(30, 41, 59, 0.7);
    --bg-card-hover: rgba(51, 65, 85, 0.9);
    --bg-input: rgba(15, 23, 42, 0.5);
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --border: rgba(148, 163, 184, 0.15);
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --radius: 12px;
    --nav-height: 76px;
    --sidebar-width: 260px;
    --header-height: 64px;
    --transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
    --glass: blur(12px) saturate(160%);
    --font-scale: 1;
    --table-padding: 14px;
    --font-main: 'Inter', sans-serif;
}

/* Glass Design Overrides */
body.design-glass {
    --bg-body: #09090b;
    --bg-card: rgba(255, 255, 255, 0.03);
    --bg-card-hover: rgba(255, 255, 255, 0.08);
    --bg-input: rgba(0, 0, 0, 0.2);
    --border: rgba(255, 255, 255, 0.08);
    --glass: blur(24px) saturate(180%);
    --radius: 24px;
    --font-main: 'Outfit', sans-serif;
    background-image: 
        radial-gradient(circle at 15% 50%, rgba(var(--primary-rgb), 0.15) 0%, transparent 40%),
        radial-gradient(circle at 85% 30%, rgba(139, 92, 246, 0.15) 0%, transparent 40%),
        radial-gradient(circle at 50% 90%, rgba(16, 185, 129, 0.1) 0%, transparent 50%);
    background-color: #050505;
}

body.design-glass.light-theme {
    --bg-body: #fdfdfd;
    --bg-card: rgba(255, 255, 255, 0.4);
    --bg-card-hover: rgba(255, 255, 255, 0.7);
    --bg-input: rgba(255, 255, 255, 0.5);
    --border: rgba(0, 0, 0, 0.06);
    background-image: 
        radial-gradient(circle at 15% 50%, rgba(var(--primary-rgb), 0.08) 0%, transparent 40%),
        radial-gradient(circle at 85% 30%, rgba(139, 92, 246, 0.08) 0%, transparent 40%);
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
body { font-family: var(--font-main); background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; font-size: calc(14px * var(--font-scale)); background-image: radial-gradient(circle at 5% 10%, rgba(var(--primary-rgb), 0.1) 0%, transparent 25%), radial-gradient(circle at 95% 90%, rgba(16, 185, 129, 0.05) 0%, transparent 25%); transition: background 0.3s ease; }
body.light-theme {
    --bg-body: #f1f5f9;
    --bg-card: rgba(255, 255, 255, 0.9);
    --bg-card-hover: #ffffff;
    --bg-input: rgba(241, 245, 249, 0.9);
    --text-main: #0f172a;
    --text-muted: #64748b;
    --border: rgba(148, 163, 184, 0.25);
}
body.compact-mode { --table-padding: 6px; }
body.no-anim * { animation: none !important; transition: none !important; }

::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

input, select, textarea, button { font-family: inherit; border: none; background: transparent; color: inherit; font-size: inherit; }
button { cursor: pointer; user-select: none; }

.app-container { display: flex; width: 100%; height: 100%; position: relative; z-index: 1; }

/* Sidebar Styling */
.sidebar { width: var(--sidebar-width); background: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; backdrop-filter: var(--glass); -webkit-backdrop-filter: var(--glass); z-index: 20; transition: all 0.3s ease; flex-shrink: 0; }

body.design-glass .sidebar {
    background: linear-gradient(160deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
    border: 1px solid var(--border);
    margin: 16px;
    margin-right: 0;
    border-radius: var(--radius);
    height: calc(100% - 32px);
    box-shadow: 0 20px 40px -10px rgba(0,0,0,0.3);
}

.logo-area { height: var(--header-height); display: flex; align-items: center; padding: 0 24px; font-weight: 800; font-size: 1.4rem; letter-spacing: -0.5px; color: var(--text-main); border-bottom: 1px solid var(--border); gap: 12px; }
body.design-glass .logo-area { border-bottom: 1px solid transparent; background: linear-gradient(90deg, rgba(255,255,255,0.03), transparent); }

.logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius: 10px; display: grid; place-items: center; color: white; box-shadow: 0 4px 12px var(--primary-glow); position: relative; overflow: hidden; font-size: 1.2rem; }
body.design-glass .logo-icon { border-radius: 12px; box-shadow: 0 0 20px var(--primary-glow); }

.nav-menu { flex: 1; overflow-y: auto; padding: 20px 12px; display: flex; flex-direction: column; gap: 4px; }
.nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 14px; color: var(--text-muted); text-decoration: none; border-radius: 10px; transition: all 0.2s ease; font-weight: 500; font-size: 0.95rem; }
.nav-item:hover { background: rgba(255, 255, 255, 0.03); color: var(--text-main); }
.nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px var(--primary-glow); font-weight: 600; }
body.design-glass .nav-item { border-radius: 14px; }
body.design-glass .nav-item.active { background: linear-gradient(90deg, var(--primary), var(--primary-dark)); box-shadow: 0 8px 24px -4px var(--primary-glow); border: 1px solid rgba(255,255,255,0.1); }

.nav-item svg { width: 20px; height: 20px; stroke-width: 2px; }

/* Main Content */
.main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; min-width: 0; }
body.design-glass .main-content { padding: 16px; gap: 16px; }

.top-header { height: var(--header-height); background: var(--bg-card); backdrop-filter: var(--glass); -webkit-backdrop-filter: var(--glass); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; z-index: 10; flex-shrink: 0; transition: all 0.3s; }
body.design-glass .top-header { border-radius: var(--radius); border: 1px solid var(--border); background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.2); margin-bottom: 0; }

.header-title { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.5px; }
.header-actions { display: flex; gap: 10px; }
.icon-btn { width: 38px; height: 38px; border-radius: 10px; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); display: grid; place-items: center; font-size: 1.1rem; transition: all 0.2s ease; }
.icon-btn:hover { border-color: var(--primary); color: var(--primary); background: var(--bg-card-hover); }
.icon-btn:active { transform: scale(0.95); }
body.design-glass .icon-btn { border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }

.content-scroll { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; scroll-behavior: smooth; }
body.design-glass .content-scroll { padding: 0; padding-bottom: 20px; }

.tab-content { display: none; height: 100%; flex-direction: column; }
.tab-content.active { display: flex; }

.dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px; }
.stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; position: relative; overflow: hidden; transition: transform 0.2s ease; backdrop-filter: blur(10px); }
body.design-glass .stat-card { background: linear-gradient(145deg, rgba(255,255,255,0.06), rgba(255,255,255,0.01)); border: 1px solid var(--border); box-shadow: 0 10px 30px -5px rgba(0,0,0,0.2); }
.stat-card:hover { border-color: var(--primary); transform: translateY(-2px); }

.stat-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.stat-value { font-size: 1.8rem; font-weight: 800; color: var(--text-main); line-height: 1; letter-spacing: -0.5px; }

.controls-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; background: var(--bg-card); padding: 10px; border-radius: 16px; border: 1px solid var(--border); flex-shrink: 0; }
body.design-glass .controls-bar { background: linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.1); }

.btn { padding: 10px 20px; border-radius: 10px; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 8px; background: var(--primary); color: white; font-size: 0.95rem; transition: all 0.2s; white-space: nowrap; height: 40px; }
body.design-glass .btn { border-radius: 12px; box-shadow: 0 4px 15px var(--primary-glow); border: 1px solid rgba(255,255,255,0.1); }
.btn:hover { filter: brightness(1.1); box-shadow: 0 4px 12px var(--primary-glow); }
.btn:active { transform: scale(0.97); }

.btn.ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
.btn.ghost:hover { border-color: var(--text-main); color: var(--text-main); background: rgba(255,255,255,0.05); }
.btn.danger { background: var(--danger); --primary-glow: rgba(239, 68, 68, 0.4); }
.btn.warning { background: var(--warning); --primary-glow: rgba(245, 158, 11, 0.4); }
.btn.success { background: var(--success); --primary-glow: rgba(16, 185, 129, 0.4); }

.search-input { flex: 1; background: var(--bg-input); border: 1px solid transparent; padding: 0 16px; height: 40px; border-radius: 10px; color: var(--text-main); min-width: 200px; transition: all 0.2s ease; font-weight: 500; font-size: 0.95rem; }
.search-input:focus { background: var(--bg-card); border-color: var(--primary); }

.data-table-container { flex: 1; border-radius: 16px; border: 1px solid var(--border); background: var(--bg-card); overflow: auto; display: flex; flex-direction: column; }
body.design-glass .data-table-container { background: rgba(255,255,255,0.02); backdrop-filter: var(--glass); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.2); border: 1px solid var(--border); }

.data-table { width: 100%; border-collapse: collapse; text-align: left; position: relative; }
.data-table th { position: sticky; top: 0; z-index: 5; background: var(--bg-body); color: var(--text-muted); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; padding: 12px var(--table-padding); border-bottom: 1px solid var(--border); cursor: pointer; user-select: none; white-space: nowrap; }
body.design-glass .data-table th { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); color: var(--primary-light); }
body.design-glass.light-theme .data-table th { background: rgba(241, 245, 249, 0.9); color: var(--primary-dark); }
.data-table th::after { content: ''; position: absolute; left: 0; right: 0; bottom: -1px; height: 1px; background: var(--border); }
.data-table th:hover { color: var(--primary); }
.data-table td { padding: var(--table-padding); border-bottom: 1px solid var(--border); vertical-align: middle; transition: background 0.1s; font-variant-numeric: tabular-nums; }
.data-table tr:hover td { background: rgba(255,255,255,0.02); }
.data-table tr:last-child td { border-bottom: none; }

.table-input { background: transparent; border: 1px solid transparent; color: inherit; padding: 4px 8px; border-radius: 6px; width: 100%; transition: all 0.2s; font-weight: 400; font-size: inherit; }
.table-input:hover { background: var(--bg-input); }
.table-input:focus { background: var(--bg-input); border-color: var(--primary); }

.btn-trash { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); transition: all 0.2s; background: transparent; opacity: 0.6; }
.btn-trash:hover { background: rgba(239, 68, 68, 0.15); color: var(--danger); opacity: 1; }

.badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.3px; text-transform: uppercase; display: inline-flex; align-items: center; justify-content: center; width: 100px; }
.badge.paid { background: rgba(16, 185, 129, 0.15); color: var(--success); }
.badge.unpaid { background: rgba(239, 68, 68, 0.15); color: var(--danger); }

.todo-item { display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); margin-bottom: 8px; transition: all 0.2s; }
body.design-glass .todo-item { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); }
.todo-item:hover { border-color: var(--primary); transform: translateX(4px); }
.todo-item.completed { opacity: 0.5; text-decoration: line-through; border-color: transparent; }

.settings-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; overflow-y: auto; padding-bottom: 20px; }
.settings-group { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; height: fit-content; }
body.design-glass .settings-group { background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01)); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.3); }

.settings-group h3 { margin-bottom: 20px; color: var(--primary); font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
.setting-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--border); }
.setting-row:last-child { border-bottom: none; }

.toggle-switch { position: relative; width: 48px; height: 26px; background: rgba(255,255,255,0.1); border-radius: 20px; cursor: pointer; transition: 0.3s; border: 1px solid var(--border); }
.toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 4px rgba(0,0,0,0.2); }
.toggle-switch.active { background: var(--primary); border-color: var(--primary); }
.toggle-switch.active::after { left: 24px; }

.color-picker { display: flex; gap: 8px; }
.color-btn { width: 28px; height: 28px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; transition: transform 0.2s; position: relative; }
.color-btn.active { border-color: var(--text-main); transform: scale(1.1); }
.color-btn::after { content: ''; position: absolute; inset: 2px; border-radius: 50%; background: var(--color); }

.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
.modal-overlay.visible { opacity: 1; pointer-events: auto; }
.modal { background: #1e293b; border: 1px solid var(--border); border-radius: 24px; padding: 32px; width: 90%; max-width: 420px; transform: scale(0.95); transition: transform 0.2s; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
body.design-glass .modal { background: rgba(20, 20, 25, 0.95); backdrop-filter: blur(40px); border: 1px solid rgba(255,255,255,0.1); }
.modal-overlay.visible .modal { transform: scale(1); }
.modal h2 { margin-bottom: 12px; color: var(--text-main); font-size: 1.4rem; font-weight: 700; }
.modal p { color: var(--text-muted); margin-bottom: 24px; line-height: 1.5; }

.mini-calc { position: fixed; bottom: 40px; right: 40px; width: 280px; background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: 20px; z-index: 90; box-shadow: 0 20px 60px rgba(0,0,0,0.4); display: none; overflow: hidden; transform-origin: bottom right; }
body.design-glass .mini-calc { background: rgba(10, 10, 15, 0.8); border: 1px solid rgba(255,255,255,0.1); }
.mini-calc.visible { display: block; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.calc-header { background: var(--primary); color: white; padding: 14px 20px; display: flex; justify-content: space-between; align-items: center; cursor: move; font-weight: 600; font-size: 0.9rem; }
.calc-display { background: rgba(0,0,0,0.2); padding: 20px; text-align: right; font-size: 2rem; font-weight: 300; font-family: monospace; color: white; letter-spacing: -1px; word-break: break-all; }
.calc-pad { display: grid; grid-template-columns: repeat(4, 1fr); padding: 10px; gap: 8px; }
.calc-btn { border-radius: 12px; font-size: 1.2rem; height: 50px; background: rgba(255,255,255,0.05); transition: background 0.1s; }
.calc-btn:hover { background: rgba(255,255,255,0.1); }
.calc-btn:active { background: rgba(255,255,255,0.15); }
.calc-btn.op { color: var(--primary-light); font-weight: 700; background: rgba(var(--primary-rgb), 0.15); }
.calc-btn.eq { background: var(--primary); color: white; grid-column: span 4; font-weight: 700; margin-top: 4px; }

.toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 200; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
.toast { background: var(--bg-card); backdrop-filter: blur(12px); padding: 14px 24px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: slideInToast 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); display: flex; align-items: center; gap: 12px; border: 1px solid var(--border); border-left: 4px solid var(--primary); font-weight: 500; pointer-events: auto; }
@keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
@keyframes slideInToast { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }

@media (max-width: 768px) {
    body { flex-direction: column; }
    .sidebar { position: fixed; bottom: 0; left: 0; width: 100%; height: calc(70px + env(safe-area-inset-bottom)); padding-bottom: env(safe-area-inset-bottom); flex-direction: row; border-right: none; border-top: 1px solid var(--border); background: rgba(15, 23, 42, 0.98); justify-content: space-evenly; align-items: center; padding-top: 6px; z-index: 100; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); }
    body.design-glass .sidebar { width: 100%; height: calc(70px + env(safe-area-inset-bottom)); margin: 0; border-radius: 0; border: none; border-top: 1px solid var(--border); background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(20px); }
    
    .logo-area { display: none; }
    .nav-menu { flex-direction: row; overflow-x: auto; width: 100%; padding: 0 6px; gap: 6px; height: auto; align-items: center; justify-content: space-between; }
    .nav-item { flex-direction: column; gap: 4px; padding: 8px 4px; flex: 1; border-radius: 8px; font-size: 0.6rem; justify-content: center; text-align: center; color: var(--text-muted); min-width: 50px; background: transparent !important; box-shadow: none !important; }
    .nav-item.active { color: var(--primary); }
    .nav-item.active svg { stroke: var(--primary); transform: translateY(-2px); }
    .nav-item svg { width: 22px; height: 22px; }
    .nav-item span { display: block; font-size: 0.6rem; margin-top: 2px; }
    .main-content { height: 100%; padding-bottom: calc(76px + env(safe-area-inset-bottom)); }
    body.design-glass .main-content { padding: 0; padding-bottom: calc(80px + env(safe-area-inset-bottom)); gap: 0; }
    
    .top-header { padding: 0 16px; height: 56px; }
    body.design-glass .top-header { margin: 16px; margin-bottom: 0; border-radius: 16px; width: auto; }
    .header-title { font-size: 1.2rem; }
    .content-scroll { padding: 16px; padding-bottom: 20px; }
    body.design-glass .content-scroll { padding: 16px; }
    
    .dashboard-grid { grid-template-columns: 1fr 1fr; gap: 12px; }
    .stat-card { padding: 16px; }
    .stat-value { font-size: 1.4rem; }
    .controls-bar { padding: 8px; gap: 8px; }
    .btn { padding: 8px 16px; font-size: 0.9rem; flex: 1; }
    .search-input { width: 100%; min-width: 0; }
    .data-table-container { background: transparent; border: none; overflow: visible; display: block; box-shadow: none; }
    body.design-glass .data-table-container { background: transparent; box-shadow: none; border: none; }
    .data-table thead { display: none; }
    .data-table, .data-table tbody, .data-table tr, .data-table td { display: block; width: 100%; }
    .data-table tr { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 12px; position: relative; overflow: hidden; }
    body.design-glass .data-table tr { background: rgba(255,255,255,0.03); }
    .data-table td { display: grid; grid-template-columns: 100px 1fr; align-items: center; padding: 12px 16px; text-align: right; gap: 12px; height: auto; border-bottom: 1px solid rgba(255,255,255,0.03); }
    .data-table td::before { content: attr(data-label); font-weight: 600; color: var(--text-muted); font-size: 0.8rem; text-align: left; text-transform: uppercase; }
    .table-input { text-align: right; width: 100%; padding: 0; }
    .mini-calc { top: 50%; left: 50%; transform: translate(-50%, -50%) !important; width: 90%; max-width: 320px; bottom: auto; right: auto; }
}
</style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <div class="logo-area">
            <div class="logo-icon">P</div>
            ShinaPro
        </div>
        <nav class="nav-menu">
            <a class="nav-item active" data-tab="total">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                <span>–ì–ª–∞–≤–Ω–∞—è</span>
            </a>
            <a class="nav-item" data-tab="income">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span>–î–æ—Ö–æ–¥—ã</span>
            </a>
            <a class="nav-item" data-tab="expenses">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span>–†–∞—Å—Ö–æ–¥—ã</span>
            </a>
            <a class="nav-item" data-tab="clients">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                <span>–ö–ª–∏–µ–Ω—Ç—ã</span>
            </a>
            <a class="nav-item" data-tab="warehouse">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                <span>–°–∫–ª–∞–¥</span>
            </a>
            <a class="nav-item" data-tab="debts">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span>–î–æ–ª–≥–∏</span>
            </a>
            <a class="nav-item" data-tab="todos">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                <span>–ó–∞–¥–∞—á–∏</span>
            </a>
            <a class="nav-item" data-tab="settings">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066 2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            </a>
        </nav>
    </aside>

    <main class="main-content">
        <header class="top-header">
            <div class="header-title" id="page-title">–û–±–∑–æ—Ä</div>
            <div class="header-actions">
                <button class="icon-btn" id="undoBtn" title="–û—Ç–º–µ–Ω–∏—Ç—å">‚Ü∂</button>
                <button class="icon-btn" id="redoBtn" title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å">‚Ü∑</button>
                <button class="icon-btn" id="calcBtn" title="–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä">üßÆ</button>
            </div>
        </header>

        <div class="content-scroll">
            <div id="total" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="stat-card success">
                        <div class="stat-label">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</div>
                        <div class="stat-value" id="totalProfit">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–î–æ—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</div>
                        <div class="stat-value" id="incomeToday">0</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-label">–†–∞—Å—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</div>
                        <div class="stat-value" id="expenseToday">0</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-label">–ù–∞ —Å–∫–ª–∞–¥–µ</div>
                        <div class="stat-value" id="warehouseCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ö–ª–∏–µ–Ω—Ç—ã</div>
                        <div class="stat-value" id="clientsCount">0</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-label">–°—É–º–º–∞ –¥–æ–ª–≥–æ–≤</div>
                        <div class="stat-value" id="debtsTotal">0</div>
                    </div>
                </div>

                <div class="controls-bar">
                    <button class="btn ghost" id="importBtn">–ò–º–ø–æ—Ä—Ç</button>
                    <button class="btn ghost" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
                    <button class="btn danger" id="clearBtn">–°–±—Ä–æ—Å</button>
                    <input type="text" id="globalSearch" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–π –±–∞–∑–µ...">
                </div>
                <div id="globalSearchResults"></div>
            </div>

            <div id="income" class="tab-content">
                <div class="controls-bar">
                    <button class="btn success" onclick="app.addIncomeRow()">+ –î–æ—Ö–æ–¥</button>
                    <input type="text" class="search-input" id="incomeSearch" placeholder="–ü–æ–∏—Å–∫ –¥–æ—Ö–æ–¥–∞...">
                </div>
                <div class="data-table-container">
                    <table class="data-table" id="incomeTable">
                        <thead>
                            <tr>
                                <th width="140" onclick="app.sort('income', 'date')">–î–∞—Ç–∞</th>
                                <th onclick="app.sort('income', 'service')">–£—Å–ª—É–≥–∞</th>
                                <th width="100" onclick="app.sort('income', 'price')">–¶–µ–Ω–∞</th>
                                <th width="80">–ö–æ–ª-–≤–æ</th>
                                <th width="100" onclick="app.sort('income', 'total')">–ò—Ç–æ–≥–æ</th>
                                <th width="50"></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="expenses" class="tab-content">
                <div class="controls-bar">
                    <button class="btn danger" onclick="app.addExpenseRow()">+ –†–∞—Å—Ö–æ–¥</button>
                    <input type="text" class="search-input" id="expenseSearch" placeholder="–ü–æ–∏—Å–∫ —Ä–∞—Å—Ö–æ–¥–∞...">
                </div>
                <div class="data-table-container">
                    <table class="data-table" id="expensesTable">
                        <thead>
                            <tr>
                                <th width="140" onclick="app.sort('expenses', 'date')">–î–∞—Ç–∞</th>
                                <th onclick="app.sort('expenses', 'desc')">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                <th width="100" onclick="app.sort('expenses', 'price')">–¶–µ–Ω–∞</th>
                                <th width="80">–ö–æ–ª-–≤–æ</th>
                                <th width="100" onclick="app.sort('expenses', 'total')">–ò—Ç–æ–≥–æ</th>
                                <th width="50"></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="clients" class="tab-content">
                <div class="controls-bar">
                    <button class="btn" onclick="app.addClientRow()">+ –ö–ª–∏–µ–Ω—Ç</button>
                    <input type="text" class="search-input" id="clientSearch" placeholder="–ò–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –∞–≤—Ç–æ...">
                </div>
                <div class="data-table-container">
                    <table class="data-table" id="clientsTable">
                        <thead>
                            <tr>
                                <th width="140">–î–∞—Ç–∞</th>
                                <th>–ò–º—è</th>
                                <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                <th>–ê–≤—Ç–æ</th>
                                <th width="80">–í–∏–∑–∏—Ç–æ–≤</th>
                                <th width="50"></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="warehouse" class="tab-content">
                <div class="controls-bar">
                    <button class="btn warning" onclick="app.addWarehouseRow()">+ –¢–æ–≤–∞—Ä</button>
                    <input type="text" class="search-input" id="warehouseSearch" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞...">
                </div>
                <div class="data-table-container">
                    <table class="data-table" id="warehouseTable">
                        <thead>
                            <tr>
                                <th onclick="app.sort('warehouse', 'name')">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th width="120" onclick="app.sort('warehouse', 'qty')">–û—Å—Ç–∞—Ç–æ–∫</th>
                                <th width="50"></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="debts" class="tab-content">
                <div class="controls-bar">
                    <button class="btn danger" onclick="app.addDebtRow()">+ –î–æ–ª–≥</button>
                    <input type="text" class="search-input" id="debtSearch" placeholder="–ü–æ–∏—Å–∫ –¥–æ–ª–∂–Ω–∏–∫–∞...">
                </div>
                <div class="data-table-container">
                    <table class="data-table" id="debtsTable">
                        <thead>
                            <tr>
                                <th width="140">–î–∞—Ç–∞</th>
                                <th>–ò–º—è</th>
                                <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                <th width="120">–°—É–º–º–∞</th>
                                <th width="120">–°—Ç–∞—Ç—É—Å</th>
                                <th width="50"></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="todos" class="tab-content">
                <div class="controls-bar">
                    <input type="text" id="newTodoInput" class="search-input" placeholder="–¢–µ–∫—Å—Ç –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏...">
                    <button class="btn success" onclick="app.addTodo()">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                <div id="todoList"></div>
            </div>

            <div id="settings" class="tab-content">
                <div class="settings-container">
                    <div class="settings-group">
                        <h3>üé® –í–Ω–µ—à–Ω–∏–π –≤–∏–¥</h3>
                        <div class="setting-row">
                            <span>–î–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</span>
                            <select class="table-input" id="designSelect" style="width:auto; text-align:right;">
                                <option value="default">–°—Ç–∞–Ω–¥–∞—Ä—Ç</option>
                                <option value="glass">Glass Future</option>
                            </select>
                        </div>
                        <div class="setting-row">
                            <span>–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                            <div class="toggle-switch active" id="themeToggle"></div>
                        </div>
                        <div class="setting-row">
                            <span>–ö–æ–º–ø–∞–∫—Ç–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</span>
                            <div class="toggle-switch" id="compactToggle"></div>
                        </div>
                        <div class="setting-row">
                            <span>–ê–Ω–∏–º–∞—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</span>
                            <div class="toggle-switch active" id="animToggle"></div>
                        </div>
                        <div class="setting-row">
                            <span>–¶–≤–µ—Ç –∞–∫—Ü–µ–Ω—Ç–∞</span>
                            <div class="color-picker" id="colorPicker">
                                <div class="color-btn" data-color="#3b82f6" style="--color: #3b82f6"></div>
                                <div class="color-btn" data-color="#8b5cf6" style="--color: #8b5cf6"></div>
                                <div class="color-btn" data-color="#10b981" style="--color: #10b981"></div>
                                <div class="color-btn" data-color="#f59e0b" style="--color: #f59e0b"></div>
                            </div>
                        </div>
                         <div class="setting-row">
                            <span>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞</span>
                            <select class="table-input" id="scaleSelect" style="width:auto; text-align:right;">
                                <option value="0.9">–ú–µ–ª–∫–∏–π</option>
                                <option value="1" selected>–ù–æ—Ä–º–∞</option>
                                <option value="1.1">–ö—Ä—É–ø–Ω—ã–π</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3>‚öôÔ∏è –°–∏—Å—Ç–µ–º–∞</h3>
                        <div class="setting-row">
                            <span>–í–∞–ª—é—Ç–∞</span>
                            <input type="text" class="table-input" id="currencyInput" value="‚ÇΩ" style="width: 50px; text-align: center; background: var(--bg-input);">
                        </div>
                        <div class="setting-row">
                            <span>–ü–æ–ª–æ–∂–µ–Ω–∏–µ –≤–∞–ª—é—Ç—ã</span>
                            <select class="table-input" id="currencyPosSelect" style="width:auto; text-align:right;">
                                <option value="right">100 ‚ÇΩ</option>
                                <option value="left">‚ÇΩ 100</option>
                            </select>
                        </div>
                        <div class="setting-row">
                            <span>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</span>
                            <div class="toggle-switch active" id="confirmToggle"></div>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3>üìã –®–∞–±–ª–æ–Ω—ã —É—Å–ª—É–≥</h3>
                        <div style="display:flex; gap:10px; margin-bottom:16px;">
                            <input type="text" id="tplName" class="search-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏">
                            <input type="number" id="tplPrice" class="search-input" placeholder="–¶–µ–Ω–∞" style="width: 100px; flex:none;">
                            <button class="btn success" onclick="app.addTemplate()">+</button>
                        </div>
                        <div id="templateList"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div class="mini-calc" id="miniCalc">
    <div class="calc-header" id="calcHeader">
        <span>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</span>
        <span id="closeCalc" style="cursor:pointer;opacity:0.8">‚úï</span>
    </div>
    <div class="calc-display" id="calcDisplay">0</div>
    <div class="calc-pad">
        <button class="calc-btn" onclick="calc.clear()">C</button>
        <button class="calc-btn op" onclick="calc.op('/')">√∑</button>
        <button class="calc-btn op" onclick="calc.op('*')">√ó</button>
        <button class="calc-btn" onclick="calc.del()">‚å´</button>
        <button class="calc-btn" onclick="calc.num(7)">7</button>
        <button class="calc-btn" onclick="calc.num(8)">8</button>
        <button class="calc-btn" onclick="calc.num(9)">9</button>
        <button class="calc-btn op" onclick="calc.op('-')">-</button>
        <button class="calc-btn" onclick="calc.num(4)">4</button>
        <button class="calc-btn" onclick="calc.num(5)">5</button>
        <button class="calc-btn" onclick="calc.num(6)">6</button>
        <button class="calc-btn op" onclick="calc.op('+')">+</button>
        <button class="calc-btn" onclick="calc.num(1)">1</button>
        <button class="calc-btn" onclick="calc.num(2)">2</button>
        <button class="calc-btn" onclick="calc.num(3)">3</button>
        <button class="calc-btn eq" onclick="calc.eq()">=</button>
        <button class="calc-btn" onclick="calc.num(0)" style="grid-column: span 2">0</button>
        <button class="calc-btn" onclick="calc.dot()">.</button>
    </div>
</div>

<div class="modal-overlay" id="confirmModal">
    <div class="modal">
        <h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h2>
        <p>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?</p>
        <div style="display:flex; justify-content:flex-end; gap:12px;">
            <button class="btn ghost" onclick="app.closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn danger" id="confirmBtnAction">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<div class="toast-container" id="toastArea"></div>
<input type="file" id="importFile" hidden accept=".json">
<datalist id="serviceList"></datalist>

<script>
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const uuid = () => 'id' + Date.now().toString(36) + Math.random().toString(36).substr(2);
const safeFloat = (v) => { const n = parseFloat(v); return isNaN(n) ? 0 : n; };

const calc = {
    curr: '0', prev: null, opVar: null,
    num(n) { this.curr = this.curr === '0' ? String(n) : this.curr + n; this.upd(); },
    dot() { if(!this.curr.includes('.')) this.curr += '.'; this.upd(); },
    op(o) { this.prev = this.curr; this.curr = ''; this.opVar = o; },
    eq() { 
        if(!this.prev || !this.opVar) return;
        const a = safeFloat(this.prev), b = safeFloat(this.curr || this.prev);
        let res = 0;
        if(this.opVar==='+') res = a+b;
        else if(this.opVar==='-') res = a-b;
        else if(this.opVar==='*') res = a*b;
        else if(this.opVar==='/') res = b !== 0 ? a/b : 0;
        this.curr = String(Math.round(res*10000)/10000); this.prev = null; this.opVar = null; this.upd(); 
    },
    clear() { this.curr='0'; this.prev=null; this.opVar=null; this.upd(); },
    del() { this.curr = this.curr.length > 1 ? this.curr.slice(0,-1) : '0'; this.upd(); },
    upd() { $('#calcDisplay').textContent = this.curr; }
};

class App {
    constructor() {
        try {
            const stored = localStorage.getItem('tireData');
            this.data = stored ? JSON.parse(stored) : this.getDefaultData();
        } catch (e) {
            this.data = this.getDefaultData();
        }
        
        if(!this.data.settings.color) this.data.settings.color = '#3b82f6';
        if(!this.data.settings.scale) this.data.settings.scale = '1';
        if(this.data.settings.anim === undefined) this.data.settings.anim = true;
        if(this.data.settings.compact === undefined) this.data.settings.compact = false;
        if(this.data.settings.currencyPos === undefined) this.data.settings.currencyPos = 'right';
        if(this.data.settings.design === undefined) this.data.settings.design = 'default';

        this.history = [];
        this.historyStep = -1;
        this.currentSort = { key: null, dir: 1 };
        this.init();
    }

    getDefaultData() {
        return {
            income: [], expenses: [], clients: [], warehouse: [], debts: [], todos: [], templates: [], 
            settings: { theme: 'dark', currency: '‚ÇΩ', confirm: true, color: '#3b82f6', scale: '1', anim: true, compact: false, currencyPos: 'right', design: 'default' }
        };
    }

    init() {
        this.applySettings();
        this.renderAll();
        this.setupListeners();
        this.setupDraggable();
        this.saveState(true); 
    }

    saveState(skipHistory = false) {
        if (!skipHistory) {
            if(this.historyStep < this.history.length - 1) {
                this.history = this.history.slice(0, this.historyStep + 1);
            }
            this.history.push(JSON.stringify(this.data));
            if(this.history.length > 50) this.history.shift();
            else this.historyStep++;
        } else if (this.history.length === 0) {
            this.history.push(JSON.stringify(this.data));
            this.historyStep = 0;
        }
        this.persist();
    }

    persist() {
        try {
            localStorage.setItem('tireData', JSON.stringify(this.data));
            this.updateDashboard();
            this.updateDataList();
        } catch (e) {
            this.showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!');
        }
    }

    undo() {
        if(this.historyStep > 0) {
            this.historyStep--;
            this.data = JSON.parse(this.history[this.historyStep]);
            this.renderAll();
            this.applySettings();
            this.persist();
            this.showToast('–û—Ç–º–µ–Ω–µ–Ω–æ');
        }
    }

    redo() {
        if(this.historyStep < this.history.length - 1) {
            this.historyStep++;
            this.data = JSON.parse(this.history[this.historyStep]);
            this.renderAll();
            this.applySettings();
            this.persist();
            this.showToast('–ü–æ–≤—Ç–æ—Ä–µ–Ω–æ');
        }
    }

    applySettings() {
        const s = this.data.settings;
        if(!s) return; 
        
        document.body.classList.toggle('light-theme', s.theme === 'light');
        document.body.classList.toggle('no-anim', !s.anim);
        document.body.classList.toggle('compact-mode', s.compact);
        document.body.classList.toggle('design-glass', s.design === 'glass');
        
        $('#themeToggle').classList.toggle('active', s.theme === 'dark');
        $('#confirmToggle').classList.toggle('active', s.confirm);
        $('#animToggle').classList.toggle('active', s.anim);
        $('#compactToggle').classList.toggle('active', s.compact);
        $('#currencyInput').value = s.currency || '‚ÇΩ';
        $('#scaleSelect').value = s.scale || '1';
        $('#currencyPosSelect').value = s.currencyPos || 'right';
        $('#designSelect').value = s.design || 'default';

        document.documentElement.style.setProperty('--primary', s.color);
        const r = parseInt(s.color.substr(1,2), 16), g = parseInt(s.color.substr(3,2), 16), b = parseInt(s.color.substr(5,2), 16);
        document.documentElement.style.setProperty('--primary-rgb', `${r}, ${g}, ${b}`);
        document.documentElement.style.setProperty('--font-scale', s.scale);

        $$('.color-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.color === s.color);
        });
    }

    formatMoney(amount) {
        const c = this.data.settings.currency || '';
        const p = this.data.settings.currencyPos || 'right';
        const val = parseFloat(amount).toLocaleString('ru-RU');
        return p === 'left' ? `${c} ${val}` : `${val} ${c}`;
    }

    renderAll() {
        this.renderTable('income', this.data.income);
        this.renderTable('expenses', this.data.expenses);
        this.renderClients();
        this.renderTable('warehouse', this.data.warehouse);
        this.renderDebts();
        this.renderTodos();
        this.renderTemplates();
        this.updateDashboard();
    }

    updateDashboard() {
        const today = new Date().toISOString().slice(0,10);
        
        const incToday = this.data.income.filter(i => i.date === today).reduce((a,b) => a + safeFloat(b.total), 0);
        const expToday = this.data.expenses.filter(e => e.date === today).reduce((a,b) => a + safeFloat(b.total), 0);
        const totalInc = this.data.income.reduce((a,b) => a + safeFloat(b.total), 0);
        const totalExp = this.data.expenses.reduce((a,b) => a + safeFloat(b.total), 0);
        const debts = this.data.debts.filter(d => !d.paid).reduce((a,b) => a + safeFloat(b.amount), 0);

        $('#totalProfit').textContent = this.formatMoney(totalInc - totalExp);
        $('#incomeToday').textContent = this.formatMoney(incToday);
        $('#expenseToday').textContent = this.formatMoney(expToday);
        $('#warehouseCount').textContent = this.data.warehouse.length;
        $('#clientsCount').textContent = this.data.clients.length;
        $('#debtsTotal').textContent = this.formatMoney(debts);
    }

    updateDataList() {
        const dl = $('#serviceList');
        dl.innerHTML = this.data.templates.map(t => `<option value="${t.name}">`).join('');
    }

    renderTable(type, dataArr) {
        if(type === 'clients' || type === 'debts') return; 
        const tbody = $(`#${type}Table tbody`);
        const searchInput = $(`#${type === 'income' ? 'income' : type === 'expenses' ? 'expense' : 'warehouse'}Search`);
        const term = searchInput ? searchInput.value.toLowerCase() : '';
        
        const html = dataArr.filter(item => Object.values(item).some(v => String(v).toLowerCase().includes(term))).map((item, i) => {
            
            if(type === 'warehouse') return `
                <tr data-id="${item.id}">
                    <td data-label="–ù–∞–∑–≤–∞–Ω–∏–µ"><input class="table-input" value="${item.name}" onchange="app.update('${type}', '${item.id}', 'name', this.value)" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"></td>
                    <td data-label="–û—Å—Ç–∞—Ç–æ–∫"><input type="number" class="table-input" value="${item.qty}" onchange="app.update('${type}', '${item.id}', 'qty', this.value)" placeholder="0"></td>
                    <td data-label="–î–µ–π—Å—Ç–≤–∏—è"><button class="btn-trash" onclick="app.del('${type}', '${item.id}')">${this.getTrashIcon()}</button></td>
                </tr>`;
            
            const isInc = type === 'income';
            return `
            <tr data-id="${item.id}">
                <td data-label="–î–∞—Ç–∞"><input type="date" class="table-input" value="${item.date}" onchange="app.update('${type}', '${item.id}', 'date', this.value)"></td>
                <td data-label="${isInc?'–£—Å–ª—É–≥–∞':'–û–ø–∏—Å–∞–Ω–∏–µ'}"><input type="text" list="${isInc?'serviceList':''}" class="table-input" value="${isInc?item.service:item.desc}" onchange="app.update('${type}', '${item.id}', '${isInc?'service':'desc'}', this.value)" placeholder="${isInc?'–£—Å–ª—É–≥–∞':'–û–ø–∏—Å–∞–Ω–∏–µ'}"></td>
                <td data-label="–¶–µ–Ω–∞"><input type="number" class="table-input" value="${item.price}" onchange="app.updateCalc('${type}', '${item.id}', 'price', this.value)" placeholder="0"></td>
                <td data-label="–ö–æ–ª-–≤–æ"><input type="number" class="table-input" value="${item.qty}" onchange="app.updateCalc('${type}', '${item.id}', 'qty', this.value)" placeholder="1"></td>
                <td data-label="–ò—Ç–æ–≥–æ"><input type="number" class="table-input" value="${item.total}" readonly style="opacity:0.8; font-weight:700; border:none; color:var(--primary);"></td>
                <td data-label="–î–µ–π—Å—Ç–≤–∏—è"><button class="btn-trash" onclick="app.del('${type}', '${item.id}')">${this.getTrashIcon()}</button></td>
            </tr>`;
        }).join('');
        
        if (tbody.innerHTML !== html) tbody.innerHTML = html;
    }

    renderClients() {
        const tbody = $('#clientsTable tbody');
        const term = $('#clientSearch').value.toLowerCase();
        const html = this.data.clients.filter(c => (c.name+c.phone+c.plate).toLowerCase().includes(term)).map((c, i) => `
            <tr data-id="${c.id}">
                <td data-label="–î–∞—Ç–∞"><input type="date" class="table-input" value="${c.date}" onchange="app.update('clients', '${c.id}', 'date', this.value)"></td>
                <td data-label="–ò–º—è"><input class="table-input" value="${c.name}" onchange="app.update('clients', '${c.id}', 'name', this.value)" placeholder="–ò–º—è"></td>
                <td data-label="–¢–µ–ª–µ—Ñ–æ–Ω"><input class="table-input" value="${c.phone}" onchange="app.update('clients', '${c.id}', 'phone', this.value)" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω"></td>
                <td data-label="–ê–≤—Ç–æ"><input class="table-input" value="${c.plate}" onchange="app.update('clients', '${c.id}', 'plate', this.value)" placeholder="–ù–æ–º–µ—Ä –∞–≤—Ç–æ"></td>
                <td data-label="–í–∏–∑–∏—Ç–æ–≤"><span class="badge" style="background:rgba(255,255,255,0.1);color:var(--text-main);width:auto;min-width:30px;">${c.visits || 1}</span></td>
                <td data-label="–î–µ–π—Å—Ç–≤–∏—è"><button class="btn-trash" onclick="app.del('clients', '${c.id}')">${this.getTrashIcon()}</button></td>
            </tr>
        `).join('');
        if (tbody.innerHTML !== html) tbody.innerHTML = html;
    }

    renderDebts() {
        const tbody = $('#debtsTable tbody');
        const term = $('#debtSearch').value.toLowerCase();
        const html = this.data.debts.filter(d => (d.name+d.phone).toLowerCase().includes(term)).map((d, i) => `
            <tr style="${d.paid ? 'opacity:0.6' : ''}" data-id="${d.id}">
                <td data-label="–î–∞—Ç–∞"><input type="date" class="table-input" value="${d.date}" onchange="app.update('debts', '${d.id}', 'date', this.value)"></td>
                <td data-label="–ò–º—è"><input class="table-input" value="${d.name}" onchange="app.update('debts', '${d.id}', 'name', this.value)" placeholder="–ò–º—è"></td>
                <td data-label="–¢–µ–ª–µ—Ñ–æ–Ω"><input class="table-input" value="${d.phone}" onchange="app.update('debts', '${d.id}', 'phone', this.value)" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω"></td>
                <td data-label="–°—É–º–º–∞"><input type="number" class="table-input" value="${d.amount}" onchange="app.update('debts', '${d.id}', 'amount', this.value)" placeholder="0"></td>
                <td data-label="–°—Ç–∞—Ç—É—Å"><button class="badge ${d.paid?'paid':'unpaid'}" style="border:none;cursor:pointer;width:100%" onclick="app.toggleDebt('${d.id}')">${d.paid?'–û–ø–ª–∞—á–µ–Ω':'–ù–µ –æ–ø–ª–∞—á–µ–Ω'}</button></td>
                <td data-label="–î–µ–π—Å—Ç–≤–∏—è"><button class="btn-trash" onclick="app.del('debts', '${d.id}')">${this.getTrashIcon()}</button></td>
            </tr>
        `).join('');
        if (tbody.innerHTML !== html) tbody.innerHTML = html;
    }

    renderTodos() {
        $('#todoList').innerHTML = this.data.todos.map((t, i) => `
            <div class="todo-item ${t.done ? 'completed' : ''}">
                <input type="checkbox" ${t.done ? 'checked' : ''} onchange="app.toggleTodo('${t.id}')" style="width:20px;height:20px;accent-color:var(--primary);cursor:pointer;">
                <span style="flex:1;word-break:break-word;font-weight:500;">${t.text}</span>
                <button class="btn-trash" onclick="app.delTodo('${t.id}')">${this.getTrashIcon()}</button>
            </div>
        `).join('');
    }

    renderTemplates() {
        $('#templateList').innerHTML = this.data.templates.map((t, idx) => `
            <div class="todo-item" style="justify-content:space-between; padding:10px 16px;">
                <div style="display:flex;flex-direction:column;">
                    <span style="font-weight:600">${t.name}</span>
                    <span style="font-size:0.85rem;color:var(--text-muted)">${this.formatMoney(t.price)}</span>
                </div>
                <button class="btn-trash" onclick="app.delTemplate(${idx})">${this.getTrashIcon()}</button>
            </div>
        `).join('');
    }

    addIncomeRow() { this.data.income.unshift({ id: uuid(), date: new Date().toISOString().slice(0,10), service: '', price: 0, qty: 1, total: 0 }); this.renderTable('income', this.data.income); this.saveState(); }
    addExpenseRow() { this.data.expenses.unshift({ id: uuid(), date: new Date().toISOString().slice(0,10), desc: '', price: 0, qty: 1, total: 0 }); this.renderTable('expenses', this.data.expenses); this.saveState(); }
    addClientRow() { this.data.clients.unshift({ id: uuid(), date: new Date().toISOString().slice(0,10), name: '', phone: '', plate: '', visits: 1 }); this.renderClients(); this.saveState(); }
    addWarehouseRow() { this.data.warehouse.unshift({ id: uuid(), name: '', qty: 0 }); this.renderTable('warehouse', this.data.warehouse); this.saveState(); }
    addDebtRow() { this.data.debts.unshift({ id: uuid(), date: new Date().toISOString().slice(0,10), name: '', phone: '', amount: 0, paid: false }); this.renderDebts(); this.saveState(); }
    addTodo() { const val = $('#newTodoInput').value.trim(); if(val) { this.data.todos.unshift({ id: uuid(), text: val, done: false }); $('#newTodoInput').value = ''; this.renderTodos(); this.saveState(); } }
    addTemplate() { const name = $('#tplName').value.trim(); const price = $('#tplPrice').value; if(name && price) { this.data.templates.push({ name, price }); $('#tplName').value = ''; $('#tplPrice').value = ''; this.renderTemplates(); this.saveState(); } }
    
    update(type, id, key, val) {
        const item = this.data[type].find(i => i.id === id);
        if(!item) return;
        item[key] = val;

        if(type === 'clients' && key === 'phone' && val.length > 3) {
            const exist = this.data.clients.find(c => c.phone === val && c.id !== id);
            if(exist) {
                exist.visits = (exist.visits || 1) + 1;
                exist.date = item.date; 
                this.data.clients = this.data.clients.filter(c => c.id !== id); 
                this.renderClients();
                this.saveState();
                this.showToast(`–ö–ª–∏–µ–Ω—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω: ${exist.name}`);
                return;
            }
        }

        if((key === 'service' || key === 'desc') && type !== 'warehouse') {
            const tpl = this.data.templates.find(t => t.name === val);
            if(tpl) { item.price = tpl.price; item.total = safeFloat(item.price) * safeFloat(item.qty); this.renderTable(type, this.data[type]); }
        }
        this.saveState();
    }
    
    updateCalc(type, id, key, val) {
        const item = this.data[type].find(i => i.id === id);
        if(item) { 
            item[key] = val; 
            item.total = Math.round((safeFloat(item.price) * safeFloat(item.qty)) * 100) / 100; 
            const row = $(`tr[data-id="${id}"]`);
            if(row) {
                const totalInput = row.querySelector('td[data-label="–ò—Ç–æ–≥–æ"] input');
                if(totalInput) totalInput.value = item.total;
            }
            this.updateDashboard(); 
            localStorage.setItem('tireData', JSON.stringify(this.data));
        }
    }

    del(type, id) {
        const doit = () => {
            this.data[type] = this.data[type].filter(i => i.id !== id);
            if (type==='income') this.renderTable('income', this.data.income);
            else if (type==='expenses') this.renderTable('expenses', this.data.expenses);
            else if (type==='warehouse') this.renderTable('warehouse', this.data.warehouse);
            else if (type==='clients') this.renderClients();
            else if (type==='debts') this.renderDebts();
            this.saveState();
            this.showToast('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞');
        };
        if(this.data.settings.confirm) this.confirmAction(doit); else doit();
    }

    delTodo(id) { this.data.todos = this.data.todos.filter(t => t.id !== id); this.renderTodos(); this.saveState(); }
    delTemplate(idx) { this.data.templates.splice(idx, 1); this.renderTemplates(); this.saveState(); }
    toggleDebt(id) { const d = this.data.debts.find(i => i.id === id); if(d) { d.paid = !d.paid; this.renderDebts(); this.saveState(); } }
    toggleTodo(id) { const t = this.data.todos.find(i => i.id === id); if(t) { t.done = !t.done; this.renderTodos(); this.saveState(); } }
    
    sort(type, key) { 
        this.data[type].sort((a,b) => {
            const valA = a[key] || ''; const valB = b[key] || '';
            const numA = parseFloat(valA), numB = parseFloat(valB);
            if(!isNaN(numA) && !isNaN(numB)) return (numA - numB) * this.currentSort.dir;
            return String(valA).localeCompare(String(valB)) * this.currentSort.dir;
        });
        this.currentSort.dir *= -1; 
        this.renderAll(); 
    }
    
    getTrashIcon() { return `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`; }

    confirmAction(callback) { $('#confirmModal').classList.add('visible'); $('#confirmBtnAction').onclick = () => { callback(); this.closeModal(); }; }
    closeModal() { $('#confirmModal').classList.remove('visible'); }
    showToast(msg) { 
        const t = document.createElement('div'); t.className = 'toast'; 
        t.innerHTML = `<span>‚úì</span> ${msg}`; 
        $('#toastArea').appendChild(t); 
        setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateX(100%)'; setTimeout(()=>t.remove(), 300); }, 2500); 
    }

    setupListeners() {
        $$('.nav-item').forEach(el => {
            el.onclick = (e) => {
                e.preventDefault();
                $$('.nav-item').forEach(n => n.classList.remove('active')); el.classList.add('active');
                $$('.tab-content').forEach(t => t.classList.remove('active')); $(`#${el.dataset.tab}`).classList.add('active');
                $('#page-title').textContent = el.querySelector('span').textContent;
                if(window.innerWidth <= 768) window.scrollTo({top: 0, behavior: 'smooth'});
            }
        });
        $('#calcBtn').onclick = () => $('#miniCalc').classList.toggle('visible');
        $('#closeCalc').onclick = () => $('#miniCalc').classList.remove('visible');
        
        $('#themeToggle').onclick = () => { this.data.settings.theme = this.data.settings.theme === 'dark' ? 'light' : 'dark'; this.applySettings(); this.saveState(); };
        $('#confirmToggle').onclick = () => { this.data.settings.confirm = !this.data.settings.confirm; this.applySettings(); this.saveState(); };
        $('#animToggle').onclick = () => { this.data.settings.anim = !this.data.settings.anim; this.applySettings(); this.saveState(); };
        $('#compactToggle').onclick = () => { this.data.settings.compact = !this.data.settings.compact; this.applySettings(); this.saveState(); };
        $('#currencyInput').onchange = (e) => { this.data.settings.currency = e.target.value; this.renderAll(); this.saveState(); };
        $('#scaleSelect').onchange = (e) => { this.data.settings.scale = e.target.value; this.applySettings(); this.saveState(); };
        $('#currencyPosSelect').onchange = (e) => { this.data.settings.currencyPos = e.target.value; this.renderAll(); this.saveState(); };
        $('#designSelect').onchange = (e) => { this.data.settings.design = e.target.value; this.applySettings(); this.saveState(); };

        $$('.color-btn').forEach(btn => {
            btn.onclick = () => {
                this.data.settings.color = btn.dataset.color;
                this.applySettings();
                this.saveState();
            }
        });

        $('#undoBtn').onclick = () => this.undo();
        $('#redoBtn').onclick = () => this.redo();
        
        const debouncedRender = (type) => {
            clearTimeout(this.debounceTimer);
            this.debounceTimer = setTimeout(() => {
                if(type === 'income') this.renderTable('income', this.data.income);
                else if(type === 'expenses') this.renderTable('expenses', this.data.expenses);
                else if(type === 'clients') this.renderClients();
                else if(type === 'warehouse') this.renderTable('warehouse', this.data.warehouse);
                else if(type === 'debts') this.renderDebts();
            }, 300);
        };

        ['incomeSearch', 'expenseSearch', 'clientSearch', 'warehouseSearch', 'debtSearch'].forEach(id => { 
            $('#'+id).addEventListener('input', (e) => {
                const type = id.replace('Search', '');
                debouncedRender(type === 'expense' ? 'expenses' : type);
            }); 
        });

        $('#globalSearch').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            const res = $('#globalSearchResults');
            if(!val) { res.innerHTML = ''; return; }
            const clients = this.data.clients.filter(c => c.phone.includes(val) || c.plate.toLowerCase().includes(val));
            res.innerHTML = clients.map(c => `
                <div class="todo-item" onclick="$('#clientSearch').value='${c.phone}'; app.renderClients(); $('.nav-item[data-tab=clients]').click();" style="cursor:pointer">
                    <div style="display:flex;flex-direction:column;">
                        <span style="font-weight:bold;color:var(--primary)">${c.name}</span>
                        <span style="font-size:0.8rem;color:var(--text-muted)">${c.phone} ‚Ä¢ ${c.plate}</span>
                    </div>
                </div>`).join('');
        });
        $('#clearBtn').onclick = () => this.confirmAction(() => { localStorage.removeItem('tireData'); location.reload(); });
        $('#exportBtn').onclick = () => { const blob = new Blob([JSON.stringify(this.data)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); }
        $('#importBtn').onclick = () => $('#importFile').click();
        $('#importFile').onchange = (e) => { const fr = new FileReader(); fr.onload = (ev) => { try { this.data = JSON.parse(ev.target.result); this.saveState(); this.renderAll(); this.showToast('–ë–∞–∑–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'); } catch(e) { alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞'); } }; fr.readAsText(e.target.files[0]); };
    }

    setupDraggable() {
        const elm = $('#miniCalc'), header = $('#calcHeader');
        let pos1=0, pos2=0, pos3=0, pos4=0;
        const start = (e) => { if(e.target.id === 'closeCalc') return; e = e.type==='touchstart'?e.touches[0]:e; pos3 = e.clientX; pos4 = e.clientY; document.onmouseup = close; document.onmousemove = move; document.ontouchend = close; document.ontouchmove = move; };
        const move = (e) => { e = e.type==='touchmove'?e.touches[0]:e; pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; elm.style.top = (elm.offsetTop - pos2) + "px"; elm.style.left = (elm.offsetLeft - pos1) + "px"; };
        const close = () => { document.onmouseup = null; document.onmousemove = null; document.ontouchend = null; document.ontouchmove = null; };
        header.onmousedown = start; header.ontouchstart = start;
    }
}

const app = new App();
</script>
</body>
</html>
